<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <title>Sistema de Emissão e Gestão de RID's</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDAcuwo5FZBs5013klfSMfWkQZbFjqYpbw",
      authDomain: "novo-rid-dezembro.firebaseapp.com",
      projectId: "novo-rid-dezembro",
      storageBucket: "novo-rid-dezembro.firebasestorage.app",
      messagingSenderId: "629184938088",
      appId: "1:629184938088:web:3821e7ea07897ae655fbdd"
    };

    const app = initializeApp(firebaseConfig);
    window.firebaseAuth = getAuth(app);
    window.firebaseDb = getFirestore(app);
    window.firebaseModules = {
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      collection,
      addDoc,
      getDocs,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
      orderBy,
      onSnapshot,
      serverTimestamp
    };
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    html {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    * {
      scrollbar-width: none;
    }
    *::-webkit-scrollbar {
      display: none;
    }
    :focus-visible {
      outline: 2px solid #ffd57a;
      outline-offset: 2px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="w-full h-full bg-[#ece5df]">
  <main id="app-root" class="w-full h-full flex flex-col bg-[#ece5df] text-[#2c2c2c] font-sans">
   <section id="view-container" class="w-full flex-1 flex items-stretch justify-center overflow-hidden"><!-- LOGIN VIEW -->
    <div id="view-login" class="w-full h-full flex items-center justify-center px-4 py-6 overflow-auto">
     <div class="w-full max-w-md">
      <div class="rounded-2xl bg-white border border-[#b0b0b0] shadow-xl px-6 py-8 space-y-6">
       <div class="text-center space-y-4">
        <div class="w-32 h-32 mx-auto p-2"><img src="https://tse2.mm.bing.net/th/id/OIP.Zc8DnBp2H5qz6GAUyEKFdAHaFP?rs=1&amp;pid=ImgDetMain" alt="Logo J. DEMITO" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'w-full h-full flex items-center justify-center\'><span class=\'text-4xl font-bold text-[#2c2c2c]\'>JD</span></div>';">
        </div>
        <div class="space-y-2">
         <h1 class="text-2xl font-bold text-[#2c2c2c]">Sistema de Gestão e Emissão de RID's</h1>
         <p class="text-sm text-[#5a5a5a]">Faça login com seu CPF</p>
        </div>
       </div>
       <form id="login-form" class="space-y-4">
        <div class="space-y-1.5"><label for="cpf-login" class="block text-sm font-medium text-[#2c2c2c]"> CPF </label> <input id="cpf-login" type="text" maxlength="14" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm text-[#2c2c2c] placeholder-[#5a5a5a] focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40 transition-colors" placeholder="000.000.000-00" required>
        </div>
        <div class="space-y-1.5"><label for="senha-login" class="block text-sm font-medium text-[#2c2c2c]"> Senha </label> <input id="senha-login" type="password" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm text-[#2c2c2c] placeholder-[#5a5a5a] focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40 transition-colors" placeholder="Digite sua senha" required>
        </div>
        <div id="login-message" class="text-xs min-h-[1.25rem] text-center"></div>
        <div class="space-y-3 pt-1"><button id="btn-entrar" type="submit" class="w-full px-6 py-3 rounded-xl text-sm font-semibold text-[#2c2c2c] bg-[#ffd57a] hover:bg-[#ffeab8] transition-colors shadow-md disabled:opacity-70 disabled:cursor-not-allowed"> Entrar </button> <button id="btn-cadastrar" type="button" class="w-full px-6 py-3 rounded-xl text-sm font-semibold text-[#2c2c2c] border border-[#b0b0b0] bg-transparent hover:bg-[#d6d6d4] transition-colors"> Criar Nova Conta </button>
        </div>
       </form>
      </div>
     </div>
    </div><!-- ADMIN VIEW -->
    <div id="view-admin" class="hidden w-full h-full">
     <div class="w-full h-full flex flex-col">
      <header class="flex-shrink-0 bg-[#e8e7e6] border-b border-[#b0b0b0]">
       <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
         <div class="w-16 h-16"><img src="https://tse2.mm.bing.net/th/id/OIP.Zc8DnBp2H5qz6GAUyEKFdAHaFP?rs=1&amp;pid=ImgDetMain" alt="Logo" class="w-full h-full object-contain" onerror="this.style.display='none';">
         </div>
         <div>
          <h1 class="text-lg font-bold text-[#2c2c2c]">Painel Administrativo</h1>
          <p class="text-xs text-[#5a5a5a]">Gestão de RID's</p>
         </div>
        </div>
        <div class="flex items-center gap-2">
         <div class="relative"><button id="btn-notificacoes-admin" class="w-10 h-10 flex items-center justify-center hover:bg-[#d6d6d4] rounded-lg transition-colors relative">
           <svg class="w-6 h-6 text-[#2c2c2c]" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
           </svg><span id="badge-notificacoes-admin" class="hidden absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span> </button>
         </div>
         <div class="relative"><button id="btn-menu-admin" class="w-10 h-10 flex flex-col items-center justify-center gap-1.5 hover:bg-[#d6d6d4] rounded-lg transition-colors"> <span class="w-6 h-0.5 bg-[#2c2c2c] rounded-full"></span> <span class="w-6 h-0.5 bg-[#2c2c2c] rounded-full"></span> <span class="w-6 h-0.5 bg-[#2c2c2c] rounded-full"></span> </button>
          <div id="dropdown-menu-admin" class="hidden absolute right-0 top-12 bg-white border border-[#b0b0b0] rounded-xl shadow-xl min-w-[160px] overflow-hidden z-50"><button id="btn-logout-admin" class="w-full px-4 py-3 text-left text-sm font-semibold text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
            </svg> Sair </button>
          </div>
         </div>
        </div>
       </div>
       <nav class="border-t border-[#b0b0b0] bg-[#e8e7e6]">
        <div class="max-w-6xl mx-auto px-4">
         <ul class="flex items-center gap-2 text-sm py-2">
          <li><button id="btn-nav-dashboard" type="button" class="px-4 py-2 rounded-full bg-[#ffd57a] text-[#2c2c2c] font-semibold"> Dashboard </button></li>
          <li><button id="btn-nav-rids" type="button" class="px-4 py-2 rounded-full text-[#2c2c2c] hover:bg-[#ece5df] transition-colors"> RIDs </button></li>
          <li><button id="btn-nav-funcionarios" type="button" class="px-4 py-2 rounded-full text-[#2c2c2c] hover:bg-[#ece5df] transition-colors"> Funcionários </button></li>
          <li><button id="btn-nav-solicitacoes" type="button" class="px-4 py-2 rounded-full text-[#2c2c2c] hover:bg-[#ece5df] transition-colors relative"> Solicitações <span id="badge-solicitacoes" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span> </button></li>
          <li><button id="btn-nav-relatorios" type="button" class="px-4 py-2 rounded-full text-[#2c2c2c] hover:bg-[#ece5df] transition-colors"> Relatórios </button></li>
         </ul>
        </div>
       </nav>
      </header>
      <div class="flex-1 overflow-auto"><!-- Dashboard Section -->
       <div id="admin-section-dashboard" class="p-6">
        <div class="max-w-6xl mx-auto space-y-6">
         <h2 class="text-2xl font-bold text-[#2c2c2c]">Visão Geral</h2>
         <div class="grid grid-cols-4 gap-3">
          <div class="bg-white rounded-xl border border-[#b0b0b0] p-6 shadow-sm">
           <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
             <svg class="w-10 h-10 text-[#ffd57a]" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
             </svg>
             <p class="text-sm font-medium text-[#5a5a5a]">Total de RIDs</p>
            </div>
            <p id="total-rids" class="text-3xl font-bold text-[#2c2c2c]">0</p>
           </div>
          </div>
          <div class="bg-white rounded-xl border border-[#b0b0b0] p-6 shadow-sm">
           <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
             <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
             </svg>
             <p class="text-sm font-medium text-[#5a5a5a]">Em Andamento</p>
            </div>
            <p id="rids-andamento" class="text-3xl font-bold text-[#2c2c2c]">0</p>
           </div>
          </div>
          <div class="bg-white rounded-xl border border-[#b0b0b0] p-6 shadow-sm">
           <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
             <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
             </svg>
             <p class="text-sm font-medium text-[#5a5a5a]">Vencidos</p>
            </div>
            <p id="rids-vencidos" class="text-3xl font-bold text-[#2c2c2c]">0</p>
           </div>
          </div>
          <div class="bg-white rounded-xl border border-[#b0b0b0] p-6 shadow-sm">
           <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
             <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
             </svg>
             <p class="text-sm font-medium text-[#5a5a5a]">Corrigidos</p>
            </div>
            <p id="rids-corrigidos" class="text-3xl font-bold text-[#2c2c2c]">0</p>
           </div>
          </div>
         </div>
         <div class="space-y-3">
          <h2 class="text-2xl font-bold text-[#2c2c2c]">RIDs Recentes</h2>
          <div class="bg-white rounded-xl border border-[#b0b0b0] shadow-sm">
           <div id="rids-recentes-container" class="max-h-[400px] overflow-y-auto p-4 space-y-3">
            <div class="text-center py-8 text-[#5a5a5a]">
             Carregando RIDs recentes...
            </div>
           </div>
          </div>
         </div>
         <div class="space-y-3">
          <h2 class="text-2xl font-bold text-[#2c2c2c]">Ranking de Emissões por Setor</h2>
          <div class="bg-white rounded-xl border border-[#b0b0b0] shadow-sm p-6">
           <div id="ranking-container" class="space-y-4">
            <div class="text-center py-8 text-[#5a5a5a]">
             Carregando ranking...
            </div>
           </div>
          </div>
         </div>
        </div>
       </div><!-- RIDs Section -->
       <div id="admin-section-rids" class="hidden p-6">
        <div class="max-w-6xl mx-auto space-y-6">
         <div class="flex items-center justify-between">
          <div>
           <h2 class="text-2xl font-bold mb-2">Gerenciar RIDs</h2>
           <p class="text-[#5a5a5a]">Lista de todos os RIDs cadastrados</p>
          </div><button id="btn-criar-rid" class="px-4 py-2 rounded-lg bg-[#ffd57a] hover:bg-[#ffeab8] text-[#2c2c2c] text-sm font-semibold shadow-md transition-colors flex items-center gap-2">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
           </svg> Criar Novo RID </button>
         </div>
         <div class="bg-white rounded-xl border border-[#b0b0b0] overflow-hidden">
          <div class="overflow-x-auto">
           <table class="w-full">
            <thead class="bg-[#e8e7e6] border-b border-[#b0b0b0]">
             <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Número</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Emitente</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Setor</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Data</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Status</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Classificação de Risco</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-[#2c2c2c]">Ações</th>
             </tr>
            </thead>
            <tbody id="rids-table-body" class="divide-y divide-[#b0b0b0]">
             <tr>
              <td colspan="7" class="px-4 py-8 text-center text-[#5a5a5a]">Carregando RIDs...</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div>
        </div>
       </div><!-- Funcionários Section -->
       <div id="admin-section-funcionarios" class="hidden p-6">
        <div class="max-w-6xl mx-auto space-y-6">
         <div class="flex items-center justify-between">
          <div>
           <h2 class="text-2xl font-bold mb-2">Funcionários</h2>
           <p class="text-[#5a5a5a]">Gerenciar funcionários do sistema</p>
          </div><button id="btn-cadastrar-funcionario" class="px-4 py-2 rounded-lg bg-[#ffd57a] hover:bg-[#ffeab8] text-[#2c2c2c] text-sm font-semibold shadow-md transition-colors flex items-center gap-2">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
           </svg> Cadastrar Funcionário </button>
         </div>
         <div class="bg-white rounded-xl border border-[#b0b0b0] overflow-hidden">
          <div class="overflow-x-auto">
           <table class="w-full">
            <thead class="bg-[#e8e7e6] border-b border-[#b0b0b0]">
             <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Nome</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">CPF</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Setor</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Data de Cadastro</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Tipo</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-[#2c2c2c]">Ações</th>
             </tr>
            </thead>
            <tbody id="funcionarios-table-body" class="divide-y divide-[#b0b0b0]">
             <tr>
              <td colspan="6" class="px-4 py-8 text-center text-[#5a5a5a]">Carregando funcionários...</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div>
        </div>
       </div><!-- Solicitações Section -->
       <div id="admin-section-solicitacoes" class="hidden p-6">
        <div class="max-w-6xl mx-auto space-y-6">
         <div>
          <h2 class="text-2xl font-bold mb-2">Solicitações de Exclusão</h2>
          <p class="text-[#5a5a5a]">Aprovar ou rejeitar solicitações de exclusão</p>
         </div>
         <div id="solicitacoes-container" class="space-y-4">
          <div class="text-center py-8 text-[#5a5a5a]">
           Carregando solicitações...
          </div>
         </div>
        </div>
       </div><!-- Relatórios Section -->
       <div id="admin-section-relatorios" class="hidden p-6">
        <div class="max-w-full mx-auto space-y-6">
         <div class="flex items-center justify-between">
          <div>
           <h2 class="text-2xl font-bold mb-2">Relatórios</h2>
           <p class="text-[#5a5a5a]">Gerar e visualizar relatórios do sistema</p>
          </div>
          <div class="flex items-center gap-3"><button id="btn-imprimir" type="button" class="px-4 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors flex items-center gap-2 shadow-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0021 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 00-1.913-.247M6.34 18H5.25A2.25 2.25 0 013 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 011.913-.247m10.5 0a48.536 48.536 0 00-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5zm-3 0h.008v.008H15V10.5z" />
            </svg> Imprimir </button> <button id="btn-exportar" type="button" class="px-4 py-2 rounded-lg bg-[#ffd57a] text-[#2c2c2c] font-semibold hover:bg-[#ffeab8] transition-colors flex items-center gap-2 shadow-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg> Exportar </button>
          </div>
         </div>
         <div class="bg-white rounded-xl border border-[#b0b0b0] overflow-hidden">
          <div class="overflow-x-auto">
           <table class="w-full">
            <thead class="bg-[#e8e7e6] border-b border-[#b0b0b0]">
             <tr>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Unidade</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">RID Nº</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Data Emissão</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Emitente</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Funcionário/Terceiro/Visitante</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Setor/Empresa</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Local do Incidente</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Gênese do Incidente</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Origem da Detecção</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Descrição</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Classificação de Risco</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Ação Imediata</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Aç   es Corretivas</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Responsável pelas Ações</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Prazo para Conclusão</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Data de Conclusão</th>
              <th class="px-3 py-3 text-left text-xs font-semibold text-[#2c2c2c] whitespace-nowrap">Status</th>
             </tr>
            </thead>
            <tbody id="relatorios-table-body" class="divide-y divide-[#b0b0b0]">
             <tr>
              <td colspan="17" class="px-4 py-8 text-center text-[#5a5a5a]">Carregando relatórios...</td>
             </tr>
            </tbody>
           </table>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- FUNCIONÁRIO VIEW -->
    <div id="view-func" class="hidden w-full h-full">
     <div class="w-full h-full flex flex-col">
      <header class="flex-shrink-0 bg-[#e8e7e6] border-b border-[#b0b0b0]">
       <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
         <div class="w-16 h-16"><img src="https://tse2.mm.bing.net/th/id/OIP.Zc8DnBp2H5qz6GAUyEKFdAHaFP?rs=1&amp;pid=ImgDetMain" alt="Logo" class="w-full h-full object-contain" onerror="this.style.display='none';">
         </div>
         <div>
          <h1 class="text-lg font-bold text-[#2c2c2c]">Painel do Funcionário</h1>
          <p class="text-xs text-[#5a5a5a]">Sistema de RID's</p>
         </div>
        </div>
        <div class="flex items-center gap-2">
         <div class="relative"><button id="btn-notificacoes-func" class="w-10 h-10 flex items-center justify-center hover:bg-[#d6d6d4] rounded-lg transition-colors relative">
           <svg class="w-6 h-6 text-[#2c2c2c]" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
           </svg><span id="badge-notificacoes-func" class="hidden absolute top-1 right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span> </button>
         </div>
         <div class="relative"><button id="btn-menu-func" class="w-10 h-10 flex flex-col items-center justify-center gap-1.5 hover:bg-[#d6d6d4] rounded-lg transition-colors"> <span class="w-6 h-0.5 bg-[#2c2c2c] rounded-full"></span> <span class="w-6 h-0.5 bg-[#2c2c2c] rounded-full"></span> <span class="w-6 h-0.5 bg-[#2c2c2c] rounded-full"></span> </button>
          <div id="dropdown-menu-func" class="hidden absolute right-0 top-12 bg-white border border-[#b0b0b0] rounded-xl shadow-xl min-w-[160px] overflow-hidden z-50"><button id="btn-logout-func" class="w-full px-4 py-3 text-left text-sm font-semibold text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
            </svg> Sair </button>
          </div>
         </div>
        </div>
       </div>
      </header>
      <div class="flex-1 overflow-auto p-6">
       <div class="max-w-6xl mx-auto">
        <h2 class="text-2xl font-bold mb-4">Bem-vindo, Funcionário!</h2>
        <p class="text-[#5a5a5a]">Você está no painel de funcionário.</p>
       </div>
      </div>
     </div>
    </div>
   </section><!-- Modal Criar RID -->
   <div id="modal-criar-rid" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-3xl w-full max-h-[90%] overflow-auto">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between sticky top-0 bg-white z-10">
      <h3 class="text-lg font-semibold text-[#2c2c2c]">Criar Novo RID</h3><button id="btn-fechar-modal-rid" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <form id="form-criar-rid" class="px-6 py-6 space-y-5">
      <div><label for="rid-emitente" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">1. Emitente</label> <input id="rid-emitente" type="text" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" placeholder="Insira o nome do emitente" required>
      </div>
      <div><label for="rid-tipo-contrato" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">2. Tipo de contrato</label> <select id="rid-tipo-contrato" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required> <option value="">Selecione</option> <option value="Funcionário">Funcionário</option> <option value="Terceiro Contratado">Terceiro Contratado</option> <option value="Terceiro Eventual">Terceiro Eventual</option> <option value="Visitante">Visitante</option> </select>
      </div>
      <div><label for="rid-unidade" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">3. Unidade</label> <input id="rid-unidade" type="text" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40 uppercase" placeholder="Insira a unidade" required>
      </div>
      <div><label for="rid-setor" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">4. Setor do emitente</label> <select id="rid-setor" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required> <option value="">Selecione</option> <option value="ADM">ADM</option> <option value="M. MOVEL">M. MOVEL</option> <option value="M. FIXA">M. FIXA</option> <option value="M. ELÉTRICA">M. ELÉTRICA</option> <option value="PRODUÇÃO">PRODUÇÃO</option> <option value="MINA">MINA</option> </select>
      </div>
      <div><label for="rid-data" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">5. Data</label> <input id="rid-data" type="date" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required>
      </div>
      <div><label for="rid-incidente" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">6. Incidente ou Desvios</label> <select id="rid-incidente" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required> <option value="">Selecione</option> <option value="Condição de Risco">Condição de Risco</option> <option value="Desvio Comportamental">Desvio Comportamental</option> <option value="Dano Material">Dano Material</option> <option value="Quase acidente">Quase acidente</option> </select>
      </div>
      <div><label for="rid-origem" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">7. Origem da detecção</label> <select id="rid-origem" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required> <option value="">Selecione</option> <option value="CSL">CSL</option> <option value="Inspeção programada">Inspeção programada</option> <option value="Inspeção não programada">Inspeção não programada</option> <option value="Observação Comportamental">Observação Comportamental</option> <option value="Constatação espont  nea">Constatação espontânea</option> <option value="Auditoria">Auditoria</option> </select>
      </div>
      <div><label for="rid-local" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">8. Local da ocorrência</label> <input id="rid-local" type="text" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" placeholder="Insira o local da ocorrência" required>
      </div>
      <div><label for="rid-descricao" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">9. Descrição da Ocorrência</label> <textarea id="rid-descricao" rows="4" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40 resize-none" placeholder="Descreva detalhadamente a ocorrência" required></textarea>
      </div>
      <div><label for="rid-acao-imediata" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">10. Ação Imediata</label> <textarea id="rid-acao-imediata" rows="3" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40 resize-none" placeholder="Descreva a ação imediata tomada" required></textarea>
      </div>
      <div><label for="rid-classificacao" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">11. Classificação de risco</label> <select id="rid-classificacao" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required> <option value="">Selecione</option> <option value="Baixo">Baixo - Risco mínimo, sem impacto significativo</option> <option value="Médio">Médio - Risco moderado, requer atenção</option> <option value="Alto">Alto - Risco elevado, ação urgente necessária</option> <option value="Crítico">Crítico - Risco extremo, ação imediata obrigatória</option> </select>
      </div>
      <div><label for="rid-status" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">12. Status</label> <select id="rid-status" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required> <option value="">Selecione</option> <option value="Em Andamento">EM ANDAMENTO - O problema está sendo tratado</option> <option value="Corrigido">CORRIGIDO - O problema foi resolvido completamente</option> <option value="Vencido">VENCIDO - O prazo de correção foi ultrapassado</option> </select>
      </div>
      <div><label for="rid-lider" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">13. Designar ao Líder</label> <select id="rid-lider" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40"> <option value="">Selecione um líder (opcional)</option> </select>
       <p class="text-xs text-[#5a5a5a] mt-1">Você pode designar um líder agora ou depois</p>
      </div>
      <div id="rid-message" class="text-xs min-h-[1.25rem] text-center"></div>
      <div class="flex gap-3 pt-2 sticky bottom-0 bg-white pb-2"><button type="button" id="btn-cancelar-rid" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors"> Cancelar </button> <button type="submit" id="btn-confirmar-rid" class="flex-1 px-4 py-2.5 rounded-xl bg-[#ffd57a] hover:bg-[#ffeab8] text-[#2c2c2c] font-semibold transition-colors disabled:opacity-70"> Criar RID </button>
      </div>
     </form>
    </div>
   </div><!-- Modal Cadastro -->
   <div id="modal-cadastro" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full max-h-[90%] overflow-auto">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between">
      <h3 class="text-lg font-semibold">Criar Nova Conta</h3><button id="btn-fechar-modal-cadastro" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <form id="form-cadastro" class="px-6 py-6 space-y-4">
      <div><label for="cadastro-nome" class="block text-sm font-medium mb-1.5">Nome Completo</label> <input id="cadastro-nome" type="text" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" required>
      </div>
      <div><label for="cadastro-cpf" class="block text-sm font-medium mb-1.5">CPF</label> <input id="cadastro-cpf" type="text" maxlength="14" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" placeholder="000.000.000-00" required>
      </div>
      <div><label for="cadastro-setor" class="block text-sm font-medium mb-1.5">Setor</label> <select id="cadastro-setor" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" required> <option value="">Selecione</option> <option value="ADM">ADM</option> <option value="M. MOVEL">M. MOVEL</option> <option value="M. FIXA">M. FIXA</option> <option value="M. ELÉTRICA">M. ELÉTRICA</option> <option value="PRODUÇÃO">PRODUÇÃO</option> <option value="MINA">MINA</option> </select>
      </div>
      <div><label for="cadastro-senha" class="block text-sm font-medium mb-1.5">Senha</label> <input id="cadastro-senha" type="password" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" placeholder="Digite sua senha" required>
       <p class="text-xs text-[#5a5a5a] mt-1">Mínimo de 6 caracteres</p>
      </div>
      <div><label for="cadastro-confirmar-senha" class="block text-sm font-medium mb-1.5">Confirmar Senha</label> <input id="cadastro-confirmar-senha" type="password" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" placeholder="Confirme sua senha" required>
      </div>
      <div id="cadastro-message" class="text-xs min-h-[1.25rem]"></div>
      <div class="flex gap-3"><button type="button" id="btn-cancelar-cadastro" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4]">Cancelar</button> <button type="submit" id="btn-confirmar-cadastro" class="flex-1 px-4 py-2.5 rounded-xl bg-[#ffd57a] hover:bg-[#ffeab8] font-semibold disabled:opacity-70"> Criar Conta </button>
      </div>
     </form>
    </div>
   </div><!-- Modal Cadastro Funcionário (Admin) -->
   <div id="modal-cadastro-funcionario" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full max-h-[90%] overflow-auto">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between">
      <h3 class="text-lg font-semibold">Cadastrar Funcionário</h3><button id="btn-fechar-modal-cadastro-func" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <form id="form-cadastro-funcionario" class="px-6 py-6 space-y-4">
      <div><label for="cadastro-func-nome" class="block text-sm font-medium mb-1.5">Nome Completo</label> <input id="cadastro-func-nome" type="text" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" required>
      </div>
      <div><label for="cadastro-func-cpf" class="block text-sm font-medium mb-1.5">CPF</label> <input id="cadastro-func-cpf" type="text" maxlength="14" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" placeholder="000.000.000-00" required>
      </div>
      <div><label for="cadastro-func-setor" class="block text-sm font-medium mb-1.5">Setor</label> <select id="cadastro-func-setor" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" required> <option value="">Selecione</option> <option value="ADM">ADM</option> <option value="M. MOVEL">M. MOVEL</option> <option value="M. FIXA">M. FIXA</option> <option value="M. ELÉTRICA">M. ELÉTRICA</option> <option value="PRODUÇÃO">PRODUÇÃO</option> <option value="MINA">MINA</option> </select>
      </div>
      <div><label for="cadastro-func-matricula" class="block text-sm font-medium mb-1.5">Número da Matrícula</label> <input id="cadastro-func-matricula" type="text" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df]" placeholder="Digite o número da matrícula" required>
       <p class="text-xs text-[#5a5a5a] mt-1">Este número será usado como senha de acesso</p>
      </div>
      <div id="cadastro-func-message" class="text-xs min-h-[1.25rem]"></div>
      <div class="flex gap-3"><button type="button" id="btn-cancelar-cadastro-func" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4]">Cancelar</button> <button type="submit" id="btn-confirmar-cadastro-func" class="flex-1 px-4 py-2.5 rounded-xl bg-[#ffd57a] hover:bg-[#ffeab8] font-semibold disabled:opacity-70"> Cadastrar </button>
      </div>
     </form>
    </div>
   </div><!-- Modal Ver RID -->
   <div id="modal-ver-rid" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-3xl w-full max-h-[90%] overflow-auto">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between sticky top-0 bg-white z-10">
      <h3 class="text-lg font-semibold text-[#2c2c2c]">Detalhes do RID</h3><button id="btn-fechar-modal-ver-rid" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <div id="conteudo-modal-ver-rid" class="px-6 py-6 space-y-4"><!-- Conteúdo será preenchido dinamicamente -->
     </div>
    </div>
   </div><!-- Modal Solicitar Exclusão RID -->
   <div id="modal-solicitar-exclusao-rid" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between">
      <h3 class="text-lg font-semibold text-[#2c2c2c]">Solicitar Exclusão de RID</h3><button id="btn-fechar-modal-exclusao-rid" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <div class="px-6 py-6 space-y-4">
      <div class="bg-yellow-50 border border-yellow-300 rounded-xl p-4 flex items-start gap-3">
       <svg class="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
       </svg>
       <div>
        <p class="text-sm font-semibold text-yellow-800 mb-1">Atenção</p>
        <p class="text-xs text-yellow-700">Você está solicitando a exclusão do RID <span id="rid-numero-exclusao" class="font-bold"></span>. Um administrador mestre precisará aprovar esta solicitação.</p>
       </div>
      </div>
      <div><label for="motivo-exclusao-rid" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">Motivo da Exclusão</label> <textarea id="motivo-exclusao-rid" rows="4" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40 resize-none" placeholder="Descreva o motivo da solicitação de exclusão..." required></textarea>
      </div>
      <div id="exclusao-rid-message" class="text-xs min-h-[1.25rem] text-center"></div>
      <div class="flex gap-3"><button type="button" id="btn-cancelar-exclusao-rid" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors"> Cancelar </button> <button type="button" id="btn-confirmar-exclusao-rid" class="flex-1 px-4 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-semibold transition-colors disabled:opacity-70"> Enviar Solicitação </button>
      </div>
     </div>
    </div>
   </div><!-- Modal Detalhes Relatório -->
   <div id="modal-detalhes-relatorio" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-4xl w-full max-h-[90%] overflow-auto">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between sticky top-0 bg-white z-10">
      <h3 class="text-lg font-semibold text-[#2c2c2c]">Detalhes do RID - Relatório Completo</h3><button id="btn-fechar-modal-relatorio" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <div id="conteudo-modal-relatorio" class="px-6 py-6 space-y-4"><!-- Conteúdo será preenchido dinamicamente -->
     </div>
    </div>
   </div><!-- Modal Designar RID -->
   <div id="modal-designar-rid" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between">
      <h3 class="text-lg font-semibold text-[#2c2c2c]">Designar RID a um Líder</h3><button id="btn-fechar-modal-designar" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <div class="px-6 py-6 space-y-4">
      <div class="bg-blue-50 border border-blue-300 rounded-xl p-4 flex items-start gap-3">
       <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
       </svg>
       <div>
        <p class="text-sm font-semibold text-blue-800 mb-1">Designação de Responsável</p>
        <p class="text-xs text-blue-700">Selecione um líder para ser responsável por este RID. O líder receberá uma notificação sobre a designação.</p>
       </div>
      </div>
      <div><label for="designar-lider-select" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">Selecionar Líder</label> <select id="designar-lider-select" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" required> <option value="">Selecione um líder</option> </select>
      </div>
      <div id="designar-rid-message" class="text-xs min-h-[1.25rem] text-center"></div>
      <div class="flex gap-3"><button type="button" id="btn-cancelar-designar" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors"> Cancelar </button> <button type="button" id="btn-confirmar-designar" class="flex-1 px-4 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-semibold transition-colors disabled:opacity-70"> Designar </button>
      </div>
     </div>
    </div>
   </div><!-- Modal Solicitar Exclusão Funcionário -->
   <div id="modal-solicitar-exclusao-func" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full">
     <div class="px-6 py-4 border-b border-[#b0b0b0] flex items-center justify-between">
      <h3 class="text-lg font-semibold text-[#2c2c2c]">Solicitar Exclusão de Funcionário</h3><button id="btn-fechar-modal-exclusao-func" class="w-8 h-8 rounded-full hover:bg-[#ece5df] flex items-center justify-center text-2xl">×</button>
     </div>
     <div class="px-6 py-6 space-y-4">
      <div class="bg-yellow-50 border border-yellow-300 rounded-xl p-4 flex items-start gap-3">
       <svg class="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
       </svg>
       <div>
        <p class="text-sm font-semibold text-yellow-800 mb-1">Atenção</p>
        <p class="text-xs text-yellow-700">Você está solicitando a exclusão do funcionário <span id="func-nome-exclusao" class="font-bold"></span>. Um administrador mestre precisará aprovar esta solicitação.</p>
       </div>
      </div>
      <div><label for="motivo-exclusao-func" class="block text-sm font-medium text-[#2c2c2c] mb-1.5">Motivo da Exclusão</label> <textarea id="motivo-exclusao-func" rows="4" class="block w-full px-3 py-2.5 rounded-xl border border-[#b0b0b0] bg-[#ece5df] text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40 resize-none" placeholder="Descreva o motivo da solicitação de exclusão..." required></textarea>
      </div>
      <div id="exclusao-func-message" class="text-xs min-h-[1.25rem] text-center"></div>
      <div class="flex gap-3"><button type="button" id="btn-cancelar-exclusao-func" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors"> Cancelar </button> <button type="button" id="btn-confirmar-exclusao-func" class="flex-1 px-4 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-semibold transition-colors disabled:opacity-70"> Enviar Solicitação </button>
      </div>
     </div>
    </div>
   </div>
  </main>
  <script type="module">
  async function waitForFirebase() {
    if (window.firebaseReady) return;
    return new Promise(resolve => {
      window.addEventListener('firebaseReady', resolve, { once: true });
    });
  }

  await waitForFirebase();

  const auth = window.firebaseAuth;
  const db = window.firebaseDb;
  const {
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    collection,
    addDoc,
    getDocs,
    updateDoc,
    deleteDoc,
    doc,
    query,
    where,
    serverTimestamp
  } = window.firebaseModules;

  let currentUser = null;
  let isCreatingUser = false;

  // CPFs dos administradores mestres (acesso total + podem ver senhas)
  const adminMestreCPFs = ['53974682007', '64058293098', '75130974040'];

  // CPFs dos administradores (acesso administrativo)
  const adminCPFs = [
    '01794238006',
    '12958477080',
    '20831765041',
    '31590792002',
    '42761954073',
    '53810286010',
    '64973512059',
    '75049831008',
    '86127094000',
    '97285376024',
    '08461953005',
    '19540728060',
    '20689147019',
    '31756089072',
    '42890361034',
    '86249751012',
    '97310826001'
  ];

  // Todos os CPFs com acesso administrativo (mestres + admins)
  const todosAdminCPFs = [...adminMestreCPFs, ...adminCPFs];

  function formatCPF(value) {
    const numbers = value.replace(/\D/g, '');
    if (numbers.length <= 3) return numbers;
    if (numbers.length <= 6) return numbers.slice(0, 3) + '.' + numbers.slice(3);
    if (numbers.length <= 9) return numbers.slice(0, 3) + '.' + numbers.slice(3, 6) + '.' + numbers.slice(6);
    return numbers.slice(0, 3) + '.' + numbers.slice(3, 6) + '.' + numbers.slice(6, 9) + '-' + numbers.slice(9, 11);
  }

  function validarCPF(cpf) {
    return cpf.replace(/\D/g, '').length === 11;
  }

  function showMessage(elementId, message, type = 'error') {
    const msgElement = document.getElementById(elementId);
    if (!msgElement) return;
    
    msgElement.textContent = message;
    msgElement.className = `text-xs min-h-[1.25rem] text-center ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
  }

  async function isAdmin(cpf) {
    const cpfLimpo = cpf.replace(/\D/g, '');
    return todosAdminCPFs.includes(cpfLimpo);
  }

  function isAdminMestre(cpf) {
    const cpfLimpo = cpf.replace(/\D/g, '');
    return adminMestreCPFs.includes(cpfLimpo);
  }

  function showView(name) {
    document.getElementById('view-login').classList.add('hidden');
    document.getElementById('view-admin').classList.add('hidden');
    document.getElementById('view-func').classList.add('hidden');

    if (name === 'login') {
      document.getElementById('view-login').classList.remove('hidden');
    } else if (name === 'admin') {
      document.getElementById('view-admin').classList.remove('hidden');
    } else if (name === 'func') {
      document.getElementById('view-func').classList.remove('hidden');
    }
  }

  document.getElementById('cpf-login').addEventListener('input', (e) => {
    e.target.value = formatCPF(e.target.value);
  });

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const cpfInput = document.getElementById('cpf-login').value.trim();
    const senha = document.getElementById('senha-login').value;
    const btn = document.getElementById('btn-entrar');
    
    if (!cpfInput || !senha) {
      showMessage('login-message', 'Por favor, preencha todos os campos', 'error');
      return;
    }

    const cpfLimpo = cpfInput.replace(/\D/g, '');
    
    if (!validarCPF(cpfLimpo)) {
      showMessage('login-message', 'CPF inválido', 'error');
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Entrando...';
    showMessage('login-message', '', 'error');
    
    try {
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('cpf', '==', cpfLimpo));
      const querySnapshot = await getDocs(q);
      
      if (querySnapshot.empty) {
        showMessage('login-message', 'CPF não encontrado. Crie uma conta primeiro.', 'error');
        btn.disabled = false;
        btn.textContent = 'Entrar';
        return;
      }
      
      const userData = querySnapshot.docs[0].data();
      const emailUsuario = userData.email;
      
      await signInWithEmailAndPassword(auth, emailUsuario, senha);
      
      showMessage('login-message', 'Login realizado com sucesso!', 'success');
      
    } catch (error) {
      console.error('Erro no login:', error);
      
      let mensagem = 'Erro ao fazer login';
      
      if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
        mensagem = 'CPF ou senha incorretos';
      } else if (error.code === 'auth/user-not-found') {
        mensagem = 'Usuário não encontrado';
      } else if (error.code === 'auth/too-many-requests') {
        mensagem = 'Muitas tentativas. Aguarde alguns minutos';
      }
      
      showMessage('login-message', mensagem, 'error');
      
      btn.disabled = false;
      btn.textContent = 'Entrar';
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (isCreatingUser) {
      return;
    }

    const btnEntrar = document.getElementById('btn-entrar');
    const loginMessage = document.getElementById('login-message');
    
    if (user) {
      currentUser = user;
      
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('uid', '==', user.uid));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const userData = querySnapshot.docs[0].data();
        const cpfUsuarioLogado = userData.cpf || '';
        
        const ehAdmin = await isAdmin(cpfUsuarioLogado);
        
        if (ehAdmin) {
          showView('admin');
          loadDashboardData();
        } else {
          showView('func');
        }
      }
    } else {
      showView('login');
      
      if (btnEntrar) {
        btnEntrar.disabled = false;
        btnEntrar.textContent = 'Entrar';
      }
      if (loginMessage) {
        loginMessage.textContent = '';
      }
    }
  });

  document.getElementById('btn-cadastrar').addEventListener('click', () => {
    document.getElementById('modal-cadastro').classList.remove('hidden');
  });
  
  document.getElementById('btn-fechar-modal-cadastro').addEventListener('click', () => {
    document.getElementById('modal-cadastro').classList.add('hidden');
  });
  
  document.getElementById('btn-cancelar-cadastro').addEventListener('click', () => {
    document.getElementById('modal-cadastro').classList.add('hidden');
  });
  
  document.getElementById('cadastro-cpf').addEventListener('input', (e) => {
    e.target.value = formatCPF(e.target.value);
  });
  
  document.getElementById('form-cadastro').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const nome = document.getElementById('cadastro-nome').value.trim().toUpperCase();
    const cpf = document.getElementById('cadastro-cpf').value.replace(/\D/g, '');
    const setor = document.getElementById('cadastro-setor').value;
    const senha = document.getElementById('cadastro-senha').value;
    const confirmarSenha = document.getElementById('cadastro-confirmar-senha').value;
    const btn = document.getElementById('btn-confirmar-cadastro');
    const msg = document.getElementById('cadastro-message');
    
    if (!validarCPF(cpf)) {
      msg.textContent = 'CPF inválido';
      msg.className = 'text-xs min-h-[1.25rem] text-red-600';
      return;
    }
    
    if (senha.length < 6) {
      msg.textContent = 'A senha deve ter no mínimo 6 caracteres';
      msg.className = 'text-xs min-h-[1.25rem] text-red-600';
      return;
    }
    
    if (senha !== confirmarSenha) {
      msg.textContent = 'As senhas não coincidem';
      msg.className = 'text-xs min-h-[1.25rem] text-red-600';
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Criando...';
    msg.textContent = '';
    
    try {
      const usersRef = collection(db, 'users');
      const qCpf = query(usersRef, where('cpf', '==', cpf));
      const cpfSnapshot = await getDocs(qCpf);
      
      if (!cpfSnapshot.empty) {
        msg.textContent = 'CPF já cadastrado';
        msg.className = 'text-xs min-h-[1.25rem] text-red-600';
        btn.disabled = false;
        btn.textContent = 'Criar Conta';
        return;
      }
      
      const usuarioAdminLogado = currentUser;
      let adminEmail = null;
      let adminSenha = null;
      
      if (usuarioAdminLogado) {
        adminEmail = usuarioAdminLogado.email;
        const adminQuery = query(usersRef, where('uid', '==', usuarioAdminLogado.uid));
        const adminSnapshot = await getDocs(adminQuery);
        if (!adminSnapshot.empty) {
          adminSenha = adminSnapshot.docs[0].data().senha;
        }
      }
      
      isCreatingUser = true;
      
      const emailFicticio = `${cpf}@jdemito.com`;
      
      let tipo = 'funcionario';
      if (adminMestreCPFs.includes(cpf)) {
        tipo = 'admin_mestre';
      } else if (adminCPFs.includes(cpf)) {
        tipo = 'admin';
      }
      
      const userCredential = await createUserWithEmailAndPassword(auth, emailFicticio, senha);
      const novoUID = userCredential.user.uid;
      
      await addDoc(usersRef, {
        uid: novoUID,
        nome,
        cpf,
        email: emailFicticio,
        setor,
        senha: senha,
        tipo,
        data_criacao: serverTimestamp()
      });
      
      if (usuarioAdminLogado && adminEmail && adminSenha) {
        await signOut(auth);
        await signInWithEmailAndPassword(auth, adminEmail, adminSenha);
      }
      
      isCreatingUser = false;
      
      msg.textContent = 'Cadastro criado com sucesso!';
      msg.className = 'text-xs min-h-[1.25rem] text-green-600';
      
      setTimeout(() => {
        document.getElementById('modal-cadastro').classList.add('hidden');
        document.getElementById('form-cadastro').reset();
        msg.textContent = '';
      }, 1500);
      
    } catch (error) {
      console.error('Erro ao criar conta:', error);
      
      isCreatingUser = false;
      
      let mensagemErro = 'Erro ao criar conta. Tente novamente.';
      
      if (error.code === 'auth/email-already-in-use') {
        mensagemErro = 'CPF já cadastrado no sistema';
      } else if (error.code === 'auth/weak-password') {
        mensagemErro = 'A matrícula deve ter no mínimo 6 caracteres';
      } else if (error.code === 'auth/invalid-email') {
        mensagemErro = 'CPF inválido';
      }
      
      msg.textContent = mensagemErro;
      msg.className = 'text-xs min-h-[1.25rem] text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Criar Conta';
    }
  });

  function showAdminSection(sectionName) {
    document.getElementById('admin-section-dashboard').classList.add('hidden');
    document.getElementById('admin-section-rids').classList.add('hidden');
    document.getElementById('admin-section-funcionarios').classList.add('hidden');
    document.getElementById('admin-section-solicitacoes').classList.add('hidden');
    document.getElementById('admin-section-relatorios').classList.add('hidden');

    const activeClass = 'px-4 py-2 rounded-full bg-[#ffd57a] text-[#2c2c2c] font-semibold';
    const inactiveClass = 'px-4 py-2 rounded-full text-[#2c2c2c] hover:bg-[#ece5df] transition-colors';
    
    document.getElementById('btn-nav-dashboard').className = inactiveClass;
    document.getElementById('btn-nav-rids').className = inactiveClass;
    document.getElementById('btn-nav-funcionarios').className = inactiveClass;
    document.getElementById('btn-nav-solicitacoes').className = inactiveClass + ' relative';
    document.getElementById('btn-nav-relatorios').className = inactiveClass;

    if (sectionName === 'dashboard') {
      document.getElementById('admin-section-dashboard').classList.remove('hidden');
      document.getElementById('btn-nav-dashboard').className = activeClass;
    } else if (sectionName === 'rids') {
      document.getElementById('admin-section-rids').classList.remove('hidden');
      document.getElementById('btn-nav-rids').className = activeClass;
    } else if (sectionName === 'funcionarios') {
      document.getElementById('admin-section-funcionarios').classList.remove('hidden');
      document.getElementById('btn-nav-funcionarios').className = activeClass;
    } else if (sectionName === 'solicitacoes') {
      document.getElementById('admin-section-solicitacoes').classList.remove('hidden');
      document.getElementById('btn-nav-solicitacoes').className = activeClass + ' relative';
    } else if (sectionName === 'relatorios') {
      document.getElementById('admin-section-relatorios').classList.remove('hidden');
      document.getElementById('btn-nav-relatorios').className = activeClass;
    }
  }

  document.getElementById('btn-nav-dashboard').addEventListener('click', () => {
    showAdminSection('dashboard');
    loadDashboardData();
  });
  document.getElementById('btn-nav-rids').addEventListener('click', () => {
    showAdminSection('rids');
    loadRidsTable();
  });
  document.getElementById('btn-nav-funcionarios').addEventListener('click', () => {
    showAdminSection('funcionarios');
    loadFuncionariosTable();
  });
  document.getElementById('btn-nav-solicitacoes').addEventListener('click', () => {
    showAdminSection('solicitacoes');
    loadSolicitacoes();
  });
  document.getElementById('btn-nav-relatorios').addEventListener('click', () => {
    showAdminSection('relatorios');
    loadRelatorios();
  });

  document.getElementById('btn-menu-admin').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('dropdown-menu-admin').classList.toggle('hidden');
  });

  document.getElementById('btn-menu-func').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('dropdown-menu-func').classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    const dropdownAdmin = document.getElementById('dropdown-menu-admin');
    const dropdownFunc = document.getElementById('dropdown-menu-func');
    const btnAdmin = document.getElementById('btn-menu-admin');
    const btnFunc = document.getElementById('btn-menu-func');
    
    if (dropdownAdmin && !dropdownAdmin.classList.contains('hidden')) {
      if (!btnAdmin.contains(e.target) && !dropdownAdmin.contains(e.target)) {
        dropdownAdmin.classList.add('hidden');
      }
    }
    
    if (dropdownFunc && !dropdownFunc.classList.contains('hidden')) {
      if (!btnFunc.contains(e.target) && !dropdownFunc.contains(e.target)) {
        dropdownFunc.classList.add('hidden');
      }
    }
  });

  document.getElementById('btn-logout-admin').addEventListener('click', async () => {
    await signOut(auth);
    showView('login');
  });

  document.getElementById('btn-logout-func').addEventListener('click', async () => {
    await signOut(auth);
    showView('login');
  });

  async function loadDashboardData() {
    try {
      const ridsRef = collection(db, 'rids');
      const ridsSnapshot = await getDocs(ridsRef);
      const totalRids = ridsSnapshot.size;
      
      let emAndamento = 0;
      let vencidos = 0;
      let corrigidos = 0;
      
      ridsSnapshot.forEach((doc) => {
        const rid = doc.data();
        const status = rid.status || '';
        
        if (status === 'Corrigido') {
          corrigidos++;
        } else if (status === 'Vencido') {
          vencidos++;
        } else {
          emAndamento++;
        }
      });
      
      document.getElementById('total-rids').textContent = totalRids;
      document.getElementById('rids-andamento').textContent = emAndamento;
      document.getElementById('rids-vencidos').textContent = vencidos;
      document.getElementById('rids-corrigidos').textContent = corrigidos;
      
      loadRidsRecentes();
      loadRankingEmissoes();
      
    } catch (error) {
      console.error('Erro ao carregar dados do dashboard:', error);
    }
  }

  async function loadRidsRecentes() {
    try {
      const container = document.getElementById('rids-recentes-container');
      container.innerHTML = '<div class="text-center py-8 text-[#5a5a5a]">Carregando RIDs recentes...</div>';
      
      const ridsRef = collection(db, 'rids');
      const ridsSnapshot = await getDocs(ridsRef);
      
      const ridsRecentes = [];
      ridsSnapshot.forEach((doc) => {
        const rid = doc.data();
        if (rid.data_criacao) {
          const dataCriacao = rid.data_criacao.toDate ? rid.data_criacao.toDate() : new Date(rid.data_criacao);
          ridsRecentes.push({ id: doc.id, ...rid, dataCriacao });
        }
      });
      
      ridsRecentes.sort((a, b) => b.dataCriacao - a.dataCriacao);
      
      if (ridsRecentes.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-[#5a5a5a]">Nenhum RID encontrado</div>';
        return;
      }
      
      container.innerHTML = '';
      
      const table = document.createElement('table');
      table.className = 'w-full';
      
      const thead = document.createElement('thead');
      thead.className = 'bg-[#e8e7e6] border-b border-[#b0b0b0]';
      thead.innerHTML = `
        <tr>
          <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Número</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Emitente</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Setor</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Criado em</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-[#2c2c2c]">Status</th>
        </tr>
      `;
      table.appendChild(thead);
      
      const tbody = document.createElement('tbody');
      tbody.className = 'divide-y divide-[#b0b0b0]';
      
      ridsRecentes.forEach((rid) => {
        let statusClass = 'bg-blue-100 text-blue-800 border-blue-300';
        const status = rid.status || 'Em Andamento';
        if (status === 'Corrigido') {
          statusClass = 'bg-green-100 text-green-800 border-green-300';
        } else if (status === 'Vencido') {
          statusClass = 'bg-red-100 text-red-800 border-red-300';
        }
        
        const dataFormatada = rid.dataCriacao.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-[#ece5df] transition-colors';
        
        tr.innerHTML = `
          <td class="px-4 py-3 text-sm text-[#2c2c2c] font-semibold">${rid.numero || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${rid.nome_emitente || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${rid.setor || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${dataFormatada}</td>
          <td class="px-4 py-3 text-sm">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${statusClass}">
              ${status}
            </span>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      container.appendChild(table);
      
    } catch (error) {
      console.error('Erro ao carregar RIDs recentes:', error);
      const container = document.getElementById('rids-recentes-container');
      container.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar RIDs recentes</div>';
    }
  }

  async function loadRankingEmissoes() {
    try {
      const container = document.getElementById('ranking-container');
      container.innerHTML = '<div class="text-center py-8 text-[#5a5a5a]">Carregando ranking...</div>';
      
      const ridsRef = collection(db, 'rids');
      const ridsSnapshot = await getDocs(ridsRef);
      
      const emitenteCount = {};
      
      ridsSnapshot.forEach((doc) => {
        const rid = doc.data();
        const emitente = rid.nome_emitente || 'N  o definido';
        
        if (!emitenteCount[emitente]) {
          emitenteCount[emitente] = 0;
        }
        emitenteCount[emitente]++;
      });
      
      const ranking = Object.entries(emitenteCount)
        .map(([emitente, count]) => ({ emitente, count }))
        .sort((a, b) => b.count - a.count);
      
      if (ranking.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-[#5a5a5a]">Nenhum RID cadastrado ainda</div>';
        return;
      }
      
      const maxCount = ranking[0].count;
      
      container.innerHTML = '';
      
      ranking.forEach((item, index) => {
        const porcentagem = (item.count / maxCount) * 100;
        
        let medalColor = '';
        if (index === 0) medalColor = 'text-yellow-500';
        else if (index === 1) medalColor = 'text-gray-400';
        else if (index === 2) medalColor = 'text-orange-600';
        
        const rankingItem = document.createElement('div');
        rankingItem.className = 'space-y-2';
        
        rankingItem.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-lg font-bold ${medalColor || 'text-[#5a5a5a]'} w-8">
                ${index === 0 ? '🥇' : index === 1 ? '  ' : index === 2 ? '🥉' : `${index + 1}º`}
              </span>
              <span class="text-sm font-semibold text-[#2c2c2c]">${item.emitente}</span>
            </div>
            <span class="text-sm font-bold text-[#2c2c2c]">${item.count} RID${item.count !== 1 ? 's' : ''}</span>
          </div>
          <div class="w-full bg-[#ece5df] rounded-full h-3 overflow-hidden">
            <div class="bg-[#ffd57a] h-full rounded-full transition-all duration-500" style="width: ${porcentagem}%"></div>
          </div>
        `;
        
        container.appendChild(rankingItem);
      });
      
    } catch (error) {
      console.error('Erro ao carregar ranking:', error);
      const container = document.getElementById('ranking-container');
      container.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar ranking</div>';
    }
  }

  document.getElementById('btn-criar-rid').addEventListener('click', async () => {
    document.getElementById('modal-criar-rid').classList.remove('hidden');
    
    // Preencher automaticamente o nome do emitente com o usuário logado
    try {
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('uid', '==', currentUser.uid));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const userData = querySnapshot.docs[0].data();
        const nomeUsuario = userData.nome || '';
        document.getElementById('rid-emitente').value = nomeUsuario;
        document.getElementById('rid-emitente').readOnly = true;
        document.getElementById('rid-emitente').classList.add('bg-gray-200', 'cursor-not-allowed');
      }
    } catch (error) {
      console.error('Erro ao carregar dados do usuário:', error);
    }
    
    // Carregar lista de administradores
    try {
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('tipo', '==', 'admin'));
      const querySnapshot = await getDocs(q);
      
      const selectLider = document.getElementById('rid-lider');
      selectLider.innerHTML = '<option value="">Selecione um líder (opcional)</option>';
      
      querySnapshot.forEach((doc) => {
        const user = doc.data();
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = `${user.nome} - ${user.setor}`;
        option.dataset.nome = user.nome;
        selectLider.appendChild(option);
      });
    } catch (error) {
      console.error('Erro ao carregar administradores:', error);
    }
  });

  document.getElementById('btn-fechar-modal-rid').addEventListener('click', () => {
    document.getElementById('modal-criar-rid').classList.add('hidden');
  });

  document.getElementById('btn-cancelar-rid').addEventListener('click', () => {
    document.getElementById('modal-criar-rid').classList.add('hidden');
  });

  document.getElementById('form-criar-rid').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = document.getElementById('btn-confirmar-rid');
    const msg = document.getElementById('rid-message');
    
    btn.disabled = true;
    btn.textContent = 'Criando...';
    msg.textContent = '';
    
    try {
      const ridsRef = collection(db, 'rids');
      const ridsSnapshot = await getDocs(ridsRef);
      const proximoNumero = ridsSnapshot.size + 1;
      
      const liderId = document.getElementById('rid-lider').value;
      const selectLider = document.getElementById('rid-lider');
      const selectedOption = selectLider.options[selectLider.selectedIndex];
      const nomeLider = liderId ? selectedOption.dataset.nome : null;
      
      const ridData = {
        numero: `RID-${String(proximoNumero).padStart(4, '0')}`,
        nome_emitente: document.getElementById('rid-emitente').value.trim().toUpperCase(),
        tipo_contrato: document.getElementById('rid-tipo-contrato').value,
        unidade: document.getElementById('rid-unidade').value.trim().toUpperCase(),
        setor: document.getElementById('rid-setor').value,
        data: document.getElementById('rid-data').value,
        incidente: document.getElementById('rid-incidente').value,
        origem_deteccao: document.getElementById('rid-origem').value,
        local_ocorrencia: document.getElementById('rid-local').value.trim().toUpperCase(),
        descricao: document.getElementById('rid-descricao').value.trim(),
        classificacao_risco: document.getElementById('rid-classificacao').value,
        acao_imediata: document.getElementById('rid-acao-imediata').value.trim(),
        status: document.getElementById('rid-status').value,
        data_criacao: serverTimestamp()
      };
      
      // Adicionar líder se foi selecionado
      if (liderId && nomeLider) {
        ridData.lider_responsavel = nomeLider;
        ridData.lider_id = liderId;
        ridData.data_designacao = serverTimestamp();
      }
      
      await addDoc(ridsRef, ridData);
      
      msg.textContent = 'RID criado com sucesso!';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-green-600';
      
      setTimeout(() => {
        document.getElementById('modal-criar-rid').classList.add('hidden');
        document.getElementById('form-criar-rid').reset();
        msg.textContent = '';
        loadDashboardData();
        loadRidsTable();
      }, 1500);
      
    } catch (error) {
      console.error('Erro ao criar RID:', error);
      msg.textContent = 'Erro ao criar RID. Tente novamente.';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Criar RID';
    }
  });

  async function loadRidsTable() {
    try {
      const tbody = document.getElementById('rids-table-body');
      tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-[#5a5a5a]">Carregando RIDs...</td></tr>';
      
      // Verificar se o usuário logado é um admin mestre
      let ehAdminMestre = false;
      if (currentUser) {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('uid', '==', currentUser.uid));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const userData = querySnapshot.docs[0].data();
          const cpfUsuario = userData.cpf || '';
          ehAdminMestre = isAdminMestre(cpfUsuario);
        }
      }
      
      const ridsRef = collection(db, 'rids');
      const ridsSnapshot = await getDocs(ridsRef);
      
      if (ridsSnapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-[#5a5a5a]">Nenhum RID cadastrado</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      ridsSnapshot.forEach((docSnap) => {
        const rid = docSnap.data();
        
        let statusClass = 'bg-blue-100 text-blue-800 border-blue-300';
        const status = rid.status || 'Em Andamento';
        if (status === 'Corrigido') {
          statusClass = 'bg-green-100 text-green-800 border-green-300';
        } else if (status === 'Vencido') {
          statusClass = 'bg-red-100 text-red-800 border-red-300';
        }
        
        let riscoClass = 'bg-gray-100 text-gray-800 border-gray-300';
        const risco = rid.classificacao_risco || 'N/A';
        if (risco === 'Baixo') {
          riscoClass = 'bg-green-100 text-green-800 border-green-300';
        } else if (risco === 'Médio') {
          riscoClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
        } else if (risco === 'Alto') {
          riscoClass = 'bg-orange-100 text-orange-800 border-orange-300';
        } else if (risco === 'Crítico') {
          riscoClass = 'bg-red-100 text-red-800 border-red-300';
        }
        
        const dataFormatada = rid.data ? new Date(rid.data).toLocaleDateString('pt-BR') : 'N/A';
        
        // Botão de exclusão diferente para admin mestre vs admin regular
        const btnExclusaoRid = ehAdminMestre ? `
          <button class="btn-excluir-rid-direto w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 text-red-600 transition-colors" title="Excluir RID" data-rid-id="${docSnap.id}" data-rid-numero="${rid.numero || 'N/A'}">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
            </svg>
          </button>
        ` : `
          <button class="btn-solicitar-exclusao-rid w-8 h-8 flex items-center justify-center rounded-lg hover:bg-yellow-50 text-yellow-600 transition-colors" title="Solicitar exclusão" data-rid-id="${docSnap.id}" data-rid-numero="${rid.numero || 'N/A'}">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2L1 21h22L12 2zm0 4l8.5 15h-17L12 6zm-1 5v4h2v-4h-2zm0 5v2h2v-2h-2z"/>
            </svg>
          </button>
        `;
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-[#ece5df] transition-colors';
        
        tr.innerHTML = `
          <td class="px-4 py-3 text-sm text-[#2c2c2c] font-semibold">${rid.numero || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${rid.nome_emitente || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${rid.setor || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${dataFormatada}</td>
          <td class="px-4 py-3 text-sm">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${statusClass}">
              ${status}
            </span>
          </td>
          <td class="px-4 py-3 text-sm">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${riscoClass}">
              ${risco}
            </span>
          </td>
          <td class="px-4 py-3 text-center">
            <div class="flex items-center justify-center gap-2">
              <button class="btn-ver-rid w-8 h-8 flex items-center justify-center rounded-lg hover:bg-blue-50 text-blue-600 transition-colors" title="Ver detalhes" data-rid-id="${docSnap.id}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
              ${btnExclusaoRid}
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      // Event listeners para botões de exclusão direta de RID (admin mestre)
      document.querySelectorAll('.btn-excluir-rid-direto').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const ridId = e.currentTarget.dataset.ridId;
          const ridNumero = e.currentTarget.dataset.ridNumero;
          
          // Criar modal de confirmação inline
          const confirmDiv = document.createElement('div');
          confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50';
          confirmDiv.innerHTML = `
            <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full p-6">
              <h3 class="text-lg font-semibold text-[#2c2c2c] mb-4">Confirmar Exclusão</h3>
              <p class="text-sm text-[#5a5a5a] mb-6">Tem certeza que deseja excluir o RID ${ridNumero}? Esta ação não pode ser desfeita.</p>
              <div class="flex gap-3">
                <button id="btn-cancelar-exclusao-rid-direta" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors">
                  Cancelar
                </button>
                <button id="btn-confirmar-exclusao-rid-direta" class="flex-1 px-4 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors">
                  Excluir
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(confirmDiv);
          
          document.getElementById('btn-cancelar-exclusao-rid-direta').addEventListener('click', () => {
            confirmDiv.remove();
          });
          
          document.getElementById('btn-confirmar-exclusao-rid-direta').addEventListener('click', async () => {
            try {
              await deleteDoc(doc(db, 'rids', ridId));
              const successDiv = document.createElement('div');
              successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
              successDiv.textContent = 'RID excluído com sucesso!';
              document.body.appendChild(successDiv);
              
              setTimeout(() => {
                successDiv.remove();
              }, 3000);
              
              confirmDiv.remove();
              loadRidsTable();
              loadDashboardData();
            } catch (error) {
              console.error('Erro ao excluir RID:', error);
              const errorDiv = document.createElement('div');
              errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
              errorDiv.textContent = 'Erro ao excluir RID';
              document.body.appendChild(errorDiv);
              
              setTimeout(() => {
                errorDiv.remove();
              }, 3000);
            }
          });
        });
      });
      
      // Event listeners para botões de ver RID
      document.querySelectorAll('.btn-ver-rid').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const ridId = e.currentTarget.dataset.ridId;
          
          try {
            const ridDoc = await getDocs(query(collection(db, 'rids'), where('__name__', '==', ridId)));
            
            if (ridDoc.empty) {
              const errorDiv = document.createElement('div');
              errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
              errorDiv.textContent = 'RID não encontrado';
              document.body.appendChild(errorDiv);
              setTimeout(() => errorDiv.remove(), 3000);
              return;
            }
            
            const rid = ridDoc.docs[0].data();
            const dataFormatada = rid.data ? new Date(rid.data).toLocaleDateString('pt-BR') : 'N/A';
            
            let statusClass = 'bg-blue-100 text-blue-800 border-blue-300';
            const status = rid.status || 'Em Andamento';
            if (status === 'Corrigido') {
              statusClass = 'bg-green-100 text-green-800 border-green-300';
            } else if (status === 'Vencido') {
              statusClass = 'bg-red-100 text-red-800 border-red-300';
            }
            
            let riscoClass = 'bg-gray-100 text-gray-800 border-gray-300';
            const risco = rid.classificacao_risco || 'N/A';
            if (risco === 'Baixo') {
              riscoClass = 'bg-green-100 text-green-800 border-green-300';
            } else if (risco === 'Médio') {
              riscoClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
            } else if (risco === 'Alto') {
              riscoClass = 'bg-orange-100 text-orange-800 border-orange-300';
            } else if (risco === 'Crítico') {
              riscoClass = 'bg-red-100 text-red-800 border-red-300';
            }
            
            const conteudo = document.getElementById('conteudo-modal-ver-rid');
            conteudo.innerHTML = `
              <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Número do RID</h4>
                  <p class="text-lg font-bold text-[#2c2c2c]">${rid.numero || 'N/A'}</p>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Emitente</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.nome_emitente || 'N/A'}</p>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Tipo de Contrato</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.tipo_contrato || 'N/A'}</p>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Unidade</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.unidade || 'N/A'}</p>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Setor</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.setor || 'N/A'}</p>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Data</h4>
                  <p class="text-sm text-[#2c2c2c]">${dataFormatada}</p>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Incidente ou Desvios</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.incidente || 'N/A'}</p>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Origem da Detecção</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.origem_deteccao || 'N/A'}</p>
                </div>
                
                <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Local da Ocorrência</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.local_ocorrencia || 'N/A'}</p>
                </div>
                
                <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Descrição da Ocorrência</h4>
                  <p class="text-sm text-[#2c2c2c] whitespace-pre-wrap">${rid.descricao || 'N/A'}</p>
                </div>
                
                <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Ação Imediata</h4>
                  <p class="text-sm text-[#2c2c2c] whitespace-pre-wrap">${rid.acao_imediata || 'N/A'}</p>
                </div>
                
                ${rid.lider_responsavel ? `
                <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Líder Respons  vel</h4>
                  <p class="text-sm text-[#2c2c2c]">${rid.lider_responsavel}</p>
                </div>
                ` : ''}
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Status</h4>
                  <select id="edit-status-rid" class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40">
                    <option value="Em Andamento" ${status === 'Em Andamento' ? 'selected' : ''}>EM ANDAMENTO</option>
                    <option value="Corrigido" ${status === 'Corrigido' ? 'selected' : ''}>CORRIGIDO</option>
                    <option value="Vencido" ${status === 'Vencido' ? 'selected' : ''}>VENCIDO</option>
                  </select>
                </div>
                
                <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
                  <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Classificação de Risco</h4>
                  <select id="edit-risco-rid" class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40">
                    <option value="Baixo" ${risco === 'Baixo' ? 'selected' : ''}>Baixo</option>
                    <option value="Médio" ${risco === 'Médio' ? 'selected' : ''}>Médio</option>
                    <option value="Alto" ${risco === 'Alto' ? 'selected' : ''}>Alto</option>
                    <option value="Cr  tico" ${risco === 'Crítico' ? 'selected' : ''}>Crítico</option>
                  </select>
                </div>
              </div>
              
              <div id="edit-rid-message" class="text-xs min-h-[1.25rem] text-center mt-4"></div>
              
              <div class="flex gap-3 pt-4 border-t border-[#b0b0b0] mt-4">
                <button id="btn-designar-rid" class="flex-1 px-4 py-2.5 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-semibold transition-colors">
                  Designar RID
                </button>
                <button id="btn-salvar-alteracoes-rid" class="flex-1 px-4 py-2.5 rounded-xl bg-[#ffd57a] hover:bg-[#ffeab8] text-[#2c2c2c] font-semibold transition-colors">
                  Salvar Alterações
                </button>
              </div>
            `;
            
            // Event listener para salvar alterações
            document.getElementById('btn-salvar-alteracoes-rid').addEventListener('click', async () => {
              const btnSalvar = document.getElementById('btn-salvar-alteracoes-rid');
              const msg = document.getElementById('edit-rid-message');
              
              btnSalvar.disabled = true;
              btnSalvar.textContent = 'Salvando...';
              msg.textContent = '';
              
              try {
                const novoStatus = document.getElementById('edit-status-rid').value;
                const novoRisco = document.getElementById('edit-risco-rid').value;
                
                const ridDocRef = doc(db, 'rids', ridId);
                await updateDoc(ridDocRef, {
                  status: novoStatus,
                  classificacao_risco: novoRisco
                });
                
                msg.textContent = 'Alterações salvas com sucesso!';
                msg.className = 'text-xs min-h-[1.25rem] text-center mt-4 text-green-600';
                
                setTimeout(() => {
                  document.getElementById('modal-ver-rid').classList.add('hidden');
                  loadRidsTable();
                  loadDashboardData();
                }, 1500);
                
              } catch (error) {
                console.error('Erro ao salvar alterações:', error);
                msg.textContent = 'Erro ao salvar alterações. Tente novamente.';
                msg.className = 'text-xs min-h-[1.25rem] text-center mt-4 text-red-600';
                btnSalvar.disabled = false;
                btnSalvar.textContent = 'Salvar Alterações';
              }
            });
            
            // Event listener para designar RID
            document.getElementById('btn-designar-rid').addEventListener('click', async () => {
              // Abrir modal de designação
              document.getElementById('modal-designar-rid').classList.remove('hidden');
              document.getElementById('modal-designar-rid').dataset.ridId = ridId;
              document.getElementById('modal-designar-rid').dataset.ridNumero = rid.numero || 'N/A';
              
              // Carregar lista de administradores
              try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('tipo', '==', 'admin'));
                const querySnapshot = await getDocs(q);
                
                const selectLiderDesignar = document.getElementById('designar-lider-select');
                selectLiderDesignar.innerHTML = '<option value="">Selecione um líder</option>';
                
                querySnapshot.forEach((doc) => {
                  const user = doc.data();
                  const option = document.createElement('option');
                  option.value = doc.id;
                  option.textContent = `${user.nome} - ${user.setor}`;
                  option.dataset.nome = user.nome;
                  selectLiderDesignar.appendChild(option);
                });
              } catch (error) {
                console.error('Erro ao carregar administradores:', error);
              }
            });
            
            document.getElementById('modal-ver-rid').classList.remove('hidden');
            
          } catch (error) {
            console.error('Erro ao carregar detalhes do RID:', error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
            errorDiv.textContent = 'Erro ao carregar detalhes do RID';
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
          }
        });
      });
      
      // Event listeners para botões de solicitar exclusão de RID
      document.querySelectorAll('.btn-solicitar-exclusao-rid').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const ridId = e.currentTarget.dataset.ridId;
          const ridNumero = e.currentTarget.dataset.ridNumero;
          
          // Verificar se é admin mestre
          const usersRef = collection(db, 'users');
          const q = query(usersRef, where('uid', '==', currentUser.uid));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
            const userData = querySnapshot.docs[0].data();
            const cpfUsuario = userData.cpf || '';
            const ehAdminMestre = isAdminMestre(cpfUsuario);
            
            if (ehAdminMestre) {
              // Admin mestre pode excluir diretamente - criar modal de confirmação inline
              const confirmDiv = document.createElement('div');
              confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50';
              confirmDiv.innerHTML = `
                <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full p-6">
                  <h3 class="text-lg font-semibold text-[#2c2c2c] mb-4">Confirmar Exclusão</h3>
                  <p class="text-sm text-[#5a5a5a] mb-6">Tem certeza que deseja excluir o RID ${ridNumero}? Esta ação não pode ser desfeita.</p>
                  <div class="flex gap-3">
                    <button id="btn-cancelar-exclusao-direta" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors">
                      Cancelar
                    </button>
                    <button id="btn-confirmar-exclusao-direta" class="flex-1 px-4 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors">
                      Excluir
                    </button>
                  </div>
                </div>
              `;
              document.body.appendChild(confirmDiv);
              
              document.getElementById('btn-cancelar-exclusao-direta').addEventListener('click', () => {
                confirmDiv.remove();
              });
              
              document.getElementById('btn-confirmar-exclusao-direta').addEventListener('click', async () => {
                try {
                  await deleteDoc(doc(db, 'rids', ridId));
                  const successDiv = document.createElement('div');
                  successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                  successDiv.textContent = 'RID excluído com sucesso!';
                  document.body.appendChild(successDiv);
                  
                  setTimeout(() => {
                    successDiv.remove();
                  }, 3000);
                  
                  confirmDiv.remove();
                  loadRidsTable();
                  loadDashboardData();
                } catch (error) {
                  console.error('Erro ao excluir RID:', error);
                  const errorDiv = document.createElement('div');
                  errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                  errorDiv.textContent = 'Erro ao excluir RID';
                  document.body.appendChild(errorDiv);
                  
                  setTimeout(() => {
                    errorDiv.remove();
                  }, 3000);
                }
              });
            } else {
              // Admin regular abre modal de solicitação
              document.getElementById('rid-numero-exclusao').textContent = ridNumero;
              document.getElementById('modal-solicitar-exclusao-rid').classList.remove('hidden');
              document.getElementById('modal-solicitar-exclusao-rid').dataset.ridId = ridId;
              document.getElementById('modal-solicitar-exclusao-rid').dataset.ridNumero = ridNumero;
            }
          }
        });
      });
      
    } catch (error) {
      console.error('Erro ao carregar RIDs:', error);
      const tbody = document.getElementById('rids-table-body');
      tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-600">Erro ao carregar RIDs</td></tr>';
    }
  }

  async function loadFuncionariosTable() {
    try {
      const tbody = document.getElementById('funcionarios-table-body');
      tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-[#5a5a5a]">Carregando funcionários...</td></tr>';
      
      // Verificar se o usuário logado é um admin mestre
      let ehAdminMestre = false;
      if (currentUser) {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('uid', '==', currentUser.uid));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const userData = querySnapshot.docs[0].data();
          const cpfUsuario = userData.cpf || '';
          ehAdminMestre = isAdminMestre(cpfUsuario);
        }
      }
      
      const usersRef = collection(db, 'users');
      const usersSnapshot = await getDocs(usersRef);
      
      if (usersSnapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-[#5a5a5a]">Nenhum funcionário cadastrado</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      usersSnapshot.forEach((docSnap) => {
        const user = docSnap.data();
        
        const cpfFormatado = user.cpf ? formatCPF(user.cpf) : 'N/A';
        const dataCadastro = user.data_criacao ? 
          (user.data_criacao.toDate ? user.data_criacao.toDate() : new Date(user.data_criacao)).toLocaleDateString('pt-BR') : 
          'N/A';
        
        let tipoClass = 'bg-blue-100 text-blue-800 border-blue-300';
        let tipoTexto = 'Funcionário';
        
        if (user.tipo === 'admin_mestre') {
          tipoClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
          tipoTexto = 'Admin Mestre';
        } else if (user.tipo === 'admin') {
          tipoClass = 'bg-purple-100 text-purple-800 border-purple-300';
          tipoTexto = 'Administrador';
        }
        
        // Botão de ver senha só aparece para admin mestre
        const btnVerSenha = ehAdminMestre ? `
          <button class="btn-ver-senha-funcionario w-8 h-8 flex items-center justify-center rounded-lg hover:bg-blue-50 text-blue-600 transition-colors" title="Ver senha" data-user-senha="${user.senha || 'N/A'}">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>
        ` : '';
        
        // Botão de exclusão diferente para admin mestre vs admin regular
        const btnExclusao = ehAdminMestre ? `
          <button class="btn-excluir-func-direto w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 text-red-600 transition-colors" title="Excluir funcionário" data-func-id="${docSnap.id}" data-func-nome="${user.nome || 'N/A'}">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
            </svg>
          </button>
        ` : `
          <button class="btn-solicitar-exclusao-func w-8 h-8 flex items-center justify-center rounded-lg hover:bg-yellow-50 text-yellow-600 transition-colors" title="Solicitar exclusão" data-func-id="${docSnap.id}" data-func-nome="${user.nome || 'N/A'}">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2L1 21h22L12 2zm0 4l8.5 15h-17L12 6zm-1 5v4h2v-4h-2zm0 5v2h2v-2h-2z"/>
            </svg>
          </button>
        `;
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-[#ece5df] transition-colors';
        
        tr.innerHTML = `
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${user.nome || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${cpfFormatado}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${user.setor || 'N/A'}</td>
          <td class="px-4 py-3 text-sm text-[#2c2c2c]">${dataCadastro}</td>
          <td class="px-4 py-3 text-sm">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${tipoClass}">
              ${tipoTexto}
            </span>
          </td>
          <td class="px-4 py-3 text-center">
            <div class="flex items-center justify-center gap-2">
              ${btnVerSenha}
              ${btnExclusao}
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      // Event listener para botões de ver senha
      document.querySelectorAll('.btn-ver-senha-funcionario').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const senha = e.currentTarget.dataset.userSenha;
          const successDiv = document.createElement('div');
          successDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
          successDiv.textContent = `Senha: ${senha}`;
          document.body.appendChild(successDiv);
          
          setTimeout(() => {
            successDiv.remove();
          }, 5000);
        });
      });
      
      // Event listeners para botões de exclusão direta (admin mestre)
      document.querySelectorAll('.btn-excluir-func-direto').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const funcId = e.currentTarget.dataset.funcId;
          const funcNome = e.currentTarget.dataset.funcNome;
          
          // Criar modal de confirmação inline
          const confirmDiv = document.createElement('div');
          confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50';
          confirmDiv.innerHTML = `
            <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full p-6">
              <h3 class="text-lg font-semibold text-[#2c2c2c] mb-4">Confirmar Exclusão</h3>
              <p class="text-sm text-[#5a5a5a] mb-6">Tem certeza que deseja excluir o funcionário ${funcNome}? Esta ação não pode ser desfeita.</p>
              <div class="flex gap-3">
                <button id="btn-cancelar-exclusao-func-direta" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors">
                  Cancelar
                </button>
                <button id="btn-confirmar-exclusao-func-direta" class="flex-1 px-4 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors">
                  Excluir
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(confirmDiv);
          
          document.getElementById('btn-cancelar-exclusao-func-direta').addEventListener('click', () => {
            confirmDiv.remove();
          });
          
          document.getElementById('btn-confirmar-exclusao-func-direta').addEventListener('click', async () => {
            try {
              await deleteDoc(doc(db, 'users', funcId));
              const successDiv = document.createElement('div');
              successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
              successDiv.textContent = 'Funcionário excluído com sucesso!';
              document.body.appendChild(successDiv);
              
              setTimeout(() => {
                successDiv.remove();
              }, 3000);
              
              confirmDiv.remove();
              loadFuncionariosTable();
            } catch (error) {
              console.error('Erro ao excluir funcionário:', error);
              const errorDiv = document.createElement('div');
              errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
              errorDiv.textContent = 'Erro ao excluir funcionário';
              document.body.appendChild(errorDiv);
              
              setTimeout(() => {
                errorDiv.remove();
              }, 3000);
            }
          });
        });
      });
      
      // Event listeners para botões de solicitar exclusão de funcionário
      document.querySelectorAll('.btn-solicitar-exclusao-func').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const funcId = e.currentTarget.dataset.funcId;
          const funcNome = e.currentTarget.dataset.funcNome;
          
          // Verificar se é admin mestre
          const usersRef = collection(db, 'users');
          const q = query(usersRef, where('uid', '==', currentUser.uid));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
            const userData = querySnapshot.docs[0].data();
            const cpfUsuario = userData.cpf || '';
            const ehAdminMestre = isAdminMestre(cpfUsuario);
            
            if (ehAdminMestre) {
              // Admin mestre pode excluir diretamente - criar modal de confirmação inline
              const confirmDiv = document.createElement('div');
              confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50';
              confirmDiv.innerHTML = `
                <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full p-6">
                  <h3 class="text-lg font-semibold text-[#2c2c2c] mb-4">Confirmar Exclusão</h3>
                  <p class="text-sm text-[#5a5a5a] mb-6">Tem certeza que deseja excluir o funcionário ${funcNome}? Esta ação não pode ser desfeita.</p>
                  <div class="flex gap-3">
                    <button id="btn-cancelar-exclusao-func-direta" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors">
                      Cancelar
                    </button>
                    <button id="btn-confirmar-exclusao-func-direta" class="flex-1 px-4 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors">
                      Excluir
                    </button>
                  </div>
                </div>
              `;
              document.body.appendChild(confirmDiv);
              
              document.getElementById('btn-cancelar-exclusao-func-direta').addEventListener('click', () => {
                confirmDiv.remove();
              });
              
              document.getElementById('btn-confirmar-exclusao-func-direta').addEventListener('click', async () => {
                try {
                  await deleteDoc(doc(db, 'users', funcId));
                  const successDiv = document.createElement('div');
                  successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                  successDiv.textContent = 'Funcionário excluído com sucesso!';
                  document.body.appendChild(successDiv);
                  
                  setTimeout(() => {
                    successDiv.remove();
                  }, 3000);
                  
                  confirmDiv.remove();
                  loadFuncionariosTable();
                } catch (error) {
                  console.error('Erro ao excluir funcionário:', error);
                  const errorDiv = document.createElement('div');
                  errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                  errorDiv.textContent = 'Erro ao excluir funcionário';
                  document.body.appendChild(errorDiv);
                  
                  setTimeout(() => {
                    errorDiv.remove();
                  }, 3000);
                }
              });
            } else {
              // Admin regular abre modal de solicitação
              document.getElementById('func-nome-exclusao').textContent = funcNome;
              document.getElementById('modal-solicitar-exclusao-func').classList.remove('hidden');
              document.getElementById('modal-solicitar-exclusao-func').dataset.funcId = funcId;
              document.getElementById('modal-solicitar-exclusao-func').dataset.funcNome = funcNome;
            }
          }
        });
      });
      
    } catch (error) {
      console.error('Erro ao carregar funcionários:', error);
      const tbody = document.getElementById('funcionarios-table-body');
      tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-600">Erro ao carregar funcionários</td></tr>';
    }
  }

  async function loadSolicitacoes() {
    try {
      const container = document.getElementById('solicitacoes-container');
      container.innerHTML = '<div class="text-center py-8 text-[#5a5a5a]">Carregando solicitações...</div>';
      
      // Verificar se o usuário logado é um admin mestre
      let ehAdminMestre = false;
      if (currentUser) {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('uid', '==', currentUser.uid));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const userData = querySnapshot.docs[0].data();
          const cpfUsuario = userData.cpf || '';
          ehAdminMestre = isAdminMestre(cpfUsuario);
        }
      }
      
      const solicitacoesRef = collection(db, 'solicitacoes_exclusao');
      const qPendentes = query(solicitacoesRef, where('status', '==', 'pendente'));
      const solicitacoesSnapshot = await getDocs(qPendentes);
      
      if (solicitacoesSnapshot.empty) {
        container.innerHTML = '<div class="text-center py-8 text-[#5a5a5a]">Nenhuma solicitação pendente no momento</div>';
        return;
      }
      
      container.innerHTML = '';
      
      solicitacoesSnapshot.forEach((docSnap) => {
        const solicitacao = docSnap.data();
        const dataSolicitacao = solicitacao.data_solicitacao ? 
          (solicitacao.data_solicitacao.toDate ? solicitacao.data_solicitacao.toDate() : new Date(solicitacao.data_solicitacao)).toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) : 
          'N/A';
        
        const tipoSolicitacao = solicitacao.tipo === 'rid' ? 'RID' : 'Funcionário';
        const identificador = solicitacao.tipo === 'rid' ? solicitacao.rid_numero : solicitacao.funcionario_nome;
        
        const cardDiv = document.createElement('div');
        cardDiv.className = 'bg-white rounded-xl border border-[#b0b0b0] p-6 shadow-sm';
        
        // Botões diferentes para admin mestre vs admin regular
        const botoesAcao = ehAdminMestre ? `
          <div class="flex gap-3 mt-4">
            <button class="btn-aprovar-solicitacao flex-1 px-4 py-2.5 rounded-xl bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors" data-solicitacao-id="${docSnap.id}" data-tipo="${solicitacao.tipo}" data-item-id="${solicitacao.tipo === 'rid' ? solicitacao.rid_id : solicitacao.funcionario_id}" data-identificador="${identificador}">
              Aprovar e Excluir
            </button>
            <button class="btn-rejeitar-solicitacao flex-1 px-4 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors" data-solicitacao-id="${docSnap.id}">
              Rejeitar
            </button>
          </div>
        ` : `
          <div class="mt-4 bg-blue-50 border border-blue-300 rounded-xl p-3">
            <p class="text-xs text-blue-700 text-center">
              <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
              </svg>
              Aguardando aprovação de um administrador mestre
            </p>
          </div>
        `;
        
        cardDiv.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-[#2c2c2c]">Solicitação de Exclusão - ${tipoSolicitacao}</h3>
                <p class="text-sm text-[#5a5a5a]">${dataSolicitacao}</p>
              </div>
            </div>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border bg-yellow-100 text-yellow-800 border-yellow-300">
              Pendente
            </span>
          </div>
          
          <div class="space-y-3">
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-[#ece5df] rounded-xl p-3 border border-[#b0b0b0]">
                <p class="text-xs font-semibold text-[#5a5a5a] mb-1">Tipo</p>
                <p class="text-sm font-semibold text-[#2c2c2c]">${tipoSolicitacao}</p>
              </div>
              <div class="bg-[#ece5df] rounded-xl p-3 border border-[#b0b0b0]">
                <p class="text-xs font-semibold text-[#5a5a5a] mb-1">Identificador</p>
                <p class="text-sm font-semibold text-[#2c2c2c]">${identificador}</p>
              </div>
            </div>
            
            <div class="bg-[#ece5df] rounded-xl p-3 border border-[#b0b0b0]">
              <p class="text-xs font-semibold text-[#5a5a5a] mb-1">Solicitante</p>
              <p class="text-sm text-[#2c2c2c]">${solicitacao.solicitante || 'Desconhecido'}</p>
            </div>
            
            <div class="bg-[#ece5df] rounded-xl p-3 border border-[#b0b0b0]">
              <p class="text-xs font-semibold text-[#5a5a5a] mb-2">Motivo da Solicitação</p>
              <p class="text-sm text-[#2c2c2c] whitespace-pre-wrap">${solicitacao.motivo || 'Sem motivo especificado'}</p>
            </div>
          </div>
          
          ${botoesAcao}
        `;
        
        container.appendChild(cardDiv);
      });
      
      // Event listeners para botões de aprovar (apenas admin mestre)
      if (ehAdminMestre) {
        document.querySelectorAll('.btn-aprovar-solicitacao').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const solicitacaoId = e.currentTarget.dataset.solicitacaoId;
            const tipo = e.currentTarget.dataset.tipo;
            const itemId = e.currentTarget.dataset.itemId;
            const identificador = e.currentTarget.dataset.identificador;
            
            // Criar modal de confirmação
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50';
            confirmDiv.innerHTML = `
              <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full p-6">
                <h3 class="text-lg font-semibold text-[#2c2c2c] mb-4">Confirmar Exclusão</h3>
                <p class="text-sm text-[#5a5a5a] mb-6">Tem certeza que deseja aprovar esta solicitação e excluir ${tipo === 'rid' ? 'o RID' : 'o funcionário'} ${identificador}? Esta ação não pode ser desfeita.</p>
                <div class="flex gap-3">
                  <button id="btn-cancelar-aprovacao" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors">
                    Cancelar
                  </button>
                  <button id="btn-confirmar-aprovacao" class="flex-1 px-4 py-2.5 rounded-xl bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors">
                    Aprovar e Excluir
                  </button>
                </div>
              </div>
            `;
            document.body.appendChild(confirmDiv);
            
            document.getElementById('btn-cancelar-aprovacao').addEventListener('click', () => {
              confirmDiv.remove();
            });
            
            document.getElementById('btn-confirmar-aprovacao').addEventListener('click', async () => {
              try {
                // Excluir o item (RID ou funcionário)
                const collectionName = tipo === 'rid' ? 'rids' : 'users';
                await deleteDoc(doc(db, collectionName, itemId));
                
                // Atualizar status da solicitação para "aprovada"
                const solicitacaoDocRef = doc(db, 'solicitacoes_exclusao', solicitacaoId);
                await updateDoc(solicitacaoDocRef, {
                  status: 'aprovada',
                  data_aprovacao: serverTimestamp()
                });
                
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                successDiv.textContent = `${tipo === 'rid' ? 'RID' : 'Funcionário'} excluído com sucesso!`;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                  successDiv.remove();
                }, 3000);
                
                confirmDiv.remove();
                loadSolicitacoes();
                if (tipo === 'rid') {
                  loadRidsTable();
                  loadDashboardData();
                } else {
                  loadFuncionariosTable();
                }
                
              } catch (error) {
                console.error('Erro ao aprovar solicitaç    o:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                errorDiv.textContent = 'Erro ao aprovar solicitaç    o';
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                  errorDiv.remove();
                }, 3000);
              }
            });
          });
        });
        
        document.querySelectorAll('.btn-rejeitar-solicitacao').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const solicitacaoId = e.currentTarget.dataset.solicitacaoId;
            
            // Criar modal de confirmação
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50';
            confirmDiv.innerHTML = `
              <div class="bg-white rounded-2xl border border-[#b0b0b0] max-w-md w-full p-6">
                <h3 class="text-lg font-semibold text-[#2c2c2c] mb-4">Confirmar Rejeição</h3>
                <p class="text-sm text-[#5a5a5a] mb-6">Tem certeza que deseja rejeitar esta solicitação de exclusão?</p>
                <div class="flex gap-3">
                  <button id="btn-cancelar-rejeicao" class="flex-1 px-4 py-2.5 rounded-xl border border-[#b0b0b0] hover:bg-[#d6d6d4] text-[#2c2c2c] font-semibold transition-colors">
                    Cancelar
                  </button>
                  <button id="btn-confirmar-rejeicao" class="flex-1 px-4 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors">
                    Rejeitar
                  </button>
                </div>
              </div>
            `;
            document.body.appendChild(confirmDiv);
            
            document.getElementById('btn-cancelar-rejeicao').addEventListener('click', () => {
              confirmDiv.remove();
            });
            
            document.getElementById('btn-confirmar-rejeicao').addEventListener('click', async () => {
              try {
                // Atualizar status da solicitação para "rejeitada"
                const solicitacaoDocRef = doc(db, 'solicitacoes_exclusao', solicitacaoId);
                await updateDoc(solicitacaoDocRef, {
                  status: 'rejeitada',
                  data_rejeicao: serverTimestamp()
                });
                
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                successDiv.textContent = 'Solicitação rejeitada com sucesso!';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                  successDiv.remove();
                }, 3000);
                
                confirmDiv.remove();
                loadSolicitacoes();
                
              } catch (error) {
                console.error('Erro ao rejeitar solicitação:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
                errorDiv.textContent = 'Erro ao rejeitar solicitação';
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                  errorDiv.remove();
                }, 3000);
              }
            });
          });
        });
      }
      
      
    } catch (error) {
      console.error('Erro ao carregar solicitações:', error);
      const container = document.getElementById('solicitacoes-container');
      container.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar solicitações</div>';
    }
    
    // Atualizar badge de notificações (sempre, independente de erros)
    try {
      const solicitacoesRef = collection(db, 'solicitacoes_exclusao');
      const qPendentes = query(solicitacoesRef, where('status', '==', 'pendente'));
      const solicitacoesSnapshot = await getDocs(qPendentes);
      
      const badgeSolicitacoes = document.getElementById('badge-solicitacoes');
      const badgeNotificacoes = document.getElementById('badge-notificacoes-admin');
      
      if (solicitacoesSnapshot.size > 0) {
        badgeSolicitacoes.textContent = solicitacoesSnapshot.size;
        badgeSolicitacoes.classList.remove('hidden');
        badgeNotificacoes.textContent = solicitacoesSnapshot.size;
        badgeNotificacoes.classList.remove('hidden');
      } else {
        badgeSolicitacoes.classList.add('hidden');
        badgeNotificacoes.classList.add('hidden');
      }
    } catch (error) {
      console.error('Erro ao atualizar badge:', error);
    }
  }

  async function loadRelatorios() {
    try {
      const tbody = document.getElementById('relatorios-table-body');
      tbody.innerHTML = '<tr><td colspan="17" class="px-4 py-8 text-center text-[#5a5a5a]">Carregando relatórios...</td></tr>';
      
      const ridsRef = collection(db, 'rids');
      const ridsSnapshot = await getDocs(ridsRef);
      
      if (ridsSnapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="17" class="px-4 py-8 text-center text-[#5a5a5a]">Nenhum RID cadastrado para relatório</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      ridsSnapshot.forEach((docSnap) => {
        const rid = docSnap.data();
        
        const dataEmissao = rid.data ? new Date(rid.data).toLocaleDateString('pt-BR') : 'N/A';
        
        let statusClass = 'bg-blue-100 text-blue-800 border-blue-300';
        const status = rid.status || 'Em Andamento';
        if (status === 'Corrigido') {
          statusClass = 'bg-green-100 text-green-800 border-green-300';
        } else if (status === 'Vencido') {
          statusClass = 'bg-red-100 text-red-800 border-red-300';
        }
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-[#ece5df] transition-colors';
        
        tr.innerHTML = `
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.unidade || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c] font-semibold">${rid.numero || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${dataEmissao}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.nome_emitente || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.tipo_contrato || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.setor || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.local_ocorrencia || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.incidente || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.origem_deteccao || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c] max-w-xs truncate">${rid.descricao || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">${rid.classificacao_risco || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c] max-w-xs truncate">${rid.acao_imediata || 'N/A'}</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">N/A</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">N/A</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">N/A</td>
          <td class="px-3 py-3 text-xs text-[#2c2c2c]">N/A</td>
          <td class="px-3 py-3 text-xs">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold border ${statusClass}">
              ${status}
            </span>
          </td>
        `;
        
        tr.style.cursor = 'pointer';
        tr.dataset.ridId = docSnap.id;
        
        tr.addEventListener('click', () => {
          abrirModalRelatorio(docSnap.id, rid);
        });
        
        tbody.appendChild(tr);
      });
      
    } catch (error) {
      console.error('Erro ao carregar relatórios:', error);
      const tbody = document.getElementById('relatorios-table-body');
      tbody.innerHTML = '<tr><td colspan="17" class="px-4 py-8 text-center text-red-600">Erro ao carregar relatórios</td></tr>';
    }
  }

  document.getElementById('btn-cadastrar-funcionario').addEventListener('click', () => {
    document.getElementById('modal-cadastro-funcionario').classList.remove('hidden');
  });

  document.getElementById('btn-fechar-modal-cadastro-func').addEventListener('click', () => {
    document.getElementById('modal-cadastro-funcionario').classList.add('hidden');
  });
  
  document.getElementById('btn-cancelar-cadastro-func').addEventListener('click', () => {
    document.getElementById('modal-cadastro-funcionario').classList.add('hidden');
  });
  
  document.getElementById('cadastro-func-cpf').addEventListener('input', (e) => {
    e.target.value = formatCPF(e.target.value);
  });
  
  document.getElementById('form-cadastro-funcionario').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const nome = document.getElementById('cadastro-func-nome').value.trim().toUpperCase();
    const cpf = document.getElementById('cadastro-func-cpf').value.replace(/\D/g, '');
    const setor = document.getElementById('cadastro-func-setor').value;
    const matricula = document.getElementById('cadastro-func-matricula').value.trim();
    const btn = document.getElementById('btn-confirmar-cadastro-func');
    const msg = document.getElementById('cadastro-func-message');
    
    if (!validarCPF(cpf)) {
      msg.textContent = 'CPF inválido';
      msg.className = 'text-xs min-h-[1.25rem] text-red-600';
      return;
    }
    
    if (!matricula || matricula.length < 3) {
      msg.textContent = 'A matrícula deve ter no mínimo 3 caracteres';
      msg.className = 'text-xs min-h-[1.25rem] text-red-600';
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Cadastrando...';
    msg.textContent = '';
    
    try {
      const usersRef = collection(db, 'users');
      const qCpf = query(usersRef, where('cpf', '==', cpf));
      const cpfSnapshot = await getDocs(qCpf);
      
      if (!cpfSnapshot.empty) {
        msg.textContent = 'CPF já cadastrado';
        msg.className = 'text-xs min-h-[1.25rem] text-red-600';
        btn.disabled = false;
        btn.textContent = 'Cadastrar';
        return;
      }
      
      const usuarioAdminLogado = currentUser;
      let adminEmail = null;
      let adminSenha = null;
      
      if (usuarioAdminLogado) {
        adminEmail = usuarioAdminLogado.email;
        const adminQuery = query(usersRef, where('uid', '==', usuarioAdminLogado.uid));
        const adminSnapshot = await getDocs(adminQuery);
        if (!adminSnapshot.empty) {
          adminSenha = adminSnapshot.docs[0].data().senha;
        }
      }
      
      isCreatingUser = true;
      
      const emailFicticio = `${cpf}@jdemito.com`;
      
      let tipo = 'funcionario';
      if (adminMestreCPFs.includes(cpf)) {
        tipo = 'admin_mestre';
      } else if (adminCPFs.includes(cpf)) {
        tipo = 'admin';
      }
      
      const userCredential = await createUserWithEmailAndPassword(auth, emailFicticio, matricula);
      const novoUID = userCredential.user.uid;
      
      await addDoc(usersRef, {
        uid: novoUID,
        nome,
        cpf,
        email: emailFicticio,
        setor,
        matricula,
        senha: matricula,
        tipo,
        data_criacao: serverTimestamp()
      });
      
      if (usuarioAdminLogado && adminEmail && adminSenha) {
        await signOut(auth);
        await signInWithEmailAndPassword(auth, adminEmail, adminSenha);
      }
      
      isCreatingUser = false;
      
      msg.textContent = 'Funcionário cadastrado com sucesso!';
      msg.className = 'text-xs min-h-[1.25rem] text-green-600';
      
      setTimeout(() => {
        document.getElementById('modal-cadastro-funcionario').classList.add('hidden');
        document.getElementById('form-cadastro-funcionario').reset();
        msg.textContent = '';
        loadFuncionariosTable();
      }, 1500);
      
    } catch (error) {
      console.error('Erro ao cadastrar funcionário:', error);
      
      isCreatingUser = false;
      
      let mensagemErro = 'Erro ao cadastrar funcionário. Tente novamente.';
      
      if (error.code === 'auth/email-already-in-use') {
        mensagemErro = 'CPF j    cadastrado no sistema';
      } else if (error.code === 'auth/weak-password') {
        mensagemErro = 'A matrícula deve ter no mínimo 6 caracteres';
      } else if (error.code === 'auth/invalid-email') {
        mensagemErro = 'CPF inválido';
      }
      
      msg.textContent = mensagemErro;
      msg.className = 'text-xs min-h-[1.25rem] text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Cadastrar';
    }
  });

  // Event listeners para modais de solicitação de exclusão
  document.getElementById('btn-fechar-modal-exclusao-rid').addEventListener('click', () => {
    document.getElementById('modal-solicitar-exclusao-rid').classList.add('hidden');
    document.getElementById('motivo-exclusao-rid').value = '';
    document.getElementById('exclusao-rid-message').textContent = '';
  });

  document.getElementById('btn-cancelar-exclusao-rid').addEventListener('click', () => {
    document.getElementById('modal-solicitar-exclusao-rid').classList.add('hidden');
    document.getElementById('motivo-exclusao-rid').value = '';
    document.getElementById('exclusao-rid-message').textContent = '';
  });

  document.getElementById('btn-confirmar-exclusao-rid').addEventListener('click', async () => {
    const motivo = document.getElementById('motivo-exclusao-rid').value.trim();
    const btn = document.getElementById('btn-confirmar-exclusao-rid');
    const msg = document.getElementById('exclusao-rid-message');
    
    if (!motivo) {
      msg.textContent = 'Por favor, descreva o motivo da exclusão';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-red-600';
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Enviando...';
    msg.textContent = '';
    
    try {
      const modal = document.getElementById('modal-solicitar-exclusao-rid');
      const ridId = modal.dataset.ridId;
      const ridNumero = modal.dataset.ridNumero;
      
      // Obter dados do solicitante
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('uid', '==', currentUser.uid));
      const querySnapshot = await getDocs(q);
      
      let nomeSolicitante = 'Desconhecido';
      if (!querySnapshot.empty) {
        nomeSolicitante = querySnapshot.docs[0].data().nome || 'Desconhecido';
      }
      
      // Criar solicitação no Firestore
      const solicitacoesRef = collection(db, 'solicitacoes_exclusao');
      await addDoc(solicitacoesRef, {
        tipo: 'rid',
        rid_id: ridId,
        rid_numero: ridNumero,
        motivo: motivo,
        solicitante: nomeSolicitante,
        solicitante_uid: currentUser.uid,
        status: 'pendente',
        data_solicitacao: serverTimestamp()
      });
      
      msg.textContent = 'Solicitação enviada com sucesso!';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-green-600';
      
      setTimeout(() => {
        document.getElementById('modal-solicitar-exclusao-rid').classList.add('hidden');
        document.getElementById('motivo-exclusao-rid').value = '';
        msg.textContent = '';
      }, 1500);
      
    } catch (error) {
      console.error('Erro ao enviar solicitação:', error);
      msg.textContent = 'Erro ao enviar solicitação. Tente novamente.';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Enviar Solicitação';
    }
  });

  document.getElementById('btn-fechar-modal-exclusao-func').addEventListener('click', () => {
    document.getElementById('modal-solicitar-exclusao-func').classList.add('hidden');
    document.getElementById('motivo-exclusao-func').value = '';
    document.getElementById('exclusao-func-message').textContent = '';
  });

  document.getElementById('btn-cancelar-exclusao-func').addEventListener('click', () => {
    document.getElementById('modal-solicitar-exclusao-func').classList.add('hidden');
    document.getElementById('motivo-exclusao-func').value = '';
    document.getElementById('exclusao-func-message').textContent = '';
  });

  document.getElementById('btn-confirmar-exclusao-func').addEventListener('click', async () => {
    const motivo = document.getElementById('motivo-exclusao-func').value.trim();
    const btn = document.getElementById('btn-confirmar-exclusao-func');
    const msg = document.getElementById('exclusao-func-message');
    
    if (!motivo) {
      msg.textContent = 'Por favor, descreva o motivo da exclusão';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-red-600';
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Enviando...';
    msg.textContent = '';
    
    try {
      const modal = document.getElementById('modal-solicitar-exclusao-func');
      const funcId = modal.dataset.funcId;
      const funcNome = modal.dataset.funcNome;
      
      // Obter dados do solicitante
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('uid', '==', currentUser.uid));
      const querySnapshot = await getDocs(q);
      
      let nomeSolicitante = 'Desconhecido';
      if (!querySnapshot.empty) {
        nomeSolicitante = querySnapshot.docs[0].data().nome || 'Desconhecido';
      }
      
      // Criar solicitação no Firestore
      const solicitacoesRef = collection(db, 'solicitacoes_exclusao');
      await addDoc(solicitacoesRef, {
        tipo: 'funcionario',
        funcionario_id: funcId,
        funcionario_nome: funcNome,
        motivo: motivo,
        solicitante: nomeSolicitante,
        solicitante_uid: currentUser.uid,
        status: 'pendente',
        data_solicitacao: serverTimestamp()
      });
      
      msg.textContent = 'Solicitação enviada com sucesso!';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-green-600';
      
      setTimeout(() => {
        document.getElementById('modal-solicitar-exclusao-func').classList.add('hidden');
        document.getElementById('motivo-exclusao-func').value = '';
        msg.textContent = '';
      }, 1500);
      
    } catch (error) {
      console.error('Erro ao enviar solicitação:', error);
      msg.textContent = 'Erro ao enviar solicitação. Tente novamente.';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Enviar Solicitação';
    }
  });

  document.getElementById('btn-imprimir').addEventListener('click', () => {
    window.print();
  });

  document.getElementById('btn-exportar').addEventListener('click', () => {
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
    successDiv.textContent = 'Funcionalidade de exportação será implementada em breve!';
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
      successDiv.remove();
    }, 3000);
  });

  function abrirModalRelatorio(ridId, ridData) {
    const status = ridData.status || 'Em Andamento';
    const risco = ridData.classificacao_risco || 'N/A';
    
    const conteudo = document.getElementById('conteudo-modal-relatorio');
    conteudo.innerHTML = `
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Unidade</h4>
          <p class="text-sm text-[#2c2c2c] cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="unidade">${ridData.unidade || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">RID Nº</h4>
          <p class="text-sm font-bold text-[#2c2c2c]">${ridData.numero || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Data Emissão</h4>
          <p class="text-sm text-[#2c2c2c] cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="data">${ridData.data || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Emitente</h4>
          <p class="text-sm text-[#2c2c2c] cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="nome_emitente">${ridData.nome_emitente || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Funcionário/Terceiro/Visitante</h4>
          <select class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" data-field="tipo_contrato">
            <option value="Funcionário" ${ridData.tipo_contrato === 'Funcionário' ? 'selected' : ''}>Funcionário</option>
            <option value="Terceiro Contratado" ${ridData.tipo_contrato === 'Terceiro Contratado' ? 'selected' : ''}>Terceiro Contratado</option>
            <option value="Terceiro Eventual" ${ridData.tipo_contrato === 'Terceiro Eventual' ? 'selected' : ''}>Terceiro Eventual</option>
            <option value="Visitante" ${ridData.tipo_contrato === 'Visitante' ? 'selected' : ''}>Visitante</option>
          </select>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Setor/Empresa</h4>
          <select class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" data-field="setor">
            <option value="ADM" ${ridData.setor === 'ADM' ? 'selected' : ''}>ADM</option>
            <option value="M. MOVEL" ${ridData.setor === 'M. MOVEL' ? 'selected' : ''}>M. MOVEL</option>
            <option value="M. FIXA" ${ridData.setor === 'M. FIXA' ? 'selected' : ''}>M. FIXA</option>
            <option value="M. ELÉTRICA" ${ridData.setor === 'M. ELÉTRICA' ? 'selected' : ''}>M. ELÉTRICA</option>
            <option value="PRODUÇÃO" ${ridData.setor === 'PRODUÇÃO' ? 'selected' : ''}>PRODUÇÃO</option>
            <option value="MINA" ${ridData.setor === 'MINA' ? 'selected' : ''}>MINA</option>
          </select>
        </div>
        
        <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Local do Incidente</h4>
          <p class="text-sm text-[#2c2c2c] cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="local_ocorrencia">${ridData.local_ocorrencia || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Gênese do Incidente</h4>
          <select class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" data-field="incidente">
            <option value="Condição de Risco" ${ridData.incidente === 'Condição de Risco' ? 'selected' : ''}>Condição de Risco</option>
            <option value="Desvio Comportamental" ${ridData.incidente === 'Desvio Comportamental' ? 'selected' : ''}>Desvio Comportamental</option>
            <option value="Dano Material" ${ridData.incidente === 'Dano Material' ? 'selected' : ''}>Dano Material</option>
            <option value="Quase acidente" ${ridData.incidente === 'Quase acidente' ? 'selected' : ''}>Quase acidente</option>
          </select>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Origem da Detecção</h4>
          <select class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" data-field="origem_deteccao">
            <option value="CSL" ${ridData.origem_deteccao === 'CSL' ? 'selected' : ''}>CSL</option>
            <option value="Inspeção programada" ${ridData.origem_deteccao === 'Inspeção programada' ? 'selected' : ''}>Inspeção programada</option>
            <option value="Inspeção não programada" ${ridData.origem_deteccao === 'Inspeção não programada' ? 'selected' : ''}>Inspeção não programada</option>
            <option value="Observação Comportamental" ${ridData.origem_deteccao === 'Observação Comportamental' ? 'selected' : ''}>Observação Comportamental</option>
            <option value="Constatação espontânea" ${ridData.origem_deteccao === 'Constatação espontânea' ? 'selected' : ''}>Constatação espontânea</option>
            <option value="Auditoria" ${ridData.origem_deteccao === 'Auditoria' ? 'selected' : ''}>Auditoria</option>
          </select>
        </div>
        
        <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Descrição</h4>
          <p class="text-sm text-[#2c2c2c] whitespace-pre-wrap cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="descricao">${ridData.descricao || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Classificação de Risco</h4>
          <select class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" data-field="classificacao_risco">
            <option value="Baixo" ${risco === 'Baixo' ? 'selected' : ''}>Baixo</option>
            <option value="Médio" ${risco === 'Médio' ? 'selected' : ''}>Médio</option>
            <option value="Alto" ${risco === 'Alto' ? 'selected' : ''}>Alto</option>
            <option value="Crítico" ${risco === 'Crítico' ? 'selected' : ''}>Crítico</option>
          </select>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Status</h4>
          <select class="w-full px-3 py-2 rounded-xl border border-[#b0b0b0] bg-white text-sm focus:border-[#ffd57a] focus:ring-2 focus:ring-[#ffd57a]/40" data-field="status">
            <option value="Em Andamento" ${status === 'Em Andamento' ? 'selected' : ''}>EM ANDAMENTO</option>
            <option value="Corrigido" ${status === 'Corrigido' ? 'selected' : ''}>CORRIGIDO</option>
            <option value="Vencido" ${status === 'Vencido' ? 'selected' : ''}>VENCIDO</option>
          </select>
        </div>
        
        <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Ação Imediata</h4>
          <p class="text-sm text-[#2c2c2c] whitespace-pre-wrap cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="acao_imediata">${ridData.acao_imediata || 'N/A'}</p>
        </div>
        
        <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Ações Corretivas</h4>
          <p class="text-sm text-[#2c2c2c] whitespace-pre-wrap cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="acoes_corretivas">${ridData.acoes_corretivas || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Responsável pelas Ações</h4>
          <p class="text-sm text-[#2c2c2c] cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="responsavel_acoes">${ridData.lider_responsavel || ridData.responsavel_acoes || 'N/A'}</p>
        </div>
        
        <div class="bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Prazo para Conclusão</h4>
          <p class="text-sm text-[#2c2c2c] cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="prazo_conclusao">${ridData.prazo_conclusao || 'N/A'}</p>
        </div>
        
        <div class="col-span-2 bg-[#ece5df] rounded-xl p-4 border border-[#b0b0b0]">
          <h4 class="text-sm font-semibold text-[#2c2c2c] mb-2">Data de Conclusão</h4>
          <p class="text-sm text-[#2c2c2c] cursor-text hover:bg-white/50 px-2 py-1 rounded transition-colors" contenteditable="true" data-field="data_conclusao">${ridData.data_conclusao || 'N/A'}</p>
        </div>
      </div>
      
      <div class="flex gap-3 pt-4 border-t border-[#b0b0b0] mt-6">
        <button id="btn-salvar-relatorio" class="flex-1 px-4 py-2.5 rounded-xl bg-[#ffd57a] hover:bg-[#ffeab8] text-[#2c2c2c] font-semibold transition-colors">
          Salvar Alterações
        </button>
      </div>
    `;
    
    // Event listener para salvar alterações
    document.getElementById('btn-salvar-relatorio').addEventListener('click', async () => {
      const btnSalvar = document.getElementById('btn-salvar-relatorio');
      btnSalvar.disabled = true;
      btnSalvar.textContent = 'Salvando...';
      
      try {
        const camposEditaveis = conteudo.querySelectorAll('[contenteditable="true"]');
        const selects = conteudo.querySelectorAll('select[data-field]');
        const dadosAtualizados = {};
        
        // Coletar valores dos campos editáveis
        camposEditaveis.forEach(campo => {
          const fieldName = campo.dataset.field;
          const valor = campo.textContent.trim();
          if (valor !== 'N/A') {
            dadosAtualizados[fieldName] = valor;
          }
        });
        
        // Coletar valores dos selects
        selects.forEach(select => {
          const fieldName = select.dataset.field;
          const valor = select.value;
          if (valor) {
            dadosAtualizados[fieldName] = valor;
          }
        });
        
        const ridDocRef = doc(db, 'rids', ridId);
        await updateDoc(ridDocRef, dadosAtualizados);
        
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
        successDiv.textContent = 'Alterações salvas com sucesso!';
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
          successDiv.remove();
          document.getElementById('modal-detalhes-relatorio').classList.add('hidden');
          loadRelatorios();
          loadDashboardData();
        }, 1500);
        
      } catch (error) {
        console.error('Erro ao salvar alterações:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
        errorDiv.textContent = 'Erro ao salvar alterações';
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
          errorDiv.remove();
        }, 3000);
        
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'Salvar Alterações';
      }
    });
    
    document.getElementById('modal-detalhes-relatorio').classList.remove('hidden');
  }

  document.getElementById('btn-fechar-modal-relatorio').addEventListener('click', () => {
    document.getElementById('modal-detalhes-relatorio').classList.add('hidden');
  });

  document.getElementById('btn-fechar-modal-ver-rid').addEventListener('click', () => {
    document.getElementById('modal-ver-rid').classList.add('hidden');
  });

  // Event listeners para modal de designação
  document.getElementById('btn-fechar-modal-designar').addEventListener('click', () => {
    document.getElementById('modal-designar-rid').classList.add('hidden');
    document.getElementById('designar-lider-select').value = '';
    document.getElementById('designar-rid-message').textContent = '';
  });

  document.getElementById('btn-cancelar-designar').addEventListener('click', () => {
    document.getElementById('modal-designar-rid').classList.add('hidden');
    document.getElementById('designar-lider-select').value = '';
    document.getElementById('designar-rid-message').textContent = '';
  });

  document.getElementById('btn-confirmar-designar').addEventListener('click', async () => {
    const liderId = document.getElementById('designar-lider-select').value;
    const btn = document.getElementById('btn-confirmar-designar');
    const msg = document.getElementById('designar-rid-message');
    
    if (!liderId) {
      msg.textContent = 'Por favor, selecione um líder';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-red-600';
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Designando...';
    msg.textContent = '';
    
    try {
      const modal = document.getElementById('modal-designar-rid');
      const ridId = modal.dataset.ridId;
      
      const selectLider = document.getElementById('designar-lider-select');
      const selectedOption = selectLider.options[selectLider.selectedIndex];
      const nomeLider = selectedOption.dataset.nome;
      
      const ridDocRef = doc(db, 'rids', ridId);
      await updateDoc(ridDocRef, {
        lider_responsavel: nomeLider,
        lider_id: liderId,
        data_designacao: serverTimestamp()
      });
      
      msg.textContent = 'RID designado com sucesso!';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-green-600';
      
      setTimeout(() => {
        document.getElementById('modal-designar-rid').classList.add('hidden');
        document.getElementById('designar-lider-select').value = '';
        msg.textContent = '';
        
        // Fechar modal de visualização e recarregar dados
        document.getElementById('modal-ver-rid').classList.add('hidden');
        loadRidsTable();
        loadDashboardData();
      }, 1500);
      
    } catch (error) {
      console.error('Erro ao designar RID:', error);
      msg.textContent = 'Erro ao designar RID. Tente novamente.';
      msg.className = 'text-xs min-h-[1.25rem] text-center text-red-600';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Designar';
    }
  });

</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a97dee0b7b55e0f',t:'MTc2NDk4MzA4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>