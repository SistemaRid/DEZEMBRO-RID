<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gerenciamento de RIDs</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDAcuwo5FZBs5013klfSMfWkQZbFjqYpbw",
      authDomain: "novo-rid-dezembro.firebaseapp.com",
      projectId: "novo-rid-dezembro",
      storageBucket: "novo-rid-dezembro.firebasestorage.app",
      messagingSenderId: "629184938088",
      appId: "1:629184938088:web:3821e7ea07897ae655fbdd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_CPFS = [
      '018.452.760-63',
      '207.954.180-00',
      '385.129.940-04',
      '512.480.310-90',
      '641.705.928-56',
      '729.814.207-80',
      '803.671.549-19',
      '918.204.367-02',
      '064.597.813-41',
      '149.238.750-69',
      '236.781.409-07',
      '387.592.641-36',
      '452.803.197-55',
      '560.914.723-88',
      '694.185.302-10'
    ];

    const DEVELOPER_CPFS = [
      '027.493.861-05',
      '194.820.573-40',
      '306.157.924-78',
      '478.620.315-62',
      '589.731.480-01'
    ];

    const ALL_ADMIN_CPFS = [...ADMIN_CPFS, ...DEVELOPER_CPFS];

    let currentUser = null;
    let currentUserData = null;
    let allRids = [];
    let currentView = 'login';

    function formatCPF(cpf) {
      const numbers = cpf.replace(/\D/g, '');
      return numbers.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function cpfToEmail(cpf) {
      const numbers = cpf.replace(/\D/g, '');
      return `${numbers}@jdemito.com`;
    }

    function validateCPF(cpf) {
      const numbers = cpf.replace(/\D/g, '');
      if (numbers.length !== 11) return false;
      if (/^(\d)\1{10}$/.test(numbers)) return false;
      return true;
    }

    function isAdmin(cpf) {
      return ALL_ADMIN_CPFS.includes(formatCPF(cpf));
    }

    function isDeveloper(cpf) {
      return DEVELOPER_CPFS.includes(formatCPF(cpf));
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform transition-transform duration-300 z-50 ${
        type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
      }`;
      toast.style.transform = 'translateX(0)';
      setTimeout(() => {
        toast.style.transform = 'translateX(400px)';
      }, 3000);
    }

    async function handleLogin(e) {
      e.preventDefault();
      const cpf = document.getElementById('loginCpf').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');

      if (!validateCPF(cpf)) {
        showToast('CPF inválido', 'error');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Entrando...';

      try {
        const email = cpfToEmail(cpf);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        
        await loadUserData(userCredential.user);
        
        document.getElementById('userName').textContent = currentUserData.name;
        document.getElementById('userRole').textContent = currentUserData.isAdmin ? 'Administrador' : 'Funcionário';
        
        updateUIForUserType();
        
        showToast('Login realizado com sucesso!', 'success');
        showDashboardView();
      } catch (error) {
        console.error('Erro no login:', error);
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          showToast('CPF ou senha incorretos', 'error');
        } else {
          showToast('Erro ao fazer login', 'error');
        }
        loginBtn.disabled = false;
        loginBtn.textContent = 'Entrar';
      }
    }

    function updateUIForUserType() {
      const isAdminUser = currentUserData && currentUserData.isAdmin;
      
      document.querySelectorAll('.admin-only').forEach(el => {
        if (isAdminUser) {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });
      
      document.querySelectorAll('.admin-section').forEach(el => {
        if (isAdminUser) {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });
      
      document.querySelectorAll('.employee-only').forEach(el => {
        if (isAdminUser) {
          el.classList.add('hidden');
        } else {
          el.classList.remove('hidden');
        }
      });
    }

    async function handleRegister(e) {
      e.preventDefault();
      const name = document.getElementById('registerName').value.toUpperCase();
      const cpf = document.getElementById('registerCpf').value;
      const sector = document.getElementById('registerSector').value;
      const password = document.getElementById('registerPassword').value;
      const registerBtn = document.getElementById('registerBtn');

      const numbers = cpf.replace(/\D/g, '');
      if (numbers.length !== 11) {
        showToast('CPF deve ter 11 dígitos', 'error');
        return;
      }

      if (password.length < 6) {
        showToast('A senha deve ter no mínimo 6 caracteres', 'error');
        return;
      }

      registerBtn.disabled = true;
      registerBtn.textContent = 'Cadastrando...';

      try {
        const email = cpfToEmail(cpf);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        
        await addDoc(collection(db, 'users'), {
          uid: userCredential.user.uid,
          name: name,
          cpf: formatCPF(cpf),
          sector: sector,
          isAdmin: isAdmin(cpf),
          createdAt: serverTimestamp()
        });

        showToast('Cadastro realizado com sucesso!', 'success');
        showLoginView();
      } catch (error) {
        console.error('Erro no cadastro:', error);
        if (error.code === 'auth/email-already-in-use') {
          showToast('CPF já cadastrado', 'error');
        } else {
          showToast('Erro ao cadastrar usuário', 'error');
        }
        registerBtn.disabled = false;
        registerBtn.textContent = 'Cadastrar';
      }
    }

    async function loadUserData(user) {
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('uid', '==', user.uid));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        currentUserData = querySnapshot.docs[0].data();
        currentUserData.id = querySnapshot.docs[0].id;
      }
    }

    async function getNextRidNumber() {
      try {
        const ridsRef = collection(db, 'rids');
        const querySnapshot = await getDocs(ridsRef);
        
        let maxNumber = -1;
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (data.ridNumber) {
            const num = parseInt(data.ridNumber);
            if (!isNaN(num) && num > maxNumber) {
              maxNumber = num;
            }
          }
        });
        
        const nextNumber = maxNumber + 1;
        return nextNumber.toString().padStart(5, '0');
      } catch (error) {
        console.error('Erro ao gerar número da RID:', error);
        return Date.now().toString();
      }
    }

    async function loadRids() {
      console.log('🔄 Iniciando carregamento de RIDs...');
      
      try {
        const ridsRef = collection(db, 'rids');
        const querySnapshot = await getDocs(ridsRef);
        
        allRids = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          
          const emitterName = data.emitterName || data.emitter || 'Não informado';
          
          let issueDate = data.issueDate;
          if (!issueDate) {
            issueDate = new Date().toISOString().split('T')[0];
          }
          
          allRids.push({ 
            id: doc.id,
            ridNumber: data.ridNumber || 'N/A',
            emitterName: emitterName,
            emitterCpf: data.emitterCpf || 'N/A',
            sector: data.sector || 'N/A',
            location: data.location || 'N/A',
            description: data.description || 'N/A',
            status: data.status || 'EM ABERTO',
            issueDate: issueDate,
            contractType: data.contractType || 'Funcionário',
            unit: data.unit || '',
            incidentType: data.incidentType || '',
            detectionOrigin: data.detectionOrigin || '',
            riskLevel: data.riskLevel || '',
            immediateAction: data.immediateAction || '',
            assignedLeader: data.assignedLeader || 'Nenhum',
            deadline: data.deadline || '',
            completionDate: data.completionDate || '',
            createdAt: data.createdAt || null
          });
        });
        
        allRids.sort((a, b) => {
          const dateA = a.createdAt ? a.createdAt.seconds : new Date(a.issueDate).getTime() / 1000;
          const dateB = b.createdAt ? b.createdAt.seconds : new Date(b.issueDate).getTime() / 1000;
          return dateB - dateA;
        });
        
        console.log('����� Total de RIDs carregadas:', allRids.length);
        
        if (currentUserData && currentUserData.isAdmin) {
          updateDashboardStats();
        }
        renderMyRidsList();
        renderRidsListView();
      } catch (error) {
        console.error('❌ Erro ao carregar RIDs:', error);
        showToast('Erro ao carregar RIDs', 'error');
        allRids = [];
      }
    }

    function updateDashboardStats() {
      console.log('Atualizando estatísticas. Total de RIDs:', allRids.length);
      
      if (!currentUserData || !currentUserData.isAdmin) {
        return;
      }
      
      const monthFilter = document.getElementById('overviewMonthFilter')?.value || 'all';
      const yearFilterValue = document.getElementById('overviewYearFilter')?.value || '';
      
      let filteredRids = allRids;
      if (monthFilter !== 'all' || yearFilterValue !== '') {
        filteredRids = allRids.filter(rid => {
          if (!rid.issueDate) return false;
          const ridDate = new Date(rid.issueDate);
          const matchMonth = monthFilter === 'all' || ridDate.getMonth() === parseInt(monthFilter);
          const matchYear = yearFilterValue === '' || ridDate.getFullYear() === parseInt(yearFilterValue);
          return matchMonth && matchYear;
        });
      }
      
      console.log('RIDs filtradas:', filteredRids.length);
      
      const totalRids = filteredRids.length;
      const totalElement = document.getElementById('totalRids');
      if (totalElement) {
        totalElement.textContent = totalRids;
        console.log('Total de RIDs atualizado:', totalRids);
      }

      const inProgress = filteredRids.filter(rid => {
        console.log('RID status:', rid.status);
        return rid.status && rid.status !== 'VENCIDO' && rid.status !== 'CORRIGIDO';
      }).length;
      const inProgressElement = document.getElementById('inProgressRids');
      if (inProgressElement) {
        inProgressElement.textContent = inProgress;
        console.log('Em andamento:', inProgress);
      }

      const overdue = filteredRids.filter(rid => 
        rid.status === 'VENCIDO'
      ).length;
      const overdueElement = document.getElementById('overdueRids');
      if (overdueElement) {
        overdueElement.textContent = overdue;
        console.log('Vencidos:', overdue);
      }

      const completed = filteredRids.filter(rid => rid.status === 'CORRIGIDO').length;
      const completedElement = document.getElementById('completedRids');
      if (completedElement) {
        completedElement.textContent = completed;
        console.log('Corrigidos:', completed);
      }

      updateWeeklyRids();
      updateRanking();
    }

    function getWeekStart() {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const diff = dayOfWeek === 0 ? 0 : dayOfWeek;
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - diff);
      weekStart.setHours(0, 0, 0, 0);
      return weekStart;
    }

    function updateWeeklyRids() {
      const weekStart = getWeekStart();
      const weeklyRids = allRids.filter(rid => {
        if (!rid.issueDate) return false;
        const ridDate = new Date(rid.issueDate);
        return ridDate >= weekStart;
      });

      const weeklyRidsList = document.getElementById('weeklyRidsList');
      
      if (!weeklyRidsList) return;
      
      if (weeklyRids.length === 0) {
        weeklyRidsList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma RID emitida esta semana</p>';
        return;
      }

      const statusColors = {
        'EM ABERTO': 'bg-yellow-100 text-yellow-800',
        'VENCIDO': 'bg-red-100 text-red-800',
        'CORRIGIDO': 'bg-green-100 text-green-800'
      };

      weeklyRidsList.innerHTML = weeklyRids.map(rid => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="viewRid('${rid.id}')">
          <div class="flex-1">
            <h4 class="font-bold text-gray-800">${rid.ridNumber || 'N/A'}</h4>
            <p class="text-sm text-gray-600">${rid.emitterName || 'N/A'} - ${rid.sector || 'N/A'}</p>
            <p class="text-sm text-gray-500">${rid.issueDate ? new Date(rid.issueDate).toLocaleDateString('pt-BR') : 'N/A'}</p>
          </div>
          <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[rid.status] || 'bg-gray-100 text-gray-800'}">${rid.status || 'N/A'}</span>
        </div>
      `).join('');
    }

    function updateRanking() {
      const monthFilter = document.getElementById('rankingMonthFilter')?.value || 'all';
      const yearFilterValue = document.getElementById('rankingYearFilter')?.value || '';
      
      let filteredRids = allRids;
      if (monthFilter !== 'all' || yearFilterValue !== '') {
        filteredRids = allRids.filter(rid => {
          const ridDate = new Date(rid.issueDate);
          const matchMonth = monthFilter === 'all' || ridDate.getMonth() === parseInt(monthFilter);
          const matchYear = yearFilterValue === '' || ridDate.getFullYear() === parseInt(yearFilterValue);
          return matchMonth && matchYear;
        });
      }
      
      const emissionCount = {};
      
      filteredRids.forEach(rid => {
        const key = `${rid.emitterName}|${rid.emitterCpf}`;
        if (!emissionCount[key]) {
          emissionCount[key] = {
            name: rid.emitterName,
            cpf: rid.emitterCpf,
            count: 0
          };
        }
        emissionCount[key].count++;
      });

      const ranking = Object.values(emissionCount)
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

      const rankingList = document.getElementById('rankingList');
      
      if (ranking.length === 0) {
        rankingList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma emissão registrada</p>';
        return;
      }

      const medalIcons = [
        '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>',
        '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>',
        '<svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>'
      ];
      const colors = [
        'bg-gradient-to-r from-yellow-400 to-yellow-500',
        'bg-gradient-to-r from-gray-300 to-gray-400',
        'bg-gradient-to-r from-orange-400 to-orange-500'
      ];

      rankingList.innerHTML = ranking.map((employee, index) => `
        <div class="${colors[index]} rounded-lg p-4 text-white shadow-md hover-zoom-card cursor-pointer">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              ${medalIcons[index]}
              <div>
                <h4 class="font-bold text-lg">${employee.name}</h4>
                <p class="text-sm opacity-90">${employee.cpf}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-3xl font-bold">${employee.count}</p>
              <p class="text-sm opacity-90">RID${employee.count > 1 ? 's' : ''}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderMyRidsList() {
      const myRidsList = document.getElementById('myRidsList');
      
      if (!myRidsList) return;
      
      if (!currentUserData || !currentUserData.cpf) {
        myRidsList.innerHTML = '<div class="text-center py-12 text-gray-500">Carregando...</div>';
        return;
      }
      
      const userCpf = (currentUserData.cpf || '').replace(/\D/g, '');
      
      const myRids = allRids.filter(rid => {
        const ridCpf = (rid.emitterCpf || '').replace(/\D/g, '');
        return ridCpf === userCpf;
      });
      
      console.log('🔍 Filtrando RIDs do usuário:', userCpf);
      console.log('📊 Total de RIDs do usuário:', myRids.length);
      console.log('📊 Total de RIDs no sistema:', allRids.length);
      
      if (myRids.length === 0) {
        myRidsList.innerHTML = '<div class="text-center py-12 text-gray-500">Você ainda não emitiu nenhuma RID</div>';
        return;
      }
      
      const statusColors = {
        'EM ABERTO': 'bg-yellow-100 text-yellow-800',
        'VENCIDO': 'bg-red-100 text-red-800',
        'CORRIGIDO': 'bg-green-100 text-green-800'
      };
      
      myRidsList.innerHTML = myRids.map(rid => {
        return `
          <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="viewRid('${rid.id}')">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-bold text-gray-800">${rid.ridNumber}</h3>
                <p class="text-sm text-gray-600">${rid.sector}</p>
              </div>
              <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColors[rid.status] || 'bg-gray-100 text-gray-800'}">${rid.status}</span>
            </div>
            <p class="text-gray-700 mb-2"><strong>Local:</strong> ${rid.location}</p>
            <p class="text-gray-700 mb-2"><strong>Descrição:</strong> ${rid.description.substring(0, 100)}${rid.description.length > 100 ? '...' : ''}</p>
            <p class="text-sm text-gray-500">Data: ${new Date(rid.issueDate).toLocaleDateString('pt-BR')}</p>
          </div>
        `;
      }).join('');
    }

    function renderRidsListView() {
      const ridsListView = document.getElementById('ridsListView');
      
      if (!ridsListView) return;
      
      const searchFilter = document.getElementById('ridsSearchFilter')?.value.toLowerCase() || '';
      const statusFilter = document.getElementById('ridsStatusFilter')?.value || 'all';
      const monthFilter = document.getElementById('ridsMonthFilter')?.value || 'all';
      const yearFilter = document.getElementById('ridsYearFilter')?.value || '';
      
      let filteredRids = allRids;
      
      if (searchFilter) {
        filteredRids = filteredRids.filter(rid => 
          rid.ridNumber.toLowerCase().includes(searchFilter) ||
          rid.emitterName.toLowerCase().includes(searchFilter)
        );
      }
      
      if (statusFilter !== 'all') {
        filteredRids = filteredRids.filter(rid => rid.status === statusFilter);
      }
      
      if (monthFilter !== 'all' || yearFilter !== '') {
        filteredRids = filteredRids.filter(rid => {
          const ridDate = new Date(rid.issueDate);
          const matchMonth = monthFilter === 'all' || ridDate.getMonth() === parseInt(monthFilter);
          const matchYear = yearFilter === '' || ridDate.getFullYear() === parseInt(yearFilter);
          return matchMonth && matchYear;
        });
      }
      
      if (filteredRids.length === 0) {
        ridsListView.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">Nenhuma RID encontrada</p>';
        return;
      }
      
      const statusColors = {
        'EM ABERTO': 'bg-yellow-100 text-yellow-800',
        'VENCIDO': 'bg-red-100 text-red-800',
        'CORRIGIDO': 'bg-green-100 text-green-800'
      };
      
      ridsListView.innerHTML = filteredRids.map(rid => `
        <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
          <div class="grid grid-cols-12 gap-4 items-center text-sm">
            <div class="col-span-1 font-semibold text-gray-800 cursor-pointer" onclick="viewRid('${rid.id}')">${rid.ridNumber}</div>
            <div class="col-span-2 text-gray-700 cursor-pointer" onclick="viewRid('${rid.id}')">${rid.emitterName}</div>
            <div class="col-span-2 text-gray-600 cursor-pointer" onclick="viewRid('${rid.id}')">${rid.sector}</div>
            <div class="col-span-2 text-gray-600 cursor-pointer" onclick="viewRid('${rid.id}')">${rid.emitterCpf}</div>
            <div class="col-span-2 text-gray-600 cursor-pointer" onclick="viewRid('${rid.id}')">${new Date(rid.issueDate).toLocaleDateString('pt-BR')}</div>
            <div class="col-span-2 cursor-pointer" onclick="viewRid('${rid.id}')">
              <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[rid.status] || 'bg-gray-100 text-gray-800'}">${rid.status}</span>
            </div>
            <div class="col-span-1 text-center">
              ${currentUserData.cpf && DEVELOPER_CPFS.includes(currentUserData.cpf) 
                ? `<button onclick="event.stopPropagation(); confirmDeleteRid('${rid.id}', '${rid.ridNumber}')" class="p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors hover-zoom-btn" title="Excluir RID">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>`
                : `<button onclick="event.stopPropagation(); openDeleteRidModal('${rid.id}', '${rid.ridNumber}')" class="p-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg transition-colors hover-zoom-btn" title="Solicitar exclusão">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                  </button>`
              }
            </div>
          </div>
        </div>
      `).join('');
    }

    async function handleCreateRid(e) {
      e.preventDefault();
      const createBtn = document.getElementById('createRidBtn');
      
      const nextRidNumber = await getNextRidNumber();
      
      const ridData = {
        ridNumber: nextRidNumber,
        emitter: document.getElementById('ridEmitter').value,
        contractType: document.querySelector('input[name="contractType"]:checked').value,
        unit: document.getElementById('ridUnit').value,
        sector: document.getElementById('ridSector').value,
        issueDate: document.getElementById('ridDate').value,
        incidentType: document.querySelector('input[name="incidentType"]:checked').value,
        detectionOrigin: document.getElementById('ridDetectionOrigin').value,
        location: document.getElementById('ridLocation').value,
        description: document.getElementById('ridDescription').value,
        riskLevel: document.querySelector('input[name="riskLevel"]:checked').value,
        immediateAction: document.getElementById('ridImmediateAction').value,
        status: document.querySelector('input[name="ridStatus"]:checked').value,
        assignedLeader: document.getElementById('ridLeader').value,
        emitterCpf: currentUserData.cpf,
        emitterName: currentUserData.name,
        createdAt: serverTimestamp()
      };

      createBtn.disabled = true;
      createBtn.textContent = 'Salvando...';

      try {
        await addDoc(collection(db, 'rids'), ridData);
        showToast('RID criada com sucesso!', 'success');
        showDashboardView();
        await loadRids();
      } catch (error) {
        console.error('Erro ao criar RID:', error);
        showToast('Erro ao criar RID', 'error');
        createBtn.disabled = false;
        createBtn.textContent = 'Criar RID';
      }
    }

    async function viewRid(ridId) {
      const rid = allRids.find(r => r.id === ridId);
      if (!rid) return;

      currentRidIdForDesignate = ridId;

      document.getElementById('detailRidNumber').value = rid.ridNumber || '';
      document.getElementById('detailEmitter').value = `${rid.emitterName} (${rid.emitterCpf})`;
      document.getElementById('detailContractType').value = rid.contractType || 'Funcionário';
      document.getElementById('detailUnit').value = rid.unit || '';
      document.getElementById('detailSector').value = rid.sector || '';
      document.getElementById('detailDate').value = rid.issueDate || '';
      document.getElementById('detailIncidentType').value = rid.incidentType || '';
      document.getElementById('detailDetectionOrigin').value = rid.detectionOrigin || '';
      document.getElementById('detailLocation').value = rid.location || '';
      document.getElementById('detailDescription').value = rid.description || '';
      document.getElementById('detailRiskLevel').value = rid.riskLevel || '';
      document.getElementById('detailImmediateAction').value = rid.immediateAction || '';
      document.getElementById('detailStatus').value = rid.status || 'EM ABERTO';
      document.getElementById('detailAssignedLeader').value = rid.assignedLeader || 'Nenhum';
      document.getElementById('detailDeadline').value = rid.deadline || '';
      document.getElementById('detailCompletionDate').value = rid.completionDate || '';

      // Bloquear edição para funcionários (não administradores)
      const isAdminUser = currentUserData && currentUserData.isAdmin;
      const allInputs = document.querySelectorAll('#ridDetailsForm input:not([readonly]), #ridDetailsForm select, #ridDetailsForm textarea');
      
      allInputs.forEach(input => {
        if (!isAdminUser) {
          input.setAttribute('readonly', 'true');
          input.setAttribute('disabled', 'true');
          input.classList.add('bg-gray-100', 'cursor-not-allowed');
        } else {
          input.removeAttribute('readonly');
          input.removeAttribute('disabled');
          input.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
      });

      // Manter o campo de emitente sempre readonly
      document.getElementById('detailEmitter').setAttribute('readonly', 'true');
      document.getElementById('detailEmitter').classList.add('bg-gray-100', 'cursor-not-allowed');
      
      // Manter o campo de número da RID sempre readonly
      document.getElementById('detailRidNumber').setAttribute('readonly', 'true');
      document.getElementById('detailRidNumber').classList.add('bg-gray-100', 'cursor-not-allowed');

      // Mostrar/ocultar botões de ação baseado no tipo de usuário
      const saveButton = document.getElementById('saveRidDetailsBtn');
      const designateButton = document.querySelector('button[onclick="openDesignateModalFromDetails()"]');
      
      if (!isAdminUser) {
        saveButton.classList.add('hidden');
        designateButton.classList.add('hidden');
      } else {
        saveButton.classList.remove('hidden');
        designateButton.classList.remove('hidden');
      }

      document.getElementById('ridDetailsModal').classList.remove('hidden');
    }

    function closeRidDetailsModal() {
      document.getElementById('ridDetailsModal').classList.add('hidden');
    }

    async function saveRidDetails() {
      const saveBtn = document.getElementById('saveRidDetailsBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Salvando...';

      try {
        const ridRef = doc(db, 'rids', currentRidIdForDesignate);
        await updateDoc(ridRef, {
          contractType: document.getElementById('detailContractType').value,
          unit: document.getElementById('detailUnit').value,
          sector: document.getElementById('detailSector').value,
          issueDate: document.getElementById('detailDate').value,
          incidentType: document.getElementById('detailIncidentType').value,
          detectionOrigin: document.getElementById('detailDetectionOrigin').value,
          location: document.getElementById('detailLocation').value,
          description: document.getElementById('detailDescription').value,
          riskLevel: document.getElementById('detailRiskLevel').value,
          immediateAction: document.getElementById('detailImmediateAction').value,
          status: document.getElementById('detailStatus').value,
          deadline: document.getElementById('detailDeadline').value,
          completionDate: document.getElementById('detailCompletionDate').value
        });

        showToast('RID atualizada com sucesso!', 'success');
        await loadRids();
        closeRidDetailsModal();
      } catch (error) {
        console.error('Erro ao atualizar RID:', error);
        showToast('Erro ao atualizar RID', 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Salvar Alterações';
      }
    }

    async function openDesignateModalFromDetails() {
      closeRidDetailsModal();
      await openDesignateModal();
    }

    async function updateRidStatus(ridId) {
      const newStatus = document.getElementById('editStatus').value;
      const completionDate = document.getElementById('editCompletionDate').value;
      const updateBtn = document.getElementById('updateStatusBtn');

      updateBtn.disabled = true;
      updateBtn.textContent = 'Atualizando...';

      try {
        const ridRef = doc(db, 'rids', ridId);
        await updateDoc(ridRef, {
          status: newStatus,
          completionDate: completionDate || ''
        });

        showToast('Status atualizado com sucesso!', 'success');
        await loadRids();
        showDashboardView();
      } catch (error) {
        console.error('Erro ao atualizar status:', error);
        showToast('Erro ao atualizar status', 'error');
        updateBtn.disabled = false;
        updateBtn.textContent = 'Atualizar Status';
      }
    }

    function showView(viewName) {
      document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
      document.getElementById(viewName).classList.remove('hidden');
      currentView = viewName;
    }

    function showLoginView() {
      showView('login');
      document.getElementById('loginForm').reset();
      
      const loginBtn = document.getElementById('loginBtn');
      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Entrar';
      }
    }

    function showRegisterView() {
      showView('register');
      document.getElementById('registerForm').reset();
    }

    function showDashboardView() {
      showView('dashboard');
      loadRids();
    }

    async function showNewRidView() {
      showView('newRid');
      document.getElementById('ridForm').reset();
      document.getElementById('ridDate').valueAsDate = new Date();
      document.getElementById('ridSector').value = currentUserData.sector;
      document.getElementById('ridEmitter').value = currentUserData.name;
      
      await loadAdminsList();
    }
    
    async function loadAdminsList() {
      try {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('isAdmin', '==', true));
        const querySnapshot = await getDocs(q);
        
        const leaderSelect = document.getElementById('ridLeader');
        leaderSelect.innerHTML = '<option value="">Selecione um líder</option>';
        
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          const option = document.createElement('option');
          option.value = userData.cpf;
          option.textContent = `${userData.name} - ${userData.sector}`;
          leaderSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar administradores:', error);
        showToast('Erro ao carregar lista de administradores', 'error');
      }
    }

    async function handleLogout() {
      try {
        await signOut(auth);
        showToast('Logout realizado com sucesso!', 'success');
        showLoginView();
      } catch (error) {
        console.error('Erro no logout:', error);
        showToast('Erro ao fazer logout', 'error');
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData(user);
        
        document.getElementById('userName').textContent = currentUserData.name;
        document.getElementById('userRole').textContent = currentUserData.isAdmin ? 'Administrador' : 'Funcionário';
        
        updateUIForUserType();
        
        if (currentView === 'login' || currentView === 'register') {
          showDashboardView();
        }
      } else {
        currentUser = null;
        currentUserData = null;
        if (currentView !== 'login' && currentView !== 'register') {
          showLoginView();
        }
      }
    });

    let currentMenuTab = 'dashboard';

    function setActiveMenuTab(tabName) {
      currentMenuTab = tabName;
      
      document.querySelectorAll('.menu-tab').forEach(btn => {
        btn.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
        btn.classList.add('text-gray-600', 'border-transparent');
      });
      
      const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
      if (activeBtn) {
        activeBtn.classList.remove('text-gray-600', 'border-transparent');
        activeBtn.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
      }
      
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('hidden');
      });
      
      const activeSection = document.getElementById(`${tabName}Content`);
      if (activeSection) {
        activeSection.classList.remove('hidden');
      }
      
      if (tabName === 'rids') {
        renderRidsListView();
      }
    }

    function showMenuTab(tabName) {
      setActiveMenuTab(tabName);
      
      if (tabName === 'funcionarios') {
        loadEmployeesList();
      }
      
      if (tabName === 'solicitacoes') {
        loadDeletionRequests();
      }
    }
    
    async function loadDeletionRequests() {
      const ridRequestsList = document.getElementById('ridRequestsList');
      const employeeRequestsList = document.getElementById('employeeRequestsList');
      
      if (!ridRequestsList || !employeeRequestsList) return;
      
      try {
        const requestsRef = collection(db, 'deletion_requests');
        const querySnapshot = await getDocs(requestsRef);
        
        const ridRequests = [];
        const employeeRequests = [];
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const request = {
            id: doc.id,
            ...data,
            createdAt: data.createdAt
          };
          
          if (data.type === 'rid') {
            ridRequests.push(request);
          } else if (data.type === 'employee') {
            employeeRequests.push(request);
          }
        });
        
        ridRequests.sort((a, b) => {
          if (!a.createdAt) return 1;
          if (!b.createdAt) return -1;
          return b.createdAt.seconds - a.createdAt.seconds;
        });
        
        employeeRequests.sort((a, b) => {
          if (!a.createdAt) return 1;
          if (!b.createdAt) return -1;
          return b.createdAt.seconds - a.createdAt.seconds;
        });
        
        if (ridRequests.length === 0) {
          ridRequestsList.innerHTML = `
            <div class="p-8 text-center text-gray-500">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
              </svg>
              <p>Nenhuma solicitação de exclusão de RID</p>
            </div>
          `;
        } else {
          ridRequestsList.innerHTML = ridRequests.map(request => renderRequestCard(request, 'rid')).join('');
        }
        
        if (employeeRequests.length === 0) {
          employeeRequestsList.innerHTML = `
            <div class="p-8 text-center text-gray-500">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
              </svg>
              <p>Nenhuma solicitação de exclusão de funcionário</p>
            </div>
          `;
        } else {
          employeeRequestsList.innerHTML = employeeRequests.map(request => renderRequestCard(request, 'employee')).join('');
        }
      } catch (error) {
        console.error('Erro ao carregar solicitações:', error);
        ridRequestsList.innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar solicitações</p>';
        employeeRequestsList.innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar solicitações</p>';
      }
    }
    
    function renderRequestCard(request, type) {
      const isDeveloper = currentUserData.cpf && DEVELOPER_CPFS.includes(currentUserData.cpf);
      const createdDate = request.createdAt 
        ? new Date(request.createdAt.seconds * 1000).toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          })
        : 'N/A';
      
      const statusColors = {
        'PENDENTE': 'bg-yellow-100 text-yellow-800',
        'ACEITA': 'bg-green-100 text-green-800',
        'REJEITADA': 'bg-red-100 text-red-800'
      };
      
      const statusColor = statusColors[request.status] || 'bg-gray-100 text-gray-800';
      
      const targetInfo = type === 'rid' 
        ? `<p class="text-sm text-gray-600"><strong>RID:</strong> ${request.targetNumber}</p>
           <p class="text-sm text-gray-600"><strong>Emitente:</strong> ${request.targetEmitter}</p>
           <p class="text-sm text-gray-600"><strong>Setor:</strong> ${request.targetSector}</p>`
        : `<p class="text-sm text-gray-600"><strong>Nome:</strong> ${request.targetName}</p>
           <p class="text-sm text-gray-600"><strong>CPF:</strong> ${request.targetCpf}</p>
           <p class="text-sm text-gray-600"><strong>Setor:</strong> ${request.targetSector}</p>`;
      
      const actionButtons = isDeveloper && request.status === 'PENDENTE'
        ? `<div class="flex gap-2 mt-3">
             <button onclick="acceptRequest('${request.id}', '${type}')" class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-colors hover-zoom-btn">
               Aceitar
             </button>
             <button onclick="rejectRequest('${request.id}')" class="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition-colors hover-zoom-btn">
               Rejeitar
             </button>
           </div>`
        : '';
      
      return `
        <div class="p-4 hover:bg-gray-50 transition-colors">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              ${targetInfo}
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">${request.status}</span>
          </div>
          <p class="text-sm text-gray-700 mb-2"><strong>Motivo:</strong> ${request.reason}</p>
          <p class="text-xs text-gray-500"><strong>Solicitado por:</strong> ${request.requestedBy} (${request.requestedByCpf})</p>
          <p class="text-xs text-gray-500"><strong>Data:</strong> ${createdDate}</p>
          ${actionButtons}
        </div>
      `;
    }
    
    async function acceptRequest(requestId, type) {
      try {
        const requestDoc = await getDocs(query(collection(db, 'deletion_requests'), where('__name__', '==', requestId)));
        
        if (requestDoc.empty) {
          showToast('Solicitação não encontrada', 'error');
          return;
        }
        
        const requestData = requestDoc.docs[0].data();
        
        await updateDoc(doc(db, 'deletion_requests', requestId), {
          status: 'ACEITA'
        });
        
        if (type === 'rid') {
          await deleteDoc(doc(db, 'rids', requestData.targetId));
          showToast('RID excluída com sucesso!', 'success');
          await loadRids();
        } else if (type === 'employee') {
          await deleteDoc(doc(db, 'users', requestData.targetId));
          showToast('Funcionário excluído com sucesso!', 'success');
          await loadEmployeesList();
        }
        
        await loadDeletionRequests();
        
        console.log('✅ SOLICITAÇ��O ACEITA E EXECUTADA');
        console.log('Tipo:', type);
        console.log('ID:', requestData.targetId);
        console.log('Aceita por:', currentUserData.name);
      } catch (error) {
        console.error('Erro ao aceitar solicitação:', error);
        showToast('Erro ao aceitar solicitação', 'error');
      }
    }
    
    async function rejectRequest(requestId) {
      try {
        await updateDoc(doc(db, 'deletion_requests', requestId), {
          status: 'REJEITADA'
        });
        
        showToast('Solicitação rejeitada', 'success');
        await loadDeletionRequests();
        
        console.log('❌ SOLICITAÇÃO REJEITADA');
        console.log('ID da solicitação:', requestId);
        console.log('Rejeitada por:', currentUserData.name);
      } catch (error) {
        console.error('Erro ao rejeitar solicitação:', error);
        showToast('Erro ao rejeitar solicitação', 'error');
      }
    }
    
    window.loadDeletionRequests = loadDeletionRequests;
    window.acceptRequest = acceptRequest;
    window.rejectRequest = rejectRequest;
    
    async function loadEmployeesList() {
      const employeesList = document.getElementById('employeesList');
      
      if (!employeesList) return;
      
      try {
        const usersRef = collection(db, 'users');
        const querySnapshot = await getDocs(usersRef);
        
        const employees = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          employees.push({
            id: doc.id,
            name: data.name || 'N/A',
            cpf: data.cpf || 'N/A',
            sector: data.sector || 'N/A',
            isAdmin: data.isAdmin || false,
            createdAt: data.createdAt
          });
        });
        
        employees.sort((a, b) => {
          if (!a.createdAt) return 1;
          if (!b.createdAt) return -1;
          return b.createdAt.seconds - a.createdAt.seconds;
        });
        
        if (employees.length === 0) {
          employeesList.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-12">Nenhum funcionário cadastrado</p>';
          return;
        }
        
        employeesList.innerHTML = employees.map(employee => {
          const createdDate = employee.createdAt 
            ? new Date(employee.createdAt.seconds * 1000).toLocaleDateString('pt-BR')
            : 'N/A';
          
          const accountType = employee.isAdmin ? 'Administrador' : 'Funcionário';
          const accountBadge = employee.isAdmin 
            ? 'bg-purple-100 text-purple-800' 
            : 'bg-blue-100 text-blue-800';
          
          return `
            <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
              <div class="grid grid-cols-12 gap-4 items-center text-sm">
                <div class="col-span-3 font-semibold text-gray-800">${employee.name}</div>
                <div class="col-span-2 text-gray-700">${employee.sector}</div>
                <div class="col-span-2 text-gray-600">${employee.cpf}</div>
                <div class="col-span-2 text-gray-600">${createdDate}</div>
                <div class="col-span-2">
                  <span class="px-3 py-1 rounded-full text-xs font-semibold ${accountBadge}">${accountType}</span>
                </div>
                <div class="col-span-1 text-center">
                  ${currentUserData.cpf && DEVELOPER_CPFS.includes(currentUserData.cpf) 
                    ? `<button onclick="confirmDeleteEmployee('${employee.id}', '${employee.name}')" class="p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors hover-zoom-btn" title="Excluir funcionário">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>`
                    : `<button onclick="openDeleteEmployeeModal('${employee.id}', '${employee.name}')" class="p-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg transition-colors hover-zoom-btn" title="Solicitar exclusão">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                      </button>`
                  }
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Erro ao carregar funcionários:', error);
        employeesList.innerHTML = '<p class="text-red-500 text-center py-8">Erro ao carregar funcionários</p>';
      }
    }
    
    function viewEmployee(employeeId) {
      showToast('Visualização de funcionário em desenvolvimento', 'info');
    }
    
    window.loadEmployeesList = loadEmployeesList;
    window.viewEmployee = viewEmployee;

    function toggleOverviewFilters() {
      const panel = document.getElementById('overviewFiltersPanel');
      panel.classList.toggle('hidden');
    }

    function toggleRankingFilters() {
      const panel = document.getElementById('rankingFiltersPanel');
      panel.classList.toggle('hidden');
    }

    function toggleRidsFilters() {
      const panel = document.getElementById('ridsFiltersPanel');
      panel.classList.toggle('hidden');
    }

    function applyRidsFilters() {
      renderRidsListView();
    }

    function clearRidsFilters() {
      document.getElementById('ridsSearchFilter').value = '';
      document.getElementById('ridsStatusFilter').value = 'all';
      document.getElementById('ridsMonthFilter').value = 'all';
      document.getElementById('ridsYearFilter').value = '';
      renderRidsListView();
    }

    function clearOverviewFilters() {
      document.getElementById('overviewMonthFilter').value = 'all';
      document.getElementById('overviewYearFilter').value = '';
      updateDashboardStats();
    }

    function clearRankingFilters() {
      document.getElementById('rankingMonthFilter').value = 'all';
      document.getElementById('rankingYearFilter').value = '';
      updateRanking();
    }

    let currentRidIdForDesignate = null;

    async function openDesignateModal() {
      const modal = document.getElementById('designateModal');
      modal.classList.remove('hidden');
      
      try {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('isAdmin', '==', true));
        const querySnapshot = await getDocs(q);
        
        const leaderSelect = document.getElementById('designateLeader');
        leaderSelect.innerHTML = '<option value="">Selecione um administrador</option>';
        
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          const option = document.createElement('option');
          option.value = userData.cpf;
          option.textContent = `${userData.name} - ${userData.sector}`;
          leaderSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar administradores:', error);
        showToast('Erro ao carregar lista de administradores', 'error');
      }
    }

    function closeDesignateModal() {
      const modal = document.getElementById('designateModal');
      modal.classList.add('hidden');
      document.getElementById('designateForm').reset();
    }

    async function handleDesignate(e) {
      e.preventDefault();
      const designateBtn = document.getElementById('designateBtn');
      
      const leaderCpf = document.getElementById('designateLeader').value;
      const observation = document.getElementById('designateObservation').value;
      const deadline = document.getElementById('designateDeadline').value;
      
      designateBtn.disabled = true;
      designateBtn.textContent = 'Designando...';

      try {
        const ridId = currentRidIdForDesignate;
        if (!ridId) {
          showToast('Erro: RID não identificada', 'error');
          return;
        }

        const ridRef = doc(db, 'rids', ridId);
        await updateDoc(ridRef, {
          assignedLeader: leaderCpf,
          designateObservation: observation,
          deadline: deadline,
          status: 'VENCIDO'
        });

        showToast('RID designada com sucesso!', 'success');
        closeDesignateModal();
        await loadRids();
        showDashboardView();
      } catch (error) {
        console.error('Erro ao designar RID:', error);
        showToast('Erro ao designar RID', 'error');
        designateBtn.disabled = false;
        designateBtn.textContent = 'Designar';
      }
    }

    document.addEventListener('click', (e) => {
      const overviewPanel = document.getElementById('overviewFiltersPanel');
      const rankingPanel = document.getElementById('rankingFiltersPanel');
      const ridsPanel = document.getElementById('ridsFiltersPanel');
      
      if (overviewPanel && !overviewPanel.contains(e.target) && !e.target.closest('button[onclick="toggleOverviewFilters()"]')) {
        overviewPanel.classList.add('hidden');
      }
      
      if (rankingPanel && !rankingPanel.contains(e.target) && !e.target.closest('button[onclick="toggleRankingFilters()"]')) {
        rankingPanel.classList.add('hidden');
      }
      
      if (ridsPanel && !ridsPanel.contains(e.target) && !e.target.closest('button[onclick="toggleRidsFilters()"]')) {
        ridsPanel.classList.add('hidden');
      }
    });

    window.handleLogin = handleLogin;
    window.handleRegister = handleRegister;
    window.handleCreateRid = handleCreateRid;
    window.showLoginView = showLoginView;
    window.showRegisterView = showRegisterView;
    window.showDashboardView = showDashboardView;
    window.showNewRidView = showNewRidView;
    window.handleLogout = handleLogout;
    window.viewRid = viewRid;
    window.showMenuTab = showMenuTab;
    window.toggleOverviewFilters = toggleOverviewFilters;
    window.toggleRankingFilters = toggleRankingFilters;
    window.toggleRidsFilters = toggleRidsFilters;
    window.applyRidsFilters = applyRidsFilters;
    window.clearRidsFilters = clearRidsFilters;
    window.clearOverviewFilters = clearOverviewFilters;
    window.clearRankingFilters = clearRankingFilters;
    window.openDesignateModal = openDesignateModal;
    window.closeDesignateModal = closeDesignateModal;
    window.handleDesignate = handleDesignate;

    function openEmployeeModal() {
      const modal = document.getElementById('employeeModal');
      modal.classList.remove('hidden');
    }

    function closeEmployeeModal() {
      const modal = document.getElementById('employeeModal');
      modal.classList.add('hidden');
      document.getElementById('employeeForm').reset();
    }

    async function handleEmployeeRegister(e) {
      e.preventDefault();
      const registerBtn = document.getElementById('employeeRegisterBtn');
      
      const name = document.getElementById('employeeName').value.toUpperCase();
      const cpf = document.getElementById('employeeCpf').value;
      const sector = document.getElementById('employeeSector').value;
      const matricula = document.getElementById('employeeMatricula').value;

      if (!validateCPF(cpf)) {
        showToast('CPF inv��lido', 'error');
        return;
      }

      if (matricula.length < 6) {
        showToast('A matrícula deve ter no mínimo 6 caracteres', 'error');
        return;
      }

      registerBtn.disabled = true;
      registerBtn.textContent = 'Cadastrando...';

      try {
        const email = cpfToEmail(cpf);
        const userCredential = await createUserWithEmailAndPassword(auth, email, matricula);
        
        await addDoc(collection(db, 'users'), {
          uid: userCredential.user.uid,
          name: name,
          cpf: formatCPF(cpf),
          sector: sector,
          isAdmin: isAdmin(cpf),
          createdAt: serverTimestamp()
        });

        showToast('Funcionário cadastrado com sucesso!', 'success');
        closeEmployeeModal();
      } catch (error) {
        console.error('Erro no cadastro:', error);
        if (error.code === 'auth/email-already-in-use') {
          showToast('CPF já cadastrado', 'error');
        } else {
          showToast('Erro ao cadastrar funcionário', 'error');
        }
        registerBtn.disabled = false;
        registerBtn.textContent = 'Cadastrar';
      }
    }

    window.openEmployeeModal = openEmployeeModal;
    window.closeEmployeeModal = closeEmployeeModal;
    window.handleEmployeeRegister = handleEmployeeRegister;

    let currentDeleteEmployeeId = null;

    function openDeleteEmployeeModal(employeeId, employeeName) {
      currentDeleteEmployeeId = employeeId;
      document.getElementById('deleteEmployeeName').textContent = employeeName;
      document.getElementById('deleteReason').value = '';
      document.getElementById('deleteEmployeeModal').classList.remove('hidden');
    }

    function closeDeleteEmployeeModal() {
      currentDeleteEmployeeId = null;
      document.getElementById('deleteEmployeeModal').classList.add('hidden');
    }

    async function submitDeleteRequest() {
      const reason = document.getElementById('deleteReason').value.trim();
      
      if (!reason) {
        showToast('Por favor, informe o motivo da exclusão', 'error');
        return;
      }

      try {
        const usersRef = collection(db, 'users');
        const querySnapshot = await getDocs(query(usersRef, where('__name__', '==', currentDeleteEmployeeId)));
        
        if (querySnapshot.empty) {
          showToast('Funcionário não encontrado', 'error');
          return;
        }
        
        const employeeData = querySnapshot.docs[0].data();
        
        await addDoc(collection(db, 'deletion_requests'), {
          type: 'employee',
          targetId: currentDeleteEmployeeId,
          targetName: employeeData.name,
          targetCpf: employeeData.cpf,
          targetSector: employeeData.sector,
          reason: reason,
          requestedBy: currentUserData.name,
          requestedByCpf: currentUserData.cpf,
          status: 'PENDENTE',
          createdAt: serverTimestamp()
        });

        showToast('Solicitação enviada com sucesso!', 'success');
        closeDeleteEmployeeModal();
        
        console.log('🚨 SOLICITAÇÃO DE EXCLUSÃO DE FUNCIONÁRIO');
        console.log('ID do Funcionário:', currentDeleteEmployeeId);
        console.log('Nome:', employeeData.name);
        console.log('Motivo:', reason);
        console.log('Solicitado por:', currentUserData.name);
        console.log('Data:', new Date().toLocaleString('pt-BR'));
      } catch (error) {
        console.error('Erro ao enviar solicitação:', error);
        showToast('Erro ao enviar solicitação', 'error');
      }
    }

    window.openDeleteEmployeeModal = openDeleteEmployeeModal;
    window.closeDeleteEmployeeModal = closeDeleteEmployeeModal;
    window.submitDeleteRequest = submitDeleteRequest;

    let currentConfirmDeleteEmployeeId = null;

    function confirmDeleteEmployee(employeeId, employeeName) {
      currentConfirmDeleteEmployeeId = employeeId;
      document.getElementById('confirmDeleteEmployeeName').textContent = employeeName;
      document.getElementById('confirmDeleteModal').classList.remove('hidden');
    }

    function closeConfirmDeleteModal() {
      currentConfirmDeleteEmployeeId = null;
      document.getElementById('confirmDeleteModal').classList.add('hidden');
    }

    async function executeDeleteEmployee() {
      if (!currentConfirmDeleteEmployeeId) return;
      
      const executeBtn = document.getElementById('executeDeleteBtn');
      executeBtn.disabled = true;
      executeBtn.textContent = 'Excluindo...';

      try {
        const userDoc = doc(db, 'users', currentConfirmDeleteEmployeeId);
        const userSnapshot = await getDocs(query(collection(db, 'users'), where('__name__', '==', currentConfirmDeleteEmployeeId)));
        
        if (userSnapshot.empty) {
          showToast('Funcionário não encontrado', 'error');
          executeBtn.disabled = false;
          executeBtn.textContent = 'Confirmar Exclusão';
          return;
        }

        const userData = userSnapshot.docs[0].data();
        
        await deleteDoc(doc(db, 'users', currentConfirmDeleteEmployeeId));
        
        showToast('Funcionário exclu��do com sucesso!', 'success');
        closeConfirmDeleteModal();
        
        await loadEmployeesList();
        
        console.log('✅ EXCLUSÃO REALIZADA PELO DESENVOLVEDOR');
        console.log('ID do Funcionário:', currentConfirmDeleteEmployeeId);
        console.log('Nome:', userData.name);
        console.log('CPF:', userData.cpf);
        console.log('Excluído por:', currentUserData.name);
        console.log('Data:', new Date().toLocaleString('pt-BR'));
      } catch (error) {
        console.error('Erro ao excluir funcionário:', error);
        showToast('Erro ao excluir funcionário. Veja o console (F12)', 'error');
        executeBtn.disabled = false;
        executeBtn.textContent = 'Confirmar Exclusão';
      }
    }

    window.confirmDeleteEmployee = confirmDeleteEmployee;
    window.closeConfirmDeleteModal = closeConfirmDeleteModal;
    window.executeDeleteEmployee = executeDeleteEmployee;

    function toggleUserMenu() {
      const menu = document.getElementById('userMenu');
      menu.classList.toggle('hidden');
    }

    document.addEventListener('click', (e) => {
      const userMenu = document.getElementById('userMenu');
      const userMenuButton = e.target.closest('button[onclick="toggleUserMenu()"]');
      
      if (userMenu && !userMenu.contains(e.target) && !userMenuButton) {
        userMenu.classList.add('hidden');
      }
      
      const notificationsMenu = document.getElementById('notificationsMenu');
      const notificationsButton = e.target.closest('button[onclick="toggleNotifications()"]');
      
      if (notificationsMenu && !notificationsMenu.contains(e.target) && !notificationsButton) {
        notificationsMenu.classList.add('hidden');
      }
    });

    window.toggleUserMenu = toggleUserMenu;

    let reportFilteredRids = [];

    function generateReport() {
      const statusFilter = document.getElementById('reportStatusFilter').value;
      const sectorFilter = document.getElementById('reportSectorFilter').value;
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;

      reportFilteredRids = allRids.filter(rid => {
        let matches = true;

        if (statusFilter !== 'all' && rid.status !== statusFilter) {
          matches = false;
        }

        if (sectorFilter !== 'all' && rid.sector !== sectorFilter) {
          matches = false;
        }

        if (startDate && rid.issueDate && new Date(rid.issueDate) < new Date(startDate)) {
          matches = false;
        }

        if (endDate && rid.issueDate && new Date(rid.issueDate) > new Date(endDate)) {
          matches = false;
        }

        return matches;
      });

      updateReportStats();
      renderReportTable();

      document.getElementById('reportStats').classList.remove('hidden');
      document.getElementById('reportTableContainer').classList.remove('hidden');

      showToast(`Relatório gerado com ${reportFilteredRids.length} RID(s)`, 'success');
    }

    function updateReportStats() {
      const total = reportFilteredRids.length;
      const open = reportFilteredRids.filter(rid => rid.status === 'EM ABERTO').length;
      const overdue = reportFilteredRids.filter(rid => rid.status === 'VENCIDO').length;
      const completed = reportFilteredRids.filter(rid => rid.status === 'CORRIGIDO').length;

      document.getElementById('reportTotalRids').textContent = total;
      document.getElementById('reportOpenRids').textContent = open;
      document.getElementById('reportOverdueRids').textContent = overdue;
      document.getElementById('reportCompletedRids').textContent = completed;
    }

    function renderReportTable() {
      const tbody = document.getElementById('reportTableBody');

      if (reportFilteredRids.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nenhuma RID encontrada com os filtros selecionados</td></tr>';
        return;
      }

      const statusColors = {
        'EM ABERTO': 'bg-yellow-100 text-yellow-800',
        'VENCIDO': 'bg-red-100 text-red-800',
        'CORRIGIDO': 'bg-green-100 text-green-800'
      };

      const riskColors = {
        'Baixo': 'bg-blue-100 text-blue-800',
        'Médio': 'bg-yellow-100 text-yellow-800',
        'Alto': 'bg-orange-100 text-orange-800',
        'Crítico': 'bg-red-100 text-red-800'
      };

      tbody.innerHTML = reportFilteredRids.map(rid => `
        <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewRid('${rid.id}')">
          <td class="px-4 py-3 text-sm font-semibold text-gray-800">${rid.ridNumber}</td>
          <td class="px-4 py-3 text-sm text-gray-700">${rid.emitterName}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${rid.sector}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${new Date(rid.issueDate).toLocaleDateString('pt-BR')}</td>
          <td class="px-4 py-3 text-sm">
            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColors[rid.status] || 'bg-gray-100 text-gray-800'}">${rid.status}</span>
          </td>
          <td class="px-4 py-3 text-sm">
            <span class="px-2 py-1 rounded-full text-xs font-semibold ${riskColors[rid.riskLevel] || 'bg-gray-100 text-gray-800'}">${rid.riskLevel || 'N/A'}</span>
          </td>
          <td class="px-4 py-3 text-sm text-gray-600">${rid.location}</td>
        </tr>
      `).join('');
    }

    function exportToCSV() {
      if (reportFilteredRids.length === 0) {
        showToast('Gere um relatório antes de exportar', 'error');
        return;
      }

      const headers = ['ID', 'Emitente', 'CPF', 'Setor', 'Data', 'Status', 'Tipo de Incidente', 'Nível de Risco', 'Local', 'Descrição'];
      const csvContent = [
        headers.join(','),
        ...reportFilteredRids.map(rid => [
          rid.ridNumber,
          rid.emitterName,
          rid.emitterCpf,
          rid.sector,
          new Date(rid.issueDate).toLocaleDateString('pt-BR'),
          rid.status,
          rid.incidentType || '',
          rid.riskLevel || '',
          rid.location,
          `"${rid.description.replace(/"/g, '""')}"`
        ].join(','))
      ].join('\n');

      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `relatorio_rids_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast('Relatório exportado com sucesso!', 'success');
    }

    function printReport() {
      if (reportFilteredRids.length === 0) {
        showToast('Gere um relatório antes de imprimir', 'error');
        return;
      }

      const printWindow = window.open('', '_blank');
      
      const statusColors = {
        'EM ABERTO': '#FEF3C7',
        'VENCIDO': '#FEE2E2',
        'CORRIGIDO': '#D1FAE5'
      };

      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Relatório de RIDs</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              padding: 20px;
              font-size: 12px;
            }
            h1 { 
              text-align: center; 
              color: #1e40af;
              margin-bottom: 10px;
            }
            .header-info {
              text-align: center;
              margin-bottom: 20px;
              color: #6b7280;
            }
            .stats {
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: 15px;
              margin-bottom: 20px;
            }
            .stat-card {
              border: 2px solid #e5e7eb;
              padding: 15px;
              border-radius: 8px;
              text-align: center;
            }
            .stat-value {
              font-size: 24px;
              font-weight: bold;
              color: #1f2937;
            }
            .stat-label {
              font-size: 12px;
              color: #6b7280;
              margin-top: 5px;
            }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin-top: 20px;
            }
            th, td { 
              border: 1px solid #ddd; 
              padding: 8px; 
              text-align: left; 
            }
            th { 
              background-color: #1e40af; 
              color: white;
              font-weight: bold;
            }
            tr:nth-child(even) { 
              background-color: #f9fafb; 
            }
            .status-badge {
              padding: 4px 8px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: bold;
            }
            @media print {
              body { padding: 10px; }
              .stats { page-break-inside: avoid; }
              table { page-break-inside: auto; }
              tr { page-break-inside: avoid; }
            }
          </style>
        </head>
        <body>
          <h1>Relatório de RIDs</h1>
          <div class="header-info">
            <p>Data de Geração: ${new Date().toLocaleString('pt-BR')}</p>
            <p>Gerado por: ${currentUserData.name}</p>
          </div>
          
          <div class="stats">
            <div class="stat-card">
              <div class="stat-value">${reportFilteredRids.length}</div>
              <div class="stat-label">Total de RIDs</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${reportFilteredRids.filter(r => r.status === 'EM ABERTO').length}</div>
              <div class="stat-label">Em Aberto</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${reportFilteredRids.filter(r => r.status === 'VENCIDO').length}</div>
              <div class="stat-label">Vencidos</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${reportFilteredRids.filter(r => r.status === 'CORRIGIDO').length}</div>
              <div class="stat-label">Corrigidos</div>
            </div>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Emitente</th>
                <th>Setor</th>
                <th>Data</th>
                <th>Status</th>
                <th>Risco</th>
                <th>Local</th>
              </tr>
            </thead>
            <tbody>
              ${reportFilteredRids.map(rid => `
                <tr>
                  <td>${rid.ridNumber}</td>
                  <td>${rid.emitterName}</td>
                  <td>${rid.sector}</td>
                  <td>${new Date(rid.issueDate).toLocaleDateString('pt-BR')}</td>
                  <td><span class="status-badge" style="background-color: ${statusColors[rid.status] || '#f3f4f6'}">${rid.status}</span></td>
                  <td>${rid.riskLevel || 'N/A'}</td>
                  <td>${rid.location}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
        </html>
      `;

      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      
      setTimeout(() => {
        printWindow.print();
      }, 250);

      showToast('Abrindo visualização de impressão...', 'success');
    }

    window.generateReport = generateReport;
    window.exportToCSV = exportToCSV;
    window.printReport = printReport;

    function toggleNotifications() {
      const menu = document.getElementById('notificationsMenu');
      menu.classList.toggle('hidden');
      
      if (!menu.classList.contains('hidden')) {
        loadNotifications();
        
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          badge.classList.add('hidden');
        }
      }
    }

    async function loadNotifications() {
      const notificationsList = document.getElementById('notificationsList');
      
      const myAssignedRids = allRids.filter(rid => 
        rid.assignedLeader === currentUserData.cpf && 
        rid.status === 'VENCIDO'
      );
      
      const notifications = myAssignedRids.map((rid, index) => ({
        id: index + 1,
        ridId: rid.id,
        type: 'rid_assigned',
        title: 'RID Designada',
        message: `Você foi designado para resolver a RID ${rid.ridNumber}`,
        time: rid.issueDate ? new Date(rid.issueDate).toLocaleDateString('pt-BR') : 'N/A',
        read: false
      }));
      
      if (notifications.length === 0) {
        notificationsList.innerHTML = `
          <div class="p-8 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <p class="text-sm">Nenhuma notificação</p>
          </div>
        `;
        
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          badge.classList.add('hidden');
        }
        
        return;
      }
      
      const badge = document.getElementById('notificationBadge');
      if (badge) {
        badge.classList.remove('hidden');
      }
      
      const typeIcons = {
        'rid_created': '<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        'rid_assigned': '<svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',
        'rid_completed': '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
      };
      
      notificationsList.innerHTML = notifications.map(notif => `
        <div class="p-4 hover:bg-gray-50 transition-colors cursor-pointer ${notif.read ? 'opacity-60' : ''}" onclick="markNotificationAsRead(${notif.id}, '${notif.ridId}')">
          <div class="flex gap-3">
            <div class="flex-shrink-0 mt-1">
              ${typeIcons[notif.type] || typeIcons['rid_created']}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2">
                <p class="text-sm font-semibold text-gray-800">${notif.title}</p>
              </div>
              <p class="text-xs text-gray-600 mt-1">${notif.message}</p>
              <p class="text-xs text-gray-400 mt-1">${notif.time}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    function markNotificationAsRead(notificationId, ridId) {
      console.log('Marcando notificação como lida:', notificationId);
      
      if (ridId) {
        viewRid(ridId);
        const notificationsMenu = document.getElementById('notificationsMenu');
        if (notificationsMenu) {
          notificationsMenu.classList.add('hidden');
        }
      }
      
      loadNotifications();
    }

    function markAllNotificationsAsRead() {
      console.log('Marcando todas as notificações como lidas');
      
      const badge = document.getElementById('notificationBadge');
      if (badge) {
        badge.classList.add('hidden');
      }
      
      loadNotifications();
      showToast('Notificações marcadas como lidas', 'success');
    }

    function clearAllNotifications() {
      console.log('Limpando todas as notificações');
      
      const notificationsList = document.getElementById('notificationsList');
      if (notificationsList) {
        notificationsList.innerHTML = `
          <div class="p-8 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <p class="text-sm">Nenhuma notificação</p>
          </div>
        `;
      }
      
      const badge = document.getElementById('notificationBadge');
      if (badge) {
        badge.classList.add('hidden');
      }
      
      showToast('Notificações limpas', 'success');
    }

    window.toggleNotifications = toggleNotifications;
    window.markNotificationAsRead = markNotificationAsRead;
    window.markAllNotificationsAsRead = markAllNotificationsAsRead;
    window.clearAllNotifications = clearAllNotifications;

    let currentDeleteRidId = null;

    function openDeleteRidModal(ridId, ridNumber) {
      currentDeleteRidId = ridId;
      document.getElementById('deleteRidNumber').textContent = ridNumber;
      document.getElementById('deleteRidReason').value = '';
      document.getElementById('deleteRidModal').classList.remove('hidden');
    }

    function closeDeleteRidModal() {
      currentDeleteRidId = null;
      document.getElementById('deleteRidModal').classList.add('hidden');
    }

    async function submitDeleteRidRequest() {
      const reason = document.getElementById('deleteRidReason').value.trim();
      
      if (!reason) {
        showToast('Por favor, informe o motivo da exclusão', 'error');
        return;
      }

      try {
        const rid = allRids.find(r => r.id === currentDeleteRidId);
        
        if (!rid) {
          showToast('RID não encontrada', 'error');
          return;
        }

        await addDoc(collection(db, 'deletion_requests'), {
          type: 'rid',
          targetId: currentDeleteRidId,
          targetNumber: rid.ridNumber,
          targetEmitter: rid.emitterName,
          targetSector: rid.sector,
          reason: reason,
          requestedBy: currentUserData.name,
          requestedByCpf: currentUserData.cpf,
          status: 'PENDENTE',
          createdAt: serverTimestamp()
        });

        showToast('Solicitação enviada com sucesso!', 'success');
        closeDeleteRidModal();
        
        console.log('🚨 SOLICITAÇÃO DE EXCLUSÃO DE RID');
        console.log('ID da RID:', currentDeleteRidId);
        console.log('Número da RID:', rid.ridNumber);
        console.log('Motivo:', reason);
        console.log('Solicitado por:', currentUserData.name);
        console.log('Data:', new Date().toLocaleString('pt-BR'));
      } catch (error) {
        console.error('Erro ao enviar solicitação:', error);
        showToast('Erro ao enviar solicitação', 'error');
      }
    }

    let currentConfirmDeleteRidId = null;

    function confirmDeleteRid(ridId, ridNumber) {
      currentConfirmDeleteRidId = ridId;
      document.getElementById('confirmDeleteRidNumber').textContent = ridNumber;
      document.getElementById('confirmDeleteRidModal').classList.remove('hidden');
    }

    function closeConfirmDeleteRidModal() {
      currentConfirmDeleteRidId = null;
      document.getElementById('confirmDeleteRidModal').classList.add('hidden');
    }

    async function executeDeleteRid() {
      if (!currentConfirmDeleteRidId) return;
      
      const executeBtn = document.getElementById('executeDeleteRidBtn');
      executeBtn.disabled = true;
      executeBtn.textContent = 'Excluindo...';

      try {
        const ridDoc = doc(db, 'rids', currentConfirmDeleteRidId);
        await deleteDoc(ridDoc);
        
        showToast('RID excluída com sucesso!', 'success');
        closeConfirmDeleteRidModal();
        
        await loadRids();
        
        console.log('✅ EXCLUSÃO DE RID REALIZADA PELO DESENVOLVEDOR');
        console.log('ID da RID:', currentConfirmDeleteRidId);
        console.log('Número:', document.getElementById('confirmDeleteRidNumber').textContent);
        console.log('Excluído por:', currentUserData.name);
        console.log('Data:', new Date().toLocaleString('pt-BR'));
      } catch (error) {
        console.error('Erro ao excluir RID:', error);
        showToast('Erro ao excluir RID. Veja o console (F12)', 'error');
        executeBtn.disabled = false;
        executeBtn.textContent = 'Confirmar Exclusão';
      }
    }

    window.openDeleteRidModal = openDeleteRidModal;
    window.closeDeleteRidModal = closeDeleteRidModal;
    window.submitDeleteRidRequest = submitDeleteRidRequest;
    window.confirmDeleteRid = confirmDeleteRid;
    window.closeConfirmDeleteRidModal = closeConfirmDeleteRidModal;
    window.executeDeleteRid = executeDeleteRid;
    window.closeRidDetailsModal = closeRidDetailsModal;
    window.saveRidDetails = saveRidDetails;
    window.openDesignateModalFromDetails = openDesignateModalFromDetails;

    const defaultConfig = {
      system_title: 'Sistema de Gerenciamento de RIDs',
      company_name: 'JDemito',
      primary_color: '#1e40af',
      secondary_color: '#3b82f6',
      background_color: '#f3f4f6',
      text_color: '#1f2937',
      success_color: '#10b981'
    };

    async function onConfigChange(config) {
      const title = config.system_title || defaultConfig.system_title;
      const company = config.company_name || defaultConfig.company_name;
      
      document.querySelectorAll('.system-title').forEach(el => {
        el.textContent = title;
      });
      
      document.querySelectorAll('.company-name').forEach(el => {
        el.textContent = company;
      });
    }

    if (window.elementSdk) {
      await window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['system_title', config.system_title || defaultConfig.system_title],
          ['company_name', config.company_name || defaultConfig.company_name]
        ])
      });
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .view {
      min-height: 100%;
    }
    
    input[type="text"],
    input[type="password"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      transition: all 0.3s ease;
    }
    
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
      border-color: #3b82f6;
    }

    .hover-zoom-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .hover-zoom-card:hover {
      transform: scale(1.05);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .hover-zoom-btn {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .hover-zoom-btn:hover {
      transform: scale(1.05);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-100">
  <div id="toast" class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform translate-x-96 transition-transform duration-300 z-50">
   <p id="toastMessage"></p>
  </div><!-- Modal de Detalhes da RID -->
  <div id="ridDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-8">
    <div class="bg-blue-600 text-white px-6 py-4 rounded-t-2xl flex justify-between items-center">
     <h3 class="text-xl font-bold">Detalhes da RID</h3><button onclick="closeRidDetailsModal()" class="text-white hover:text-gray-200">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div>
    <form id="ridDetailsForm" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Número da RID</label> <input type="text" id="detailRidNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Emitente</label> <input type="text" id="detailEmitter" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Contrato</label> <select id="detailContractType" class="w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="Funcionário">Funcionário</option> <option value="Terceiro Contratado">Terceiro Contratado</option> <option value="Terceiro Eventual">Terceiro Eventual</option> <option value="Visitante">Visitante</option> </select>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Unidade</label> <input type="text" id="detailUnit" class="w-full px-4 py-3 border border-gray-300 rounded-lg" oninput="this.value = this.value.toUpperCase()">
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Setor</label> <select id="detailSector" class="w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="ADM">ADM</option> <option value="M. MOVEL">M. MOVEL</option> <option value="M. FIXA">M. FIXA</option> <option value="M. ELÉTRICA">M. ELÉTRICA</option> <option value="PRODUÇÃO">PRODUÇÃO</option> <option value="MINA">MINA</option> </select>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Data</label> <input type="date" id="detailDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Incidente</label> <select id="detailIncidentType" class="w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="Condição de Risco">Condição de Risco</option> <option value="Desvio Comportamental">Desvio Comportamental</option> <option value="Dano Material">Dano Material</option> <option value="Quase acidente">Quase acidente</option> </select>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Origem da Detecção</label> <select id="detailDetectionOrigin" class="w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="CSL">CSL</option> <option value="Inspeção programada">Inspeção programada</option> <option value="Inspeção não programada">Inspeção não programada</option> <option value="Observação Comportamental">Observação Comportamental</option> <option value="Constatação espontânea">Constatação espontânea</option> <option value="Auditoria">Auditoria</option> </select>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Local da Ocorrência</label> <input type="text" id="detailLocation" class="w-full px-4 py-3 border border-gray-300 rounded-lg" oninput="this.value = this.value.toUpperCase()">
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Descrição</label> <textarea id="detailDescription" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg" oninput="this.value = this.value.toUpperCase()"></textarea>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nível de Risco</label> <select id="detailRiskLevel" class="w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="Baixo">Baixo</option> <option value="Médio">Médio</option> <option value="Alto">Alto</option> <option value="Crítico">Crítico</option> </select>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Ação Imediata</label> <textarea id="detailImmediateAction" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg" oninput="this.value = this.value.toUpperCase()"></textarea>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Status</label> <select id="detailStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="EM ABERTO">EM ABERTO</option> <option value="VENCIDO">VENCIDO</option> <option value="CORRIGIDO">CORRIGIDO</option> </select>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Líder Designado</label> <input type="text" id="detailAssignedLeader" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Prazo</label> <input type="date" id="detailDeadline" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
     </div>
     <div><label class="block text-sm font-semibold text-gray-700 mb-2">Data de Conclusão</label> <input type="date" id="detailCompletionDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
     </div>
     <div class="flex gap-3 pt-4"><button type="button" onclick="saveRidDetails()" id="saveRidDetailsBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Salvar Alterações </button> <button type="button" onclick="openDesignateModalFromDetails()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Designar </button> <button type="button" onclick="closeRidDetailsModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Fechar </button>
     </div>
    </form>
   </div>
  </div><!-- Modal de Exclusão de RID (Solicitação) -->
  <div id="deleteRidModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="bg-red-600 text-white px-6 py-4 rounded-t-2xl flex items-center gap-3">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
     </svg>
     <h3 class="text-xl font-bold">Solicitar Exclusão de RID</h3>
    </div>
    <div class="p-6 space-y-4">
     <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
      <div class="flex">
       <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
       </div>
       <div class="ml-3">
        <p class="text-sm text-yellow-700"><strong>Atenção:</strong> Esta ação solicitará ao desenvolvedor a exclusão permanente da RID.</p>
       </div>
      </div>
     </div>
     <div>
      <p class="text-gray-700 mb-2">Você está solicitando a exclusão da RID:</p>
      <p id="deleteRidNumber" class="text-lg font-bold text-gray-900"></p>
     </div>
     <div><label for="deleteRidReason" class="block text-sm font-semibold text-gray-700 mb-2">Motivo da Exclusão</label> <textarea id="deleteRidReason" rows="3" placeholder="Descreva o motivo da solicitação de exclusão..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required></textarea>
     </div>
     <div class="flex gap-3 pt-4"><button onclick="submitDeleteRidRequest()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Enviar Solicitação </button> <button type="button" onclick="closeDeleteRidModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cancelar </button>
     </div>
    </div>
   </div>
  </div><!-- Modal de Confirmação de Exclusão de RID (Desenvolvedor) -->
  <div id="confirmDeleteRidModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="bg-red-700 text-white px-6 py-4 rounded-t-2xl flex items-center gap-3">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
     </svg>
     <h3 class="text-xl font-bold">Confirmar Exclusão de RID</h3>
    </div>
    <div class="p-6 space-y-4">
     <div class="bg-red-50 border-l-4 border-red-500 p-4">
      <div class="flex">
       <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-red-500" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
       </div>
       <div class="ml-3">
        <p class="text-sm text-red-700"><strong>ATENÇÃO DESENVOLVEDOR:</strong> Esta ação excluirá permanentemente a RID do sistema. Esta ação não pode ser desfeita!</p>
       </div>
      </div>
     </div>
     <div>
      <p class="text-gray-700 mb-2">Você está prestes a excluir a RID:</p>
      <p id="confirmDeleteRidNumber" class="text-lg font-bold text-gray-900"></p>
     </div>
     <div class="flex gap-3 pt-4"><button onclick="executeDeleteRid()" id="executeDeleteRidBtn" class="flex-1 bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Confirmar Exclusão </button> <button type="button" onclick="closeConfirmDeleteRidModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cancelar </button>
     </div>
    </div>
   </div>
  </div><!-- Modal de Designação -->
  <div id="designateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="bg-purple-600 text-white px-6 py-4 rounded-t-2xl">
     <h3 class="text-xl font-bold">Designar RID</h3>
    </div>
    <form id="designateForm" onsubmit="handleDesignate(event)" class="p-6 space-y-4">
     <div><label for="designateLeader" class="block text-sm font-semibold text-gray-700 mb-2">Designar ao Líder</label> <select id="designateLeader" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required> <option value="">Selecione um administrador</option> </select>
     </div>
     <div><label for="designateObservation" class="block text-sm font-semibold text-gray-700 mb-2">Observação (Opcional)</label> <textarea id="designateObservation" rows="3" placeholder="Adicione observações sobre a designação..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
     </div>
     <div><label for="designateDeadline" class="block text-sm font-semibold text-gray-700 mb-2">Prazo para Conclusão</label> <input type="date" id="designateDeadline" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
     </div>
     <div class="flex gap-3 pt-4"><button type="submit" id="designateBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Designar </button> <button type="button" onclick="closeDesignateModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cancelar </button>
     </div>
    </form>
   </div>
  </div><!-- Modal de Exclusão de Funcionário (Solicitação) -->
  <div id="deleteEmployeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="bg-red-600 text-white px-6 py-4 rounded-t-2xl flex items-center gap-3">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
     </svg>
     <h3 class="text-xl font-bold">Solicitar Exclusão</h3>
    </div>
    <div class="p-6 space-y-4">
     <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
      <div class="flex">
       <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
       </div>
       <div class="ml-3">
        <p class="text-sm text-yellow-700"><strong>Atenção:</strong> Esta ação solicitará ao desenvolvedor a exclusão permanente do funcionário.</p>
       </div>
      </div>
     </div>
     <div>
      <p class="text-gray-700 mb-2">Você está solicitando a exclusão de:</p>
      <p id="deleteEmployeeName" class="text-lg font-bold text-gray-900"></p>
     </div>
     <div><label for="deleteReason" class="block text-sm font-semibold text-gray-700 mb-2">Motivo da Exclusão</label> <textarea id="deleteReason" rows="3" placeholder="Descreva o motivo da solicitação de exclusão..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required></textarea>
     </div>
     <div class="flex gap-3 pt-4"><button onclick="submitDeleteRequest()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Enviar Solicitação </button> <button type="button" onclick="closeDeleteEmployeeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cancelar </button>
     </div>
    </div>
   </div>
  </div><!-- Modal de Confirmação de Exclusão (Desenvolvedor) -->
  <div id="confirmDeleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="bg-red-700 text-white px-6 py-4 rounded-t-2xl flex items-center gap-3">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
     </svg>
     <h3 class="text-xl font-bold">Confirmar Exclusão</h3>
    </div>
    <div class="p-6 space-y-4">
     <div class="bg-red-50 border-l-4 border-red-500 p-4">
      <div class="flex">
       <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-red-500" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
       </div>
       <div class="ml-3">
        <p class="text-sm text-red-700"><strong>ATENÇÃO DESENVOLVEDOR:</strong> Esta ação excluirá permanentemente o funcionário do sistema. Esta ação não pode ser desfeita!</p>
       </div>
      </div>
     </div>
     <div>
      <p class="text-gray-700 mb-2">Você está prestes a excluir:</p>
      <p id="confirmDeleteEmployeeName" class="text-lg font-bold text-gray-900"></p>
     </div>
     <div class="flex gap-3 pt-4"><button onclick="executeDeleteEmployee()" id="executeDeleteBtn" class="flex-1 bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Confirmar Exclusão </button> <button type="button" onclick="closeConfirmDeleteModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cancelar </button>
     </div>
    </div>
   </div>
  </div><!-- Modal de Cadastro de Funcionário -->
  <div id="employeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="bg-blue-600 text-white px-6 py-4 rounded-t-2xl">
     <h3 class="text-xl font-bold">Cadastrar Funcionário</h3>
    </div>
    <form id="employeeForm" onsubmit="handleEmployeeRegister(event)" class="p-6 space-y-4">
     <div><label for="employeeName" class="block text-sm font-semibold text-gray-700 mb-2">Nome Completo</label> <input type="text" id="employeeName" placeholder="Digite o nome completo" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="this.value = this.value.toUpperCase()" required>
     </div>
     <div><label for="employeeCpf" class="block text-sm font-semibold text-gray-700 mb-2">CPF</label> <input type="text" id="employeeCpf" placeholder="000.000.000-00" maxlength="14" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="this.value = this.value.replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')" required>
     </div>
     <div><label for="employeeSector" class="block text-sm font-semibold text-gray-700 mb-2">Setor</label> <select id="employeeSector" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required> <option value="">Selecione o setor</option> <option value="ADM">ADM</option> <option value="M. MOVEL">M. MOVEL</option> <option value="M. FIXA">M. FIXA</option> <option value="M. ELÉTRICA">M. ELÉTRICA</option> <option value="PRODUÇÃO">PRODUÇÃO</option> <option value="MINA">MINA</option> </select>
     </div>
     <div><label for="employeeMatricula" class="block text-sm font-semibold text-gray-700 mb-2">Matrícula (Senha)</label> <input type="text" id="employeeMatricula" placeholder="Mínimo 6 dígitos" minlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
      <p class="text-xs text-gray-500 mt-1">Esta matrícula será usada como senha de acesso</p>
     </div>
     <div class="flex gap-3 pt-4"><button type="submit" id="employeeRegisterBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cadastrar </button> <button type="button" onclick="closeEmployeeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cancelar </button>
     </div>
    </form>
   </div>
  </div><!-- Login View -->
  <div id="login" class="view h-full flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <h1 class="system-title text-3xl font-bold text-gray-800 mb-2">Sistema de Gerenciamento de RIDs</h1>
    </div>
    <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-6">
     <div><label for="loginCpf" class="block text-sm font-semibold text-gray-700 mb-2">CPF</label> <input type="text" id="loginCpf" placeholder="000.000.000-00" maxlength="14" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required oninput="this.value = this.value.replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')">
     </div>
     <div><label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-2">Senha/Matrícula</label> <input type="password" id="loginPassword" placeholder="Digite sua senha" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
     </div><button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Entrar </button>
    </form>
    <div class="mt-6 text-center"><button onclick="showRegisterView()" class="text-blue-600 hover:text-blue-800 font-semibold hover-zoom-btn"> Não tem conta? Cadastre-se </button>
    </div>
   </div>
  </div><!-- Register View -->
  <div id="register" class="view hidden h-full flex items-center justify-center p-4 overflow-auto">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md my-8">
    <div class="text-center mb-8">
     <h1 class="text-3xl font-bold text-gray-800 mb-2">Cadastro de Usuário</h1>
    </div>
    <form id="registerForm" onsubmit="handleRegister(event)" class="space-y-4">
     <div><label for="registerName" class="block text-sm font-semibold text-gray-700 mb-2">Nome Completo</label> <input type="text" id="registerName" placeholder="Digite seu nome completo" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
     </div>
     <div><label for="registerCpf" class="block text-sm font-semibold text-gray-700 mb-2">CPF</label> <input type="text" id="registerCpf" placeholder="000.000.000-00" maxlength="14" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required oninput="this.value = this.value.replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')">
     </div>
     <div><label for="registerSector" class="block text-sm font-semibold text-gray-700 mb-2">Setor</label> <select id="registerSector" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required> <option value="">Selecione o setor</option> <option value="ADM">ADM</option> <option value="M. MOVEL">M. MOVEL</option> <option value="M. FIXA">M. FIXA</option> <option value="M. ELÉTRICA">M. ELÉTRICA</option> <option value="PRODUÇÃO">PRODUÇÃO</option> <option value="MINA">MINA</option> </select>
     </div>
     <div><label for="registerPassword" class="block text-sm font-semibold text-gray-700 mb-2">Senha/Matrícula</label> <input type="password" id="registerPassword" placeholder="Mínimo 6 caracteres" minlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
     </div><button type="submit" id="registerBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cadastrar </button>
    </form>
    <div class="mt-6 text-center"><button onclick="showLoginView()" class="text-blue-600 hover:text-blue-800 font-semibold hover-zoom-btn"> Já tem conta? Faça login </button>
    </div>
   </div>
  </div><!-- Dashboard View -->
  <div id="dashboard" class="view hidden h-full flex flex-col">
   <header class="bg-blue-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-4">
     <div class="flex justify-between items-start">
      <div>
       <h1 class="system-title text-2xl font-bold mb-2">Sistema de Gerenciamento de RIDs</h1>
       <div>
        <p id="userName" class="font-semibold text-lg"></p>
        <p id="userRole" class="text-sm opacity-90"></p>
       </div>
      </div>
      <div class="flex items-center gap-2">
       <div class="relative"><button onclick="toggleNotifications()" class="p-2 hover:bg-blue-700 rounded-lg transition-colors relative">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
         </svg><span id="notificationBadge" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span> </button>
        <div id="notificationsMenu" class="hidden absolute right-0 top-12 bg-white rounded-lg shadow-xl border border-gray-200 z-50 w-96">
         <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
          <h3 class="font-semibold text-gray-800">Notificações</h3>
          <div class="flex gap-2"><button onclick="markAllNotificationsAsRead()" class="text-xs text-blue-600 hover:text-blue-800 font-medium"> Marcar todas como lidas </button> <span class="text-gray-300">|</span> <button onclick="clearAllNotifications()" class="text-xs text-red-600 hover:text-red-800 font-medium"> Limpar </button>
          </div>
         </div>
         <div id="notificationsList" class="max-h-96 overflow-y-auto divide-y divide-gray-100">
          <div class="p-8 text-center text-gray-500">
           <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
           </svg>
           <p class="text-sm">Carregando notificações...</p>
          </div>
         </div>
        </div>
       </div>
       <div class="relative"><button onclick="toggleUserMenu()" class="p-2 hover:bg-blue-700 rounded-lg transition-colors">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
         </svg></button>
        <div id="userMenu" class="hidden absolute right-0 top-12 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-50 min-w-[150px]"><button onclick="handleLogout()" class="w-full px-4 py-2 text-left text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg> Sair </button>
        </div>
       </div>
      </div>
     </div>
    </div>
   </header>
   <nav class="bg-white shadow-md border-b border-gray-200 admin-only">
    <div class="container mx-auto px-4">
     <div class="flex gap-2"><button onclick="showMenuTab('dashboard')" data-tab="dashboard" class="menu-tab px-4 py-2 text-sm font-semibold text-blue-600 border-2 border-blue-600 bg-blue-50 rounded-full hover:bg-blue-100 transition-colors hover-zoom-btn"> Dashboard </button> <button onclick="showMenuTab('rids')" data-tab="rids" class="menu-tab px-4 py-2 text-sm font-semibold text-gray-600 border-2 border-transparent rounded-full hover:bg-gray-100 hover:text-blue-600 transition-colors hover-zoom-btn"> RID's </button> <button onclick="showMenuTab('funcionarios')" data-tab="funcionarios" class="menu-tab px-4 py-2 text-sm font-semibold text-gray-600 border-2 border-transparent rounded-full hover:bg-gray-100 hover:text-blue-600 transition-colors hover-zoom-btn"> Funcionários </button> <button onclick="showMenuTab('solicitacoes')" data-tab="solicitacoes" class="menu-tab px-4 py-2 text-sm font-semibold text-gray-600 border-2 border-transparent rounded-full hover:bg-gray-100 hover:text-blue-600 transition-colors hover-zoom-btn"> Solicitações </button> <button onclick="showMenuTab('relatorios')" data-tab="relatorios" class="menu-tab px-4 py-2 text-sm font-semibold text-gray-600 border-2 border-transparent rounded-full hover:bg-gray-100 hover:text-blue-600 transition-colors hover-zoom-btn"> Relatórios </button>
     </div>
    </div>
   </nav>
   <main class="flex-1 overflow-auto"><!-- Dashboard Content -->
    <div id="dashboardContent" class="content-section p-6">
     <div class="container mx-auto">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-3xl font-bold text-gray-800">RIDs</h2><button onclick="showNewRidView()" class="employee-only px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors shadow-md hover-zoom-btn flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg> Criar Nova RID </button>
      </div>
      <div class="mb-8 employee-only">
       <h3 class="text-xl font-bold text-gray-700 mb-4">Minhas RIDs</h3>
       <div id="myRidsList" class="space-y-4">
        <div class="text-center py-12 text-gray-500">
         Carregando...
        </div>
       </div>
      </div>
      <div class="mb-8 admin-section">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-700">Visão Geral</h3>
        <div class="relative"><button onclick="toggleOverviewFilters()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg></button>
         <div id="overviewFiltersPanel" class="hidden absolute right-0 top-12 bg-white rounded-lg shadow-xl border border-gray-200 p-4 z-10 w-80">
          <h4 class="font-semibold text-gray-800 mb-3">Filtros</h4>
          <div class="space-y-3">
           <div><label class="block text-sm font-medium text-gray-700 mb-1">Mês</label> <select id="overviewMonthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"> <option value="all">Todos os Meses</option> <option value="0">Janeiro</option> <option value="1">Fevereiro</option> <option value="2">Março</option> <option value="3">Abril</option> <option value="4">Maio</option> <option value="5">Junho</option> <option value="6">Julho</option> <option value="7">Agosto</option> <option value="8">Setembro</option> <option value="9">Outubro</option> <option value="10">Novembro</option> <option value="11">Dezembro</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-1">Ano</label> <input type="number" id="overviewYearFilter" placeholder="Ex: 2024" min="2000" max="2100" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
           </div>
           <div class="flex gap-2 pt-2"><button onclick="updateDashboardStats()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"> Aplicar Filtro </button> <button onclick="clearOverviewFilters()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors"> Limpar Filtro </button>
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-blue-500 hover-zoom-card cursor-pointer">
         <div class="flex items-center gap-4">
          <svg class="w-10 h-10 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p class="text-sm text-gray-600 font-medium flex-1">Total de RIDs</p>
          <p id="totalRids" class="text-3xl font-bold text-gray-800">0</p>
         </div>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-yellow-500 hover-zoom-card cursor-pointer">
         <div class="flex items-center gap-4">
          <svg class="w-10 h-10 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-sm text-gray-600 font-medium flex-1">Em Andamento</p>
          <p id="inProgressRids" class="text-3xl font-bold text-gray-800">0</p>
         </div>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-red-500 hover-zoom-card cursor-pointer">
         <div class="flex items-center gap-4">
          <svg class="w-10 h-10 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <p class="text-sm text-gray-600 font-medium flex-1">Vencidos</p>
          <p id="overdueRids" class="text-3xl font-bold text-gray-800">0</p>
         </div>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-green-500 hover-zoom-card cursor-pointer">
         <div class="flex items-center gap-4">
          <svg class="w-10 h-10 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-sm text-gray-600 font-medium flex-1">Corrigidos</p>
          <p id="completedRids" class="text-3xl font-bold text-gray-800">0</p>
         </div>
        </div>
       </div>
      </div>
      <div class="mb-8 admin-section">
       <h3 class="text-xl font-bold text-gray-700 mb-4">RIDs Recentes da Semana</h3>
       <div class="bg-white rounded-lg shadow-lg p-6">
        <div id="weeklyRidsList" class="space-y-3">
         <p class="text-gray-500 text-center py-8">Carregando...</p>
        </div>
       </div>
      </div>
      <div class="mb-8 admin-section">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-700">Ranking de Emissões</h3>
        <div class="relative"><button onclick="toggleRankingFilters()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg></button>
         <div id="rankingFiltersPanel" class="hidden absolute right-0 top-12 bg-white rounded-lg shadow-xl border border-gray-200 p-4 z-10 w-80">
          <h4 class="font-semibold text-gray-800 mb-3">Filtros</h4>
          <div class="space-y-3">
           <div><label class="block text-sm font-medium text-gray-700 mb-1">Mês</label> <select id="rankingMonthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"> <option value="all">Todos os Meses</option> <option value="0">Janeiro</option> <option value="1">Fevereiro</option> <option value="2">Março</option> <option value="3">Abril</option> <option value="4">Maio</option> <option value="5">Junho</option> <option value="6">Julho</option> <option value="7">Agosto</option> <option value="8">Setembro</option> <option value="9">Outubro</option> <option value="10">Novembro</option> <option value="11">Dezembro</option> </select>
           </div>
           <div><label class="block text-sm font-medium text-gray-700 mb-1">Ano</label> <input type="number" id="rankingYearFilter" placeholder="Ex: 2024" min="2000" max="2100" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
           </div>
           <div class="flex gap-2 pt-2"><button onclick="updateRanking()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"> Aplicar Filtro </button> <button onclick="clearRankingFilters()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors"> Limpar Filtro </button>
           </div>
          </div>
         </div>
        </div>
       </div>
       <div id="rankingList" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <p class="text-gray-500 text-center py-8 col-span-3">Carregando...</p>
       </div>
      </div>
     </div>
    </div><!-- RIDs Content -->
    <div id="ridsContent" class="content-section hidden p-6">
     <div class="container mx-auto">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-3xl font-bold text-gray-800">Todas as RIDs</h2>
       <div class="relative"><button onclick="toggleRidsFilters()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
         </svg> Filtros </button>
        <div id="ridsFiltersPanel" class="hidden absolute right-0 top-12 bg-white rounded-lg shadow-xl border border-gray-200 p-4 z-10 w-96">
         <h4 class="font-semibold text-gray-800 mb-3">Filtros</h4>
         <div class="space-y-3">
          <div><label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar (ID ou Nome)</label> <input type="text" id="ridsSearchFilter" placeholder="Digite para pesquisar..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-1">Status</label> <select id="ridsStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"> <option value="all">Todos os Status</option> <option value="EM ABERTO">EM ABERTO</option> <option value="VENCIDO">VENCIDO</option> <option value="CORRIGIDO">CORRIGIDO</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-1">Mês</label> <select id="ridsMonthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"> <option value="all">Todos os Meses</option> <option value="0">Janeiro</option> <option value="1">Fevereiro</option> <option value="2">Março</option> <option value="3">Abril</option> <option value="4">Maio</option> <option value="5">Junho</option> <option value="6">Julho</option> <option value="7">Agosto</option> <option value="8">Setembro</option> <option value="9">Outubro</option> <option value="10">Novembro</option> <option value="11">Dezembro</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-1">Ano</label> <input type="number" id="ridsYearFilter" placeholder="Ex: 2024" min="2000" max="2100" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="flex gap-2 pt-2"><button onclick="applyRidsFilters()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"> Aplicar Filtros </button> <button onclick="clearRidsFilters()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors"> Limpar Filtros </button>
          </div>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
       <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
        <div class="grid grid-cols-12 gap-4 text-xs font-semibold text-gray-600 uppercase">
         <div class="col-span-1">
          ID
         </div>
         <div class="col-span-2">
          Emitente
         </div>
         <div class="col-span-2">
          Setor
         </div>
         <div class="col-span-2">
          CPF
         </div>
         <div class="col-span-2">
          Data
         </div>
         <div class="col-span-2">
          Status
         </div>
         <div class="col-span-1 text-center">
          Ações
         </div>
        </div>
       </div>
       <div id="ridsListView" class="divide-y divide-gray-100">
        <p class="text-gray-500 text-center py-8">Carregando...</p>
       </div>
      </div>
     </div>
    </div><!-- Funcionários Content -->
    <div id="funcionariosContent" class="content-section hidden p-6">
     <div class="container mx-auto">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-3xl font-bold text-gray-800">Funcionários</h2><button onclick="openEmployeeModal()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors shadow-md hover-zoom-btn flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg> Cadastrar Funcionário </button>
      </div>
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
       <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
        <div class="grid grid-cols-12 gap-4 text-xs font-semibold text-gray-600 uppercase">
         <div class="col-span-3">
          Nome
         </div>
         <div class="col-span-2">
          Setor
         </div>
         <div class="col-span-2">
          CPF
         </div>
         <div class="col-span-2">
          Data de Cadastro
         </div>
         <div class="col-span-2">
          Tipo de Conta
         </div>
         <div class="col-span-1 text-center">
          Ações
         </div>
        </div>
       </div>
       <div id="employeesList" class="divide-y divide-gray-100">
        <p class="text-gray-500 text-center py-8">Carregando...</p>
       </div>
      </div>
     </div>
    </div><!-- Solicitações Content -->
    <div id="solicitacoesContent" class="content-section hidden p-6">
     <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Solicitações de Exclusão</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Card de Solicitações de RIDs -->
       <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
        <div class="bg-red-600 text-white px-6 py-4 flex items-center gap-3">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
         <h3 class="text-xl font-bold">Solicitações de Exclusão de RIDs</h3>
        </div>
        <div class="flex-1 overflow-y-auto max-h-[600px] divide-y divide-gray-100">
         <div id="ridRequestsList">
          <p class="text-gray-500 text-center py-8">Carregando...</p>
         </div>
        </div>
       </div><!-- Card de Solicitações de Funcion��rios -->
       <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
        <div class="bg-orange-600 text-white px-6 py-4 flex items-center gap-3">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
         </svg>
         <h3 class="text-xl font-bold">Solicitações de Exclusão de Funcionários</h3>
        </div>
        <div class="flex-1 overflow-y-auto max-h-[600px] divide-y divide-gray-100">
         <div id="employeeRequestsList">
          <p class="text-gray-500 text-center py-8">Carregando...</p>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Relatórios Content -->
    <div id="relatoriosContent" class="content-section hidden p-6">
     <div class="container mx-auto">
      <h2 class="text-3xl font-bold text-gray-800 mb-6">Relatórios</h2>
      <div class="bg-white rounded-lg shadow-lg p-8">
       <div class="text-center py-12">
        <svg class="w-24 h-24 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">Relatórios em Desenvolvimento</h3>
        <p class="text-gray-500">Esta funcionalidade estará disponível em breve</p>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div><!-- New RID View -->
  <div id="newRid" class="view hidden h-full overflow-auto">
   <div class="min-h-full bg-gray-100 py-8 px-4">
    <div class="container mx-auto max-w-4xl">
     <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
       <h2 class="text-2xl font-bold">Nova RID</h2><button onclick="showDashboardView()" class="text-white hover:text-gray-200 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg></button>
      </div>
      <form id="ridForm" onsubmit="handleCreateRid(event)" class="p-6 space-y-6">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label for="ridEmitter" class="block text-sm font-semibold text-gray-700 mb-2">Emitente</label> <input type="text" id="ridEmitter" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly required>
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Contrato</label>
         <div class="space-y-2"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="contractType" value="Funcionário" checked class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Funcionário</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="contractType" value="Terceiro Contratado" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Terceiro Contratado</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="contractType" value="Terceiro Eventual" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Terceiro Eventual</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="contractType" value="Visitante" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Visitante</span> </label>
         </div>
        </div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label for="ridUnit" class="block text-sm font-semibold text-gray-700 mb-2">Unidade</label> <input type="text" id="ridUnit" placeholder="Digite a unidade" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="this.value = this.value.toUpperCase()" required>
        </div>
        <div><label for="ridSector" class="block text-sm font-semibold text-gray-700 mb-2">Setor</label> <select id="ridSector" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required> <option value="">Selecione o setor</option> <option value="ADM">ADM</option> <option value="M. MOVEL">M. MOVEL</option> <option value="M. FIXA">M. FIXA</option> <option value="M. ELÉTRICA">M. ELÉTRICA</option> <option value="PRODUÇÃO">PRODUÇÃO</option> <option value="MINA">MINA</option> </select>
        </div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label for="ridDate" class="block text-sm font-semibold text-gray-700 mb-2">Data</label> <input type="date" id="ridDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Incidente</label>
         <div class="space-y-2"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="incidentType" value="Condição de Risco" checked class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Condição de Risco</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="incidentType" value="Desvio Comportamental" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Desvio Comportamental</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="incidentType" value="Dano Material" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Dano Material</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="incidentType" value="Quase acidente" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Quase acidente</span> </label>
         </div>
        </div>
       </div>
       <div><label for="ridDetectionOrigin" class="block text-sm font-semibold text-gray-700 mb-2">Origem da Detecção</label> <select id="ridDetectionOrigin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required> <option value="">Selecione a origem</option> <option value="CSL">CSL</option> <option value="Inspeção programada">Inspeção programada</option> <option value="Inspeção não programada">Inspeção não programada</option> <option value="Observação Comportamental">Observação Comportamental</option> <option value="Constatação espontânea">Constatação espontânea</option> <option value="Auditoria">Auditoria</option> </select>
       </div>
       <div><label for="ridLocation" class="block text-sm font-semibold text-gray-700 mb-2">Local da Ocorrência</label> <input type="text" id="ridLocation" placeholder="Digite o local" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="this.value = this.value.toUpperCase()" required>
       </div>
       <div><label for="ridDescription" class="block text-sm font-semibold text-gray-700 mb-2">Descrição</label> <textarea id="ridDescription" rows="4" placeholder="Descreva o ocorrido..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="this.value = this.value.toUpperCase()" required></textarea>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nível de Risco</label>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="riskLevel" value="Baixo" checked class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Baixo</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="riskLevel" value="Médio" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Médio</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="riskLevel" value="Alto" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Alto</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="riskLevel" value="Crítico" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">Crítico</span> </label>
        </div>
       </div>
       <div><label for="ridImmediateAction" class="block text-sm font-semibold text-gray-700 mb-2">Ação Imediata</label> <textarea id="ridImmediateAction" rows="3" placeholder="Descreva a ação imediata tomada..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="this.value = this.value.toUpperCase()" required></textarea>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Status Inicial</label>
        <div class="space-y-2"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="ridStatus" value="EM ABERTO" checked class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">EM ABERTO</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="ridStatus" value="VENCIDO" class="w-4 h-4 text-blue-600"> <span class="text-sm text-gray-700">VENCIDO</span> </label>
        </div>
       </div>
       <div><label for="ridLeader" class="block text-sm font-semibold text-gray-700 mb-2">Designar ao Líder (Opcional)</label> <select id="ridLeader" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"> <option value="">Selecione um líder</option> </select>
       </div>
       <div class="flex gap-4 pt-6"><button type="submit" id="createRidBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Criar RID </button> <button type="button" onclick="showDashboardView()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg transition-colors hover-zoom-btn"> Cancelar </button>
       </div>
      </form>
     </div>
    </div>
   </div>
  </div>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9acd35e052c2f200',t:'MTc2NTU0MjM5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>